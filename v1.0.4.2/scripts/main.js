// Generated by Construct, the game and animation creation tool
// Visit: https://www.construct.net

"use strict";window.DOMHandler=class{constructor(e,t){this._iRuntime=e,this._componentId=t,this._hasTickCallback=!1,this._tickCallback=()=>this.Tick()}Attach(){}PostToRuntime(e,t,i,s){this._iRuntime.PostToRuntimeComponent(this._componentId,e,t,i,s)}PostToRuntimeAsync(e,t,i,s){return this._iRuntime.PostToRuntimeComponentAsync(this._componentId,e,t,i,s)}_PostToRuntimeMaybeSync(e,t,i){this._iRuntime.UsesWorker()?this.PostToRuntime(e,t,i):this._iRuntime._GetLocalRuntime()._OnMessageFromDOM({type:"event",component:this._componentId,handler:e,dispatchOpts:i||null,data:t,responseId:null})}AddRuntimeMessageHandler(e,t){this._iRuntime.AddRuntimeComponentMessageHandler(this._componentId,e,t)}AddRuntimeMessageHandlers(e){for(const[t,i]of e)this.AddRuntimeMessageHandler(t,i)}GetRuntimeInterface(){return this._iRuntime}GetComponentID(){return this._componentId}_StartTicking(){this._hasTickCallback||(this._iRuntime._AddRAFCallback(this._tickCallback),this._hasTickCallback=!0)}_StopTicking(){this._hasTickCallback&&(this._iRuntime._RemoveRAFCallback(this._tickCallback),this._hasTickCallback=!1)}Tick(){}},window.RateLimiter=class{constructor(e,t){this._callback=e,this._interval=t,this._timerId=-1,this._lastCallTime=-1/0,this._timerCallFunc=()=>this._OnTimer(),this._ignoreReset=!1,this._canRunImmediate=!1}SetCanRunImmediate(e){this._canRunImmediate=!!e}Call(){if(-1!==this._timerId)return;const e=Date.now(),t=e-this._lastCallTime,i=this._interval;t>=i&&this._canRunImmediate?(this._lastCallTime=e,this._RunCallback()):this._timerId=self.setTimeout(this._timerCallFunc,Math.max(i-t,4))}_RunCallback(){this._ignoreReset=!0,this._callback(),this._ignoreReset=!1}Reset(){this._ignoreReset||(this._CancelTimer(),this._lastCallTime=Date.now())}_OnTimer(){this._timerId=-1,this._lastCallTime=Date.now(),this._RunCallback()}_CancelTimer(){-1!==this._timerId&&(self.clearTimeout(this._timerId),this._timerId=-1)}Release(){this._CancelTimer(),this._callback=null,this._timerCallFunc=null}};{class e{constructor(e){this._elem=e,this._hadFirstUpdate=!1,this._isVisibleFlag=!0,this._wantHtmlIndex=-1,this._actualHtmlIndex=-1,this._htmlZIndex=-1}SetVisibleFlag(e){this._isVisibleFlag=!!e}GetVisibleFlag(){return this._isVisibleFlag}HadFirstUpdate(){return this._hadFirstUpdate}SetHadFirstUpdate(){this._hadFirstUpdate=!0}GetWantHTMLIndex(){return this._wantHtmlIndex}SetWantHTMLIndex(e){this._wantHtmlIndex=e}GetActualHTMLIndex(){return this._actualHtmlIndex}SetActualHTMLIndex(e){this._actualHtmlIndex=e}SetHTMLZIndex(e){this._htmlZIndex=e}GetHTMLZIndex(){return this._htmlZIndex}GetElement(){return this._elem}}window.DOMElementHandler=class extends self.DOMHandler{constructor(e,t){super(e,t),this._elementMap=new Map,this._autoAttach=!0,this.AddRuntimeMessageHandlers([["create",e=>this._OnCreate(e)],["destroy",e=>this._OnDestroy(e)],["set-visible",e=>this._OnSetVisible(e)],["update-position",e=>this._OnUpdatePosition(e)],["update-state",e=>this._OnUpdateState(e)],["focus",e=>this._OnSetFocus(e)],["set-css-style",e=>this._OnSetCssStyle(e)],["set-attribute",e=>this._OnSetAttribute(e)],["remove-attribute",e=>this._OnRemoveAttribute(e)]]),this.AddDOMElementMessageHandler("get-element",e=>e)}SetAutoAttach(e){this._autoAttach=!!e}AddDOMElementMessageHandler(e,t){this.AddRuntimeMessageHandler(e,e=>{const i=e.elementId,s=this.GetElementById(i);return t(s,e)})}AddDOMElementMessageHandlers(e){for(const[t,i]of e)this.AddDOMElementMessageHandler(t,i)}_OnCreate(t){const i=t.elementId,s=this.CreateElement(i,t),n=new e(s);this._elementMap.set(i,n),s.style.boxSizing="border-box",s.style.display="none",n.SetVisibleFlag(t.isVisible);const o=this._GetFocusElement(s);o.addEventListener("focus",e=>this._OnFocus(i)),o.addEventListener("blur",e=>this._OnBlur(i));const a=t.htmlIndex;if(n.SetWantHTMLIndex(a),n.SetHTMLZIndex(t.htmlZIndex),this._autoAttach){const e=this.GetRuntimeInterface().GetAvailableHTMLIndex(a);n.SetActualHTMLIndex(e),this.GetRuntimeInterface().GetHTMLWrapElement(e).appendChild(s)}}CreateElement(e,t){throw new Error("required override")}DestroyElement(e){}_OnDestroy(e){const t=e.elementId,i=this.GetElementById(t);this.DestroyElement(i),this._autoAttach&&i.parentElement.removeChild(i),this._elementMap.delete(t)}PostToRuntimeElement(e,t,i){i||(i={}),i.elementId=t,this.PostToRuntime(e,i)}_PostToRuntimeElementMaybeSync(e,t,i){i||(i={}),i.elementId=t,this._PostToRuntimeMaybeSync(e,i)}_OnSetVisible(e){if(!this._autoAttach)return;const t=this._elementMap.get(e.elementId),i=t.GetElement();t.HadFirstUpdate()?i.style.display=e.isVisible?"":"none":t.SetVisibleFlag(e.isVisible)}_OnUpdatePosition(e){if(!this._autoAttach)return;const t=this._elementMap.get(e.elementId),i=t.GetElement(),s=this.GetRuntimeInterface();i.style.left=e.left+"px",i.style.top=e.top+"px",i.style.width=e.width+"px",i.style.height=e.height+"px";const n=e.fontSize;null!==n&&(i.style.fontSize=n+"em");const o=e.htmlIndex;t.SetWantHTMLIndex(o);const a=s.GetAvailableHTMLIndex(o);a!==t.GetActualHTMLIndex()&&(i.remove(),s.GetHTMLWrapElement(a).appendChild(i),t.SetActualHTMLIndex(a),s._UpdateHTMLElementsZOrder());const r=e.htmlZIndex;r!==t.GetHTMLZIndex()&&(t.SetHTMLZIndex(r),s._UpdateHTMLElementsZOrder()),t.HadFirstUpdate()||(t.SetHadFirstUpdate(),t.GetVisibleFlag()&&(i.style.display=""))}_OnHTMLLayersChanged(){if(this._autoAttach)for(const e of this._elementMap.values()){const t=this.GetRuntimeInterface().GetAvailableHTMLIndex(e.GetWantHTMLIndex()),i=e.GetActualHTMLIndex();if(-1!==t&&-1!==i&&t!==i){const i=e.GetElement();i.remove(),this.GetRuntimeInterface().GetHTMLWrapElement(t).appendChild(i),e.SetActualHTMLIndex(t)}}}_GetAllElementStatesForZOrderUpdate(){return this._autoAttach?[...this._elementMap.values()]:null}_OnUpdateState(e){const t=this.GetElementById(e.elementId);this.UpdateState(t,e)}UpdateState(e,t){throw new Error("required override")}_GetFocusElement(e){return e}_OnFocus(e){this.PostToRuntimeElement("elem-focused",e)}_OnBlur(e){this.PostToRuntimeElement("elem-blurred",e)}_OnSetFocus(e){const t=this._GetFocusElement(this.GetElementById(e.elementId));e.focus?t.focus():t.blur()}_OnSetCssStyle(e){const t=this.GetElementById(e.elementId),i=e.prop,s=e.val;i.startsWith("--")?t.style.setProperty(i,s):t.style[i]=s}_OnSetAttribute(e){this.GetElementById(e.elementId).setAttribute(e.name,e.val)}_OnRemoveAttribute(e){this.GetElementById(e.elementId).removeAttribute(e.name)}GetElementById(e){const t=this._elementMap.get(e);if(!t)throw new Error(`no element with id ${e}`);return t.GetElement()}}}{const t=/(iphone|ipod|ipad|macos|macintosh|mac os x)/i.test(navigator.userAgent),i=/android/i.test(navigator.userAgent),s=/safari/i.test(navigator.userAgent)&&!/(chrome|chromium|edg\/|OPR\/|nwjs)/i.test(navigator.userAgent);let n=0;function o(e){const t=document.createElement("script");return t.async=!1,t.type="module",e.isStringSrc?new Promise(i=>{const s="c3_resolve_"+n;++n,self[s]=i,t.textContent=e.str+`\n\nself["${s}"]();`,document.head.appendChild(t)}):new Promise((i,s)=>{t.onload=i,t.onerror=s,t.src=e,document.head.appendChild(t)})}async function a(){if(!navigator.userActivation||"undefined"==typeof OffscreenCanvas)return!1;try{let e=!1;const t=new Blob(['\n\tself.addEventListener("message", () =>\n\t{\n\t\ttry {\n\t\t\tconst offscreenCanvas = new OffscreenCanvas(32, 32);\n\t\t\tconst gl = offscreenCanvas.getContext("webgl");\n\t\t\tself.postMessage(!!gl);\n\t\t}\n\t\tcatch (err)\n\t\t{\n\t\t\tconsole.warn("Feature detection worker error:", err);\n\t\t\tself.postMessage(false);\n\t\t}\n\t});'],{type:"text/javascript"}),i=new Worker(URL.createObjectURL(t),{get type(){e=!0}}),s=await new Promise(e=>{i.addEventListener("message",t=>{i.terminate(),e(t.data)}),i.postMessage("")});return e&&s}catch(e){return console.warn("Error feature detecting worker mode: ",e),!1}}let r=new Audio;const d={"audio/webm; codecs=opus":!!r.canPlayType("audio/webm; codecs=opus"),"audio/ogg; codecs=opus":!!r.canPlayType("audio/ogg; codecs=opus"),"audio/webm; codecs=vorbis":!!r.canPlayType("audio/webm; codecs=vorbis"),"audio/ogg; codecs=vorbis":!!r.canPlayType("audio/ogg; codecs=vorbis"),"audio/mp4":!!r.canPlayType("audio/mp4"),"audio/mpeg":!!r.canPlayType("audio/mpeg")};async function l(e){const t=await h(e);return new TextDecoder("utf-8").decode(t)}function h(e){return new Promise((t,i)=>{const s=new FileReader;s.onload=e=>t(e.target.result),s.onerror=e=>i(e),s.readAsArrayBuffer(e)})}r=null;const c=[];let u=0;const _=8;window.RealFile=window.File;const m=[],p=new Map,g=new Map;let f=0;const y=[];self.runOnStartup=function(e){if("function"!=typeof e)throw new Error("runOnStartup called without a function");y.push(e)};const w=new Set(["cordova","playable-ad-single-file","playable-ad-zip","instant-games"]);function S(e){return w.has(e)}let v=!1;window.RuntimeInterface=class e{constructor(e){if(this._useWorker=e.useWorker,this._messageChannelPort=null,this._runtimeBaseUrl="",this._scriptFolder=e.scriptFolder,this._worker=null,this._localRuntime=null,this._domHandlers=[],this._runtimeDomHandler=null,this._isFirstSizeUpdate=!0,this._canvasLayers=[],this._pendingRemoveElements=[],this._pendingUpdateHTMLZOrder=!1,this._updateHTMLZOrderRAFCallback=()=>this._DoUpdateHTMLElementsZOrder(),this._isExportingToVideo=!1,this._exportToVideoDuration=0,this._jobScheduler=null,this._rafId=-1,this._rafFunc=()=>this._OnRAFCallback(),this._rafCallbacks=new Set,this._wrapperInitResolve=null,this._wrapperComponentIds=[],this._exportType=e.exportType,this._isFileProtocol="file"===location.protocol.substr(0,4),this._directoryHandles=[],"playable-ad-single-file"!==this._exportType&&"playable-ad-zip"!==this._exportType&&"instant-games"!==this._exportType||(this._useWorker=!1),s&&(this._useWorker=!1),"cordova"===this._exportType&&this._useWorker&&i){const e=/Chrome\/(\d+)/i.exec(navigator.userAgent);e&&parseInt(e[1],10)>=90||(this._useWorker=!1)}this.IsAnyWebView2Wrapper()?self.chrome.webview.addEventListener("message",e=>this._OnWrapperMessage(e.data,e.additionalObjects)):"macos-wkwebview"===this._exportType?self.C3WrapperOnMessage=e=>this._OnWrapperMessage(JSON.parse(e)):"linux-cef"===this._exportType&&self.c3_linux_cef_set_message_callback(e=>this._OnWrapperMessage(JSON.parse(e))),this._localFileBlobs=null,this._localFileStrings=null,"html5"!==this._exportType||window.isSecureContext||console.warn("[Construct] Warning: the browser indicates this is not a secure context. Some features may be unavailable. Use secure (HTTPS) hosting to ensure all features are available."),this.AddRuntimeComponentMessageHandler("canvas","update-size",e=>this._OnUpdateCanvasSize(e)),this.AddRuntimeComponentMessageHandler("canvas","set-html-layer-count",e=>this._OnSetHTMLLayerCount(e)),this.AddRuntimeComponentMessageHandler("canvas","cleanup-html-layers",()=>this._OnCleanUpHTMLLayers()),this.AddRuntimeComponentMessageHandler("canvas","update-html-layer-dom-state",e=>this._UpdateHTMLLayerDOMProperties(e.layersDomState)),this.AddRuntimeComponentMessageHandler("runtime","cordova-fetch-local-file",e=>this._OnCordovaFetchLocalFile(e)),this.AddRuntimeComponentMessageHandler("runtime","create-job-worker",e=>this._OnCreateJobWorker(e)),this.AddRuntimeComponentMessageHandler("runtime","send-wrapper-extension-message",e=>this._OnSendWrapperExtensionMessage(e)),"cordova"===this._exportType?document.addEventListener("deviceready",()=>this._Init(e)):this._Init(e),this._skipAndroidVirtualKeyboardDetection=0}Release(){this._CancelAnimationFrame(),this._messageChannelPort&&(this._messageChannelPort.onmessage=null,this._messageChannelPort=null),this._worker&&(this._worker.terminate(),this._worker=null),this._localRuntime&&(this._localRuntime.Release(),this._localRuntime=null);for(const{canvas:e,htmlWrap:t}of this._canvasLayers)e.remove(),t.remove();this._canvasLayers.length=0}GetMainCanvas(){return this._canvasLayers[0].canvas}GetAvailableHTMLIndex(e){return Math.min(e,this._canvasLayers.length-1)}GetHTMLWrapElement(e){if(e<0||e>=this._canvasLayers.length)throw new RangeError("invalid canvas layer");return this._canvasLayers[e].htmlWrap}_GetHTMLWrapElement(e){return this.GetHTMLWrapElement(e)}GetRuntimeBaseURL(){return this._runtimeBaseUrl}UsesWorker(){return this._useWorker}GetExportType(){return this._exportType}IsFileProtocol(){return this._isFileProtocol}GetScriptFolder(){return this._scriptFolder}IsiOSCordova(){return t&&"cordova"===this._exportType}IsiOSWebView(){const e=navigator.userAgent;return t&&S(this._exportType)||navigator.standalone||/crios\/|fxios\/|edgios\//i.test(e)}IsAndroid(){return i}IsAndroidWebView(){return i&&S(this._exportType)}IsWindowsWebView2(){return"windows-webview2"===this._exportType||!!("preview"===this._exportType&&window.chrome&&window.chrome.webview&&window.chrome.webview.postMessage)}IsAnyWebView2Wrapper(){return this.IsWindowsWebView2()||"xbox-uwp-webview2"===this._exportType}SkipNextAndroidVirtualKeyboardDetection(){this.IsAndroidWebView()&&this._skipAndroidVirtualKeyboardDetection++}CanDoAndroidVirtualKeyboardDetection(){return this._CanDoAndroidVirtualKeyboardDetection().next().value}*_CanDoAndroidVirtualKeyboardDetection(){if(!this.IsAndroidWebView())return!0;yield 0===this._skipAndroidVirtualKeyboardDetection,this._skipAndroidVirtualKeyboardDetection>0&&this._skipAndroidVirtualKeyboardDetection--}async _Init(e){if(this._useWorker&&(await a()||(this._useWorker=!1)),"macos-wkwebview"===this._exportType&&this._SendWrapperMessage({type:"ready"}),this.IsAnyWebView2Wrapper()||"macos-wkwebview"===this._exportType||"linux-cef"===this._exportType){this._SetupDesktopWrapperPolyfills();const e=await this._InitWrapper();this._wrapperComponentIds=e.registeredComponentIds}if("playable-ad-single-file"===this._exportType&&(this._localFileBlobs=self.c3_base64files,this._localFileStrings={},await this._ConvertDataUrisToBlobs()),"nwjs"===this._exportType&&self.nw&&(self.nw.Window.get().on("close",()=>self.nw.App.quit()),self.nw.App.manifest["c3-steam-mode"])){let e=0;this._AddRAFCallback(()=>{e++,document.documentElement.style.opacity=e%2==0?"1":"0.999"})}if(e.runtimeBaseUrl)this._runtimeBaseUrl=e.runtimeBaseUrl;else{const e=location.origin;this._runtimeBaseUrl=("null"===e?"file:///":e)+location.pathname;const t=this._runtimeBaseUrl.lastIndexOf("/");-1!==t&&(this._runtimeBaseUrl=this._runtimeBaseUrl.substr(0,t+1))}const t=new MessageChannel;if(this._messageChannelPort=t.port1,this._messageChannelPort.onmessage=e=>this._OnMessageFromRuntime(e.data),window.c3_addPortMessageHandler&&window.c3_addPortMessageHandler(e=>this._OnMessageFromDebugger(e)),this._jobScheduler=new self.JobSchedulerDOM(this),await this._jobScheduler.Init(),"object"==typeof window.StatusBar&&window.StatusBar.hide(),"object"==typeof window.AndroidFullScreen)try{await new Promise((e,t)=>{window.AndroidFullScreen.immersiveMode(e,t)})}catch(e){console.error("Failed to enter Android immersive mode: ",e)}this._useWorker?await this._InitWorker(e,t.port2):await this._InitDOM(e,t.port2)}_GetCommonRuntimeOptions(t){return{runtimeBaseUrl:this._runtimeBaseUrl,previewUrl:location.href,windowInnerWidth:this._GetWindowInnerWidth(),windowInnerHeight:this._GetWindowInnerHeight(),cssDisplayMode:this.GetCssDisplayMode(),devicePixelRatio:window.devicePixelRatio,isFullscreen:e.IsDocumentFullscreen(),swClientId:window.cr_swClientId||"",exportType:t.exportType,isNWjs:"undefined"!=typeof nw,fileMap:globalThis.c3_swFileMap??new Map(Object.entries(this._localFileBlobs??{})),scriptFolder:this._scriptFolder,isDebug:new URLSearchParams(self.location.search).has("debug"),ife:!!self.ife,jobScheduler:this._jobScheduler.GetPortData(),supportedAudioFormats:d,isFileProtocol:this._isFileProtocol,isiOSCordova:this.IsiOSCordova(),isiOSWebView:this.IsiOSWebView(),isWindowsWebView2:this.IsWindowsWebView2(),isAnyWebView2Wrapper:this.IsAnyWebView2Wrapper(),wrapperComponentIds:this._wrapperComponentIds,isFBInstantAvailable:void 0!==self.FBInstant}}async _InitWorker(e,t){const i=e.workerMainUrl;"preview"===this._exportType?(this._worker=new Worker("previewworker.js",{type:"module",name:"Runtime"}),await new Promise((e,t)=>{const s=i=>{this._worker.removeEventListener("message",s),i.data&&"ok"===i.data.type?e():t()};this._worker.addEventListener("message",s),this._worker.postMessage({type:"construct-worker-init",import:new URL(i,this._runtimeBaseUrl).toString()})})):this._worker=await this.CreateWorker(i,{type:"module",name:"Runtime"});const s=document.createElement("canvas");s.style.display="none";const n=s.transferControlToOffscreen();document.body.appendChild(s);const o=document.createElement("div");o.className="c3htmlwrap",o.setAttribute("interactive",""),document.body.appendChild(o),this._canvasLayers.push({canvas:s,htmlWrap:o,lastHtmlLayerDomState:{isVisible:!0,opacity:1,isInteractive:!0}}),window.c3canvas=s,self.C3_InsertHTMLPlaceholders&&self.C3_InsertHTMLPlaceholders(),this._worker.postMessage(Object.assign(this._GetCommonRuntimeOptions(e),{type:"init-runtime",isInWorker:!0,messagePort:t,canvas:n,runtimeScriptList:e.runtimeScriptList,projectMainScriptPath:e.projectMainScriptPath,javaScriptInEventsPath:e.javaScriptInEventsPath,typeScriptInEventsPath:e.typeScriptInEventsPath}),[t,n,...this._jobScheduler.GetPortTransferables()]),this._domHandlers=m.map(e=>new e(this)),this._FindRuntimeDOMHandler(),this._runtimeDomHandler._AddDefaultCanvasEventHandlers(s),this._runtimeDomHandler._AddDefaultHTMLWrapEventHandlers(o),this._runtimeDomHandler._EnableWindowResizeEvent(),self.c3_callFunction=(e,t)=>this._runtimeDomHandler._InvokeFunctionFromJS(e,t),"preview"===this._exportType&&(self.goToLastErrorScript=()=>this.PostToRuntimeComponent("runtime","go-to-last-error-script"))}async _InitDOM(e,t){const i=document.createElement("canvas");i.style.display="none",document.body.appendChild(i);const s=document.createElement("div");s.className="c3htmlwrap",s.setAttribute("interactive",""),document.body.appendChild(s),this._canvasLayers.push({canvas:i,htmlWrap:s,lastHtmlLayerDomState:{isVisible:!0,opacity:1,isInteractive:!0}}),window.c3canvas=i,self.C3_InsertHTMLPlaceholders&&self.C3_InsertHTMLPlaceholders(),this._domHandlers=m.map(e=>new e(this)),this._FindRuntimeDOMHandler(),this._runtimeDomHandler._AddDefaultCanvasEventHandlers(i),this._runtimeDomHandler._AddDefaultHTMLWrapEventHandlers(s);const n=await Promise.all(e.runtimeScriptList.map(e=>this._MaybeGetPlatformSpecificScriptURL(e)));await Promise.all(n.map(e=>o(e)));const a=e.projectMainScriptPath,r=e.javaScriptInEventsPath,d=e.typeScriptInEventsPath;if(a)try{if(await o(a),"preview"===this._exportType&&!globalThis.C3_ProjectMainScriptOK)throw new Error("main script did not run to completion")}catch(e){this._RemoveLoadingMessage(),console.error("Error loading project main script: ",e),alert(`Failed to load the project main script (${a}). Check all your JavaScript code has valid syntax, all imports are written correctly, and that an exception was not thrown running the script. Press F12 and check the console for error details.`)}if(r)try{if(await o(r),"preview"===this._exportType&&!globalThis.C3.JavaScriptInEvents)throw new Error("JavaScript in events did not run to completion")}catch(e){this._RemoveLoadingMessage(),console.error("Error loading JavaScript in events: ",e),alert("Failed to load JavaScript in events. Check all your JavaScript code has valid syntax, all imports are written correctly, and that an exception was not thrown running the 'Imports for events' script. Press F12 and check the console for error details.")}if(d)try{if(await o(d),"preview"===this._exportType&&!globalThis.C3.TypeScriptInEvents)throw new Error("TypeScript in events did not run to completion")}catch(e){this._RemoveLoadingMessage(),console.error("Error loading TypeScript in events: ",e),alert("Failed to load TypeScript in events. Check all your TypeScript code has valid syntax, all imports are written correctly, and that an exception was not thrown running the 'Imports for events' script. Press F12 and check the console for error details.")}const l=Object.assign(this._GetCommonRuntimeOptions(e),{isInWorker:!1,messagePort:t,canvas:i,runOnStartupFunctions:y});this._runtimeDomHandler._EnableWindowResizeEvent(),this._OnBeforeCreateRuntime(),this._localRuntime=self.C3_CreateRuntime(l),await self.C3_InitRuntime(this._localRuntime,l)}async CreateWorker(e,t){if(e.startsWith("blob:"))return new Worker(e,t);if("cordova"===this._exportType&&this._isFileProtocol){const i=await this.CordovaFetchLocalFileAsArrayBuffer(e),s=new Blob([i],{type:"application/javascript"});return new Worker(URL.createObjectURL(s),t)}if("playable-ad-single-file"===this._exportType){const i=this._localFileBlobs[e];if(!i)throw new Error("missing script: "+e);return new Worker(URL.createObjectURL(i),t)}const i=new URL(e,location.href);if(location.origin!==i.origin){const e=await fetch(i);if(!e.ok)throw new Error("failed to fetch worker script");const s=await e.blob();return new Worker(URL.createObjectURL(s),t)}return new Worker(i,t)}_GetWindowInnerWidth(){return Math.max(window.innerWidth,1)}_GetWindowInnerHeight(){return Math.max(window.innerHeight,1)}GetCssDisplayMode(){if(this.IsAnyWebView2Wrapper())return"standalone";const e=this.GetExportType();return new Set(["cordova","nwjs","macos-wkwebview","linux-cef"]).has(e)?"standalone":window.matchMedia("(display-mode: fullscreen)").matches?"fullscreen":window.matchMedia("(display-mode: standalone)").matches?"standalone":window.matchMedia("(display-mode: minimal-ui)").matches?"minimal-ui":navigator.standalone?"standalone":"browser"}_OnBeforeCreateRuntime(){this._RemoveLoadingMessage()}_RemoveLoadingMessage(){const e=window.cr_previewLoadingElem;e&&(e.parentElement.removeChild(e),window.cr_previewLoadingElem=null)}async _OnCreateJobWorker(e){const t=await this._jobScheduler._CreateJobWorker();return{outputPort:t,transferables:[t]}}_OnUpdateCanvasSize(e){if(this.IsExportingToVideo())return;const t=e.styleWidth+"px",i=e.styleHeight+"px",s=e.marginLeft+"px",n=e.marginTop+"px";for(const{canvas:e,htmlWrap:o}of this._canvasLayers)e.style.width=t,e.style.height=i,e.style.marginLeft=s,e.style.marginTop=n,o.style.width=t,o.style.height=i,o.style.marginLeft=s,o.style.marginTop=n,this._isFirstSizeUpdate&&(e.style.display="",o.style.display="");document.documentElement.style.setProperty("--construct-scale",e.displayScale),this._isFirstSizeUpdate=!1}_OnSetHTMLLayerCount(e){const t=e.count,i=e.layersDomState,s=e.immediate,n=e.styleWidth+"px",o=e.styleHeight+"px",a=e.marginLeft+"px",r=e.marginTop+"px",d=[],l=[];if(t<this._canvasLayers.length)for(;this._canvasLayers.length>t;){const{canvas:e,htmlWrap:t}=this._canvasLayers.pop();t.remove(),this._useWorker&&!s?this._pendingRemoveElements.push(e):e.remove()}else if(t>this._canvasLayers.length)for(let e=0,i=t-this._canvasLayers.length;e<i;++e){const e=document.createElement("canvas");if(e.classList.add("c3overlay"),this._useWorker){const t=e.transferControlToOffscreen();d.push(t),l.push(t)}else d.push(e);document.body.appendChild(e);const t=document.createElement("div");t.classList.add("c3htmlwrap","c3overlay"),t.setAttribute("interactive",""),document.body.appendChild(t),e.style.width=n,e.style.height=o,e.style.marginLeft=a,e.style.marginTop=r,t.style.width=n,t.style.height=o,t.style.marginLeft=a,t.style.marginTop=r,this._runtimeDomHandler._AddDefaultCanvasEventHandlers(e),this._runtimeDomHandler._AddDefaultHTMLWrapEventHandlers(t),this._canvasLayers.push({canvas:e,htmlWrap:t,lastHtmlLayerDomState:{isVisible:!0,opacity:1,isInteractive:!0}})}this._UpdateHTMLLayerDOMProperties(i);for(const e of this._domHandlers)e instanceof window.DOMElementHandler&&e._OnHTMLLayersChanged();return this._UpdateHTMLElementsZOrder(),{addedCanvases:d,transferables:l}}_UpdateHTMLLayerDOMProperties(e){for(let t=0,i=Math.min(this._canvasLayers.length,e.length);t<i;++t){const{htmlWrap:i,lastHtmlLayerDomState:s}=this._canvasLayers[t],n=e[t],o=n.isVisible,a=n.opacity,r=n.isInteractive;o!==s.isVisible&&(i.style.display=o?"":"none",s.isVisible=o),a!==s.opacity&&(i.style.opacity=1===a?"":String(a),s.opacity=a),r!==s.isInteractive&&(i.style.pointerEvents=r?"":"none",r?i.setAttribute("interactive",""):i.removeAttribute("interactive"),s.isInteractive=r)}}_OnCleanUpHTMLLayers(){for(const e of this._pendingRemoveElements)e.remove();this._pendingRemoveElements.length=0}_UpdateHTMLElementsZOrder(){this._pendingUpdateHTMLZOrder||(this._pendingUpdateHTMLZOrder=!0,this._AddRAFCallback(this._updateHTMLZOrderRAFCallback))}_DoUpdateHTMLElementsZOrder(){this._RemoveRAFCallback(this._updateHTMLZOrderRAFCallback),this._pendingUpdateHTMLZOrder=!1;let e=[];for(const t of this._domHandlers)if(t instanceof window.DOMElementHandler){const i=t._GetAllElementStatesForZOrderUpdate();i&&e.push(...i)}e.sort((e,t)=>{const i=e.GetActualHTMLIndex(),s=t.GetActualHTMLIndex();return i!==s?i-s:e.GetHTMLZIndex()-t.GetHTMLZIndex()});let t=0,i=0,s=0,n=e.length;for(;s<n;++s){const n=e[s];n.GetActualHTMLIndex()!==t&&(this._DoUpdateHTMLElementsZOrderOnHTMLLayer(t,e.slice(i,s)),t=n.GetActualHTMLIndex(),i=s)}i<s&&this._DoUpdateHTMLElementsZOrderOnHTMLLayer(t,e.slice(i,s))}_DoUpdateHTMLElementsZOrderOnHTMLLayer(e,t){if(t.length<=1)return;if(e>=this._canvasLayers.length)return;const i=t.map(e=>e.GetElement()),s=new Set(i),n=this.GetHTMLWrapElement(e),o=Array.from(n.children).filter(e=>s.has(e));for(let e=0,t=0,s=i.length;e<s;++e){const s=i[e],a=o[t];s===a?++t:n.moveBefore?n.moveBefore(s,a):n.insertBefore(s,a)}}_GetLocalRuntime(){if(this._useWorker)throw new Error("not available in worker mode");return this._localRuntime}PostToRuntimeComponent(e,t,i,s,n){this._messageChannelPort.postMessage({type:"event",component:e,handler:t,dispatchOpts:s||null,data:i,responseId:null},n)}PostToRuntimeComponentAsync(e,t,i,s,n){const o=f++,a=new Promise((e,t)=>{g.set(o,{resolve:e,reject:t})});return this._messageChannelPort.postMessage({type:"event",component:e,handler:t,dispatchOpts:s||null,data:i,responseId:o},n),a}_OnMessageFromRuntime(e){const t=e.type;if("event"===t)return this._OnEventFromRuntime(e);if("result"===t)this._OnResultFromRuntime(e);else if("runtime-ready"===t)this._OnRuntimeReady();else if("alert-error"===t)this._RemoveLoadingMessage(),alert(e.message);else{if("creating-runtime"!==t)throw new Error(`unknown message '${t}'`);this._OnBeforeCreateRuntime()}}_OnEventFromRuntime(e){const t=e.component,i=e.handler,s=e.data,n=e.responseId,o=p.get(t);if(!o)return void console.warn(`[DOM] No event handlers for component '${t}'`);const a=o.get(i);if(!a)return void console.warn(`[DOM] No handler '${i}' for component '${t}'`);let r=null;try{r=a(s)}catch(e){return console.error(`Exception in '${t}' handler '${i}':`,e),void(null!==n&&this._PostResultToRuntime(n,!1,""+e))}if(null===n)return r;r&&r.then?r.then(e=>this._PostResultToRuntime(n,!0,e)).catch(e=>{console.error(`Rejection from '${t}' handler '${i}':`,e),this._PostResultToRuntime(n,!1,""+e)}):this._PostResultToRuntime(n,!0,r)}_PostResultToRuntime(e,t,i){let s;i&&i.transferables&&(s=i.transferables),this._messageChannelPort.postMessage({type:"result",responseId:e,isOk:t,result:i},s)}_OnResultFromRuntime(e){const t=e.responseId,i=e.isOk,s=e.result,n=g.get(t);i?n.resolve(s):n.reject(s),g.delete(t)}AddRuntimeComponentMessageHandler(e,t,i){let s=p.get(e);if(s||(s=new Map,p.set(e,s)),s.has(t))throw new Error(`[DOM] Component '${e}' already has handler '${t}'`);s.set(t,i)}static AddDOMHandlerClass(e){if(m.includes(e))throw new Error("DOM handler already added");m.push(e)}_FindRuntimeDOMHandler(){for(const e of this._domHandlers)if("runtime"===e.GetComponentID())return void(this._runtimeDomHandler=e);throw new Error("cannot find runtime DOM handler")}_OnMessageFromDebugger(e){this.PostToRuntimeComponent("debugger","message",e)}_OnRuntimeReady(){for(const e of this._domHandlers)e.Attach()}static IsDocumentFullscreen(){return!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||v)}static _SetWrapperIsFullscreenFlag(e){v=!!e}async GetRemotePreviewStatusInfo(){return await this.PostToRuntimeComponentAsync("runtime","get-remote-preview-status-info")}_AddRAFCallback(e){this._rafCallbacks.add(e),this._RequestAnimationFrame()}_RemoveRAFCallback(e){this._rafCallbacks.delete(e),0===this._rafCallbacks.size&&this._CancelAnimationFrame()}_RequestAnimationFrame(){-1===this._rafId&&this._rafCallbacks.size>0&&(this._rafId=requestAnimationFrame(this._rafFunc))}_CancelAnimationFrame(){-1!==this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=-1)}_OnRAFCallback(){this._rafId=-1;for(const e of this._rafCallbacks)e();this._RequestAnimationFrame()}TryPlayMedia(e){this._runtimeDomHandler.TryPlayMedia(e)}RemovePendingPlay(e){this._runtimeDomHandler.RemovePendingPlay(e)}_PlayPendingMedia(){this._runtimeDomHandler._PlayPendingMedia()}SetSilent(e){this._runtimeDomHandler.SetSilent(e)}IsAudioFormatSupported(e){return!!d[e]}SetIsExportingToVideo(e){this._isExportingToVideo=!0,this._exportToVideoDuration=e}IsExportingToVideo(){return this._isExportingToVideo}GetExportToVideoDuration(){return this._exportToVideoDuration}IsAbsoluteURL(e){return/^(?:[a-z\-]+:)?\/\//.test(e)||"data:"===e.substr(0,5)||"blob:"===e.substr(0,5)}IsRelativeURL(e){return!this.IsAbsoluteURL(e)}async _MaybeGetPlatformSpecificScriptURL(e){if("cordova"===this._exportType&&(e.startsWith("file:")||this._isFileProtocol&&this.IsRelativeURL(e))){let t=e;t.startsWith(this._runtimeBaseUrl)&&(t=t.substr(this._runtimeBaseUrl.length));const i=await this.CordovaFetchLocalFileAsArrayBuffer(t),s=new Blob([i],{type:"application/javascript"});return URL.createObjectURL(s)}if("playable-ad-single-file"===this._exportType){if(this._localFileStrings.hasOwnProperty(e))return{isStringSrc:!0,str:this._localFileStrings[e]};if(this._localFileBlobs.hasOwnProperty(e))return URL.createObjectURL(this._localFileBlobs[e]);throw new Error("missing script: "+e)}return e}async _OnCordovaFetchLocalFile(e){const t=e.filename;switch(e.as){case"text":return await this.CordovaFetchLocalFileAsText(t);case"buffer":return await this.CordovaFetchLocalFileAsArrayBuffer(t);default:throw new Error("unsupported type")}}CordovaFetchLocalFile(e){const t=window.cordova.file.applicationDirectory+"www/"+e;return new Promise((e,i)=>{window.resolveLocalFileSystemURL(t,t=>{t.file(e,i)},i)})}async CordovaFetchLocalFileAsText(e){const t=await this.CordovaFetchLocalFile(e);return await l(t)}_CordovaMaybeStartNextArrayBufferRead(){if(!c.length)return;if(u>=_)return;u++;const e=c.shift();this._CordovaDoFetchLocalFileAsAsArrayBuffer(e.filename,e.successCallback,e.errorCallback)}CordovaFetchLocalFileAsArrayBuffer(e){return new Promise((t,i)=>{c.push({filename:e,successCallback:e=>{u--,this._CordovaMaybeStartNextArrayBufferRead(),t(e)},errorCallback:e=>{u--,this._CordovaMaybeStartNextArrayBufferRead(),i(e)}}),this._CordovaMaybeStartNextArrayBufferRead()})}async _CordovaDoFetchLocalFileAsAsArrayBuffer(e,t,i){try{const i=await this.CordovaFetchLocalFile(e);t(await h(i))}catch(e){i(e)}}_PlayableAdFetchBlob(e){if(this._localFileBlobs.hasOwnProperty(e))return this._localFileBlobs[e];throw new Error("missing file: "+e)}_GetPermissionAPI(){const e=window.cordova&&window.cordova.plugins&&window.cordova.plugins.permissions;if("object"!=typeof e)throw new Error("Permission API is not loaded");return e}_MapPermissionID(e,t){const i=e[t];if("string"!=typeof i)throw new Error("Invalid permission name");return i}_HasPermission(e){const t=this._GetPermissionAPI();return new Promise((i,s)=>t.checkPermission(this._MapPermissionID(t,e),e=>i(!!e.hasPermission),s))}_RequestPermission(e){const t=this._GetPermissionAPI();return new Promise((i,s)=>t.requestPermission(this._MapPermissionID(t,e),e=>i(!!e.hasPermission),s))}async RequestPermissions(e){if("cordova"!==this.GetExportType())return!0;if(this.IsiOSCordova())return!0;for(const t of e)if(!await this._HasPermission(t)&&!1===await this._RequestPermission(t))return!1;return!0}async RequirePermissions(...e){if(!1===await this.RequestPermissions(e))throw new Error("Permission not granted")}_OnWrapperMessage(t,i){if("object"!=typeof t||!t)return void console.warn("Unknown wrapper message: ",t);const s=t.type;if("directory-handles"===s)this._directoryHandles=i;else if("wrapper-init-response"===s)this._wrapperInitResolve(t),this._wrapperInitResolve=null;else if("fullscreen-change"===s)e._SetWrapperIsFullscreenFlag(t.isFullscreen),this._runtimeDomHandler._OnFullscreenChange();else if("log-to-console"===s)switch(t.logType){case"error":console.error(t.message);break;case"warning":console.warn(t.message);break;default:console.log(t.message)}else"extension-message"===s?this.PostToRuntimeComponent("runtime","wrapper-extension-message",t):console.warn("Unknown wrapper message: ",t)}_OnSendWrapperExtensionMessage(e){this._SendWrapperMessage({type:"extension-message",componentId:e.componentId,messageId:e.messageId,params:e.params||[],asyncId:e.asyncId})}_SendWrapperMessage(e){this.IsAnyWebView2Wrapper()?window.chrome.webview.postMessage(JSON.stringify(e)):"macos-wkwebview"===this._exportType?window.webkit.messageHandlers.C3Wrapper.postMessage(JSON.stringify(e)):"linux-cef"===this._exportType&&window.c3_linux_cef_sendmessage(JSON.stringify(e))}_SetupDesktopWrapperPolyfills(){window.moveTo=(e,t)=>{this._SendWrapperMessage({type:"set-window-position",windowX:Math.ceil(e),windowY:Math.ceil(t)})},window.resizeTo=(e,t)=>{this._SendWrapperMessage({type:"set-window-size",windowWidth:Math.ceil(e),windowHeight:Math.ceil(t)})}}_InitWrapper(){return new Promise(e=>{this._wrapperInitResolve=e,this._SendWrapperMessage({type:"wrapper-init"})})}_GetDirectoryHandles(){return this._directoryHandles}async _ConvertDataUrisToBlobs(){const e=[];for(const[t,i]of Object.entries(this._localFileBlobs))e.push(this._ConvertDataUriToBlobs(t,i));await Promise.all(e)}async _ConvertDataUriToBlobs(e,t){if("object"==typeof t)this._localFileBlobs[e]=new Blob([t.str],{type:t.type}),this._localFileStrings[e]=t.str;else{let i=await this._FetchDataUri(t);i||(i=this._DataURIToBinaryBlobSync(t)),this._localFileBlobs[e]=i}}async _FetchDataUri(e){try{const t=await fetch(e);return await t.blob()}catch(e){return console.warn("Failed to fetch a data: URI. Falling back to a slower workaround. This is probably because the Content Security Policy unnecessarily blocked it. Allow data: URIs in your CSP to avoid this.",e),null}}_DataURIToBinaryBlobSync(e){const t=this._ParseDataURI(e);return this._BinaryStringToBlob(t.data,t.mime_type)}_ParseDataURI(e){const t=e.indexOf(",");if(t<0)throw new URIError("expected comma in data: uri");const i=e.substring(5,t),s=e.substring(t+1),n=i.split(";"),o=n[0]||"",a=n[1],r=n[2];let d;return d="base64"===a||"base64"===r?atob(s):decodeURIComponent(s),{mime_type:o,data:d}}_BinaryStringToBlob(e,t){let i,s,n=e.length,o=n>>2,a=new Uint8Array(n),r=new Uint32Array(a.buffer,0,o);for(i=0,s=0;i<o;++i)r[i]=e.charCodeAt(s++)|e.charCodeAt(s++)<<8|e.charCodeAt(s++)<<16|e.charCodeAt(s++)<<24;let d=3&n;for(;d--;)a[s]=e.charCodeAt(s),++s;return new Blob([a],{type:t})}}}{const P=self.RuntimeInterface;function b(e){return e.sourceCapabilities&&e.sourceCapabilities.firesTouchEvents||e.originalEvent&&e.originalEvent.sourceCapabilities&&e.originalEvent.sourceCapabilities.firesTouchEvents}const C=new Map([["OSLeft","MetaLeft"],["OSRight","MetaRight"]]),I={dispatchRuntimeEvent:!0,dispatchUserScriptEvent:!0},R={dispatchUserScriptEvent:!0},O={dispatchRuntimeEvent:!0};async function T(e){const t=URL.createObjectURL(e);try{return await(i=t,new Promise((e,t)=>{const s=new Image;s.onload=()=>e(s),s.onerror=e=>t(e),s.src=i}))}finally{URL.revokeObjectURL(t)}var i}function A(e){do{if(e.parentNode&&e.hasAttribute("contenteditable"))return!0;e=e.parentNode}while(e);return!1}const G=new Set(["input","textarea","datalist","select"]),M=new Set(["canvas","body","html"]);function k(e){if(!e.target.tagName)return;const t=e.target.tagName.toLowerCase();M.has(t)&&e.preventDefault()}function H(e){e.target.tagName&&e.target.classList.contains("c3htmlwrap")&&e.preventDefault()}function N(e){(e.metaKey||e.ctrlKey)&&e.preventDefault()}self.C3_GetSvgImageSize=async function(e){const t=await T(e);if(t.width>0&&t.height>0)return[t.width,t.height];{t.style.position="absolute",t.style.left="0px",t.style.top="0px",t.style.visibility="hidden",document.body.appendChild(t);const e=t.getBoundingClientRect();return document.body.removeChild(t),[e.width,e.height]}},self.C3_RasterSvgImageBlob=async function(e,t,i,s,n){const o=await T(e),a=document.createElement("canvas");return a.width=s,a.height=n,a.getContext("2d").drawImage(o,0,0,t,i),a};let E=!1;function D(){try{return window.parent&&window.parent.document.hasFocus()}catch(e){return!1}}document.addEventListener("pause",()=>E=!0),document.addEventListener("resume",()=>E=!1);const L="runtime",x=class extends self.DOMHandler{constructor(e){super(e,L),this._enableWindowResizeEvent=!1,this._simulatedResizeTimerId=-1,this._targetOrientation="any",this._attachedDeviceOrientationEvent=!1,this._attachedDeviceMotionEvent=!1,this._pageVisibilityIsHidden=!1,this._screenReaderTextWrap=document.createElement("div"),this._screenReaderTextWrap.className="c3-screen-reader-text",this._screenReaderTextWrap.setAttribute("aria-live","polite"),document.body.appendChild(this._screenReaderTextWrap),this._debugHighlightElem=null,this._isExportToVideo=!1,this._exportVideoProgressMessage="",this._exportVideoUpdateTimerId=-1,this._enableAndroidVKDetection=!1,this._lastWindowWidth=e._GetWindowInnerWidth(),this._lastWindowHeight=e._GetWindowInnerHeight(),this._virtualKeyboardHeight=0,this._vkTranslateYOffset=0,e.AddRuntimeComponentMessageHandler("runtime","invoke-download",e=>this._OnInvokeDownload(e)),e.AddRuntimeComponentMessageHandler("runtime","load-webfonts",e=>this._OnLoadWebFonts(e)),e.AddRuntimeComponentMessageHandler("runtime","raster-svg-image",e=>this._OnRasterSvgImage(e)),e.AddRuntimeComponentMessageHandler("runtime","get-svg-image-size",e=>this._OnGetSvgImageSize(e)),e.AddRuntimeComponentMessageHandler("runtime","set-target-orientation",e=>this._OnSetTargetOrientation(e)),e.AddRuntimeComponentMessageHandler("runtime","register-sw",()=>this._OnRegisterSW()),e.AddRuntimeComponentMessageHandler("runtime","post-to-debugger",e=>this._OnPostToDebugger(e)),e.AddRuntimeComponentMessageHandler("runtime","go-to-script",e=>this._OnPostToDebugger(e)),e.AddRuntimeComponentMessageHandler("runtime","before-start-ticking",()=>this._OnBeforeStartTicking()),e.AddRuntimeComponentMessageHandler("runtime","debug-highlight",e=>this._OnDebugHighlight(e)),e.AddRuntimeComponentMessageHandler("runtime","enable-device-orientation",()=>this._AttachDeviceOrientationEvent()),e.AddRuntimeComponentMessageHandler("runtime","enable-device-motion",()=>this._AttachDeviceMotionEvent()),e.AddRuntimeComponentMessageHandler("runtime","add-stylesheet",e=>this._OnAddStylesheet(e)),e.AddRuntimeComponentMessageHandler("runtime","script-create-worker",e=>this._OnScriptCreateWorker(e)),e.AddRuntimeComponentMessageHandler("runtime","alert",e=>this._OnAlert(e)),e.AddRuntimeComponentMessageHandler("runtime","screen-reader-text",e=>this._OnScreenReaderTextEvent(e)),e.AddRuntimeComponentMessageHandler("runtime","hide-cordova-splash",()=>this._OnHideCordovaSplash()),e.AddRuntimeComponentMessageHandler("runtime","set-exporting-to-video",e=>this._SetExportingToVideo(e)),e.AddRuntimeComponentMessageHandler("runtime","export-to-video-progress",e=>this._OnExportVideoProgress(e)),e.AddRuntimeComponentMessageHandler("runtime","exported-to-video",e=>this._OnExportedToVideo(e)),e.AddRuntimeComponentMessageHandler("runtime","exported-to-image-sequence",e=>this._OnExportedToImageSequence(e));const t=new Set(["input","textarea","datalist"]);if(window.addEventListener("contextmenu",e=>{const i=e.target,s=i.tagName.toLowerCase();t.has(s)||A(i)||e.preventDefault()}),window.addEventListener("selectstart",k),window.addEventListener("gesturehold",k),window.addEventListener("touchstart",k,{passive:!1}),window.addEventListener("pointerdown",k,{passive:!1}),this._mousePointerLastButtons=0,window.addEventListener("mousedown",e=>{1===e.button&&e.preventDefault()}),window.addEventListener("mousewheel",N,{passive:!1}),window.addEventListener("wheel",N,{passive:!1}),window.addEventListener("resize",()=>this._OnWindowResize()),window.addEventListener("fullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("webkitfullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("mozfullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("fullscreenerror",e=>this._OnFullscreenError(e)),window.addEventListener("webkitfullscreenerror",e=>this._OnFullscreenError(e)),window.addEventListener("mozfullscreenerror",e=>this._OnFullscreenError(e)),e.IsiOSWebView()){let e=1/0;window.visualViewport.addEventListener("resize",()=>{const t=window.visualViewport.height;t>e&&(document.scrollingElement.scrollTop=0,document.scrollingElement.scrollLeft=0),e=t}),document.documentElement.setAttribute("ioswebview","")}this._mediaPendingPlay=new Set,this._mediaRemovedPendingPlay=new WeakSet,this._isSilent=!1}_AddDefaultCanvasEventHandlers(e){e.addEventListener("selectstart",k),e.addEventListener("gesturehold",k),e.addEventListener("pointerdown",k)}_AddDefaultHTMLWrapEventHandlers(e){e.addEventListener("selectstart",H),e.addEventListener("gesturehold",H),e.addEventListener("touchstart",H)}_OnBeforeStartTicking(){return self.setTimeout(()=>{this._enableAndroidVKDetection=!0},1e3),"cordova"===this._iRuntime.GetExportType()?(document.addEventListener("pause",()=>this._OnVisibilityChange(!0)),document.addEventListener("resume",()=>this._OnVisibilityChange(!1))):document.addEventListener("visibilitychange",()=>this._OnVisibilityChange("hidden"===document.visibilityState)),this._pageVisibilityIsHidden=!("hidden"!==document.visibilityState&&!E),{isSuspended:this._pageVisibilityIsHidden}}Attach(){window.addEventListener("focus",()=>this._PostRuntimeEvent("window-focus")),window.addEventListener("blur",()=>{this._PostRuntimeEvent("window-blur",{parentHasFocus:D()}),this._mousePointerLastButtons=0}),window.addEventListener("focusin",e=>{var t;t=e.target,(G.has(t.tagName.toLowerCase())||A(t))&&this._PostRuntimeEvent("keyboard-blur")}),window.addEventListener("keydown",e=>this._OnKeyEvent("keydown",e)),window.addEventListener("keyup",e=>this._OnKeyEvent("keyup",e)),window.addEventListener("mousedown",e=>this._OnMouseEvent("mousedown",e,R)),window.addEventListener("mousemove",e=>this._OnMouseEvent("mousemove",e,R)),window.addEventListener("mouseup",e=>this._OnMouseEvent("mouseup",e,R)),window.addEventListener("dblclick",e=>this._OnMouseEvent("dblclick",e,I)),window.addEventListener("wheel",e=>this._OnMouseWheelEvent("wheel",e,I)),window.addEventListener("pointerdown",e=>{this._HandlePointerDownFocus(e),this._OnPointerEvent("pointerdown",e)}),this._iRuntime.UsesWorker()&&void 0!==window.onpointerrawupdate&&self===self.top?window.addEventListener("pointerrawupdate",e=>this._OnPointerRawUpdate(e)):window.addEventListener("pointermove",e=>this._OnPointerEvent("pointermove",e)),window.addEventListener("pointerup",e=>this._OnPointerEvent("pointerup",e)),window.addEventListener("pointercancel",e=>this._OnPointerEvent("pointercancel",e));const e=()=>this._PlayPendingMedia();window.addEventListener("pointerup",e,!0),window.addEventListener("touchend",e,!0),window.addEventListener("click",e,!0),window.addEventListener("keydown",e,!0),window.addEventListener("gamepadconnected",e,!0),this._iRuntime.IsAndroid()&&!this._iRuntime.IsAndroidWebView()&&navigator.virtualKeyboard&&(navigator.virtualKeyboard.overlaysContent=!0,navigator.virtualKeyboard.addEventListener("geometrychange",()=>{this._OnAndroidVirtualKeyboardChange(this._GetWindowInnerHeight(),navigator.virtualKeyboard.boundingRect.height)})),this._iRuntime.IsiOSWebView()&&(document.scrollingElement.scrollTop=0,document.scrollingElement.scrollLeft=0)}_OnAndroidVirtualKeyboardChange(e,t){if(document.body.style.position="",document.body.style.overflow="",document.body.style.transform="",this._vkTranslateYOffset=0,t>0){const i=document.activeElement;if(i){const s=i.getBoundingClientRect();let n=(s.top+s.bottom)/2-(e-t)/2;n>t&&(n=t),n<0&&(n=0),n>0&&(document.body.style.position="absolute",document.body.style.overflow="visible",document.body.style.transform=`translateY(${-n}px)`,this._vkTranslateYOffset=n)}}}_PostRuntimeEvent(e,t){this.PostToRuntime(e,t||null,O)}_GetWindowInnerWidth(){return this._iRuntime._GetWindowInnerWidth()}_GetWindowInnerHeight(){return this._iRuntime._GetWindowInnerHeight()}_EnableWindowResizeEvent(){this._enableWindowResizeEvent=!0,this._lastWindowWidth=this._iRuntime._GetWindowInnerWidth(),this._lastWindowHeight=this._iRuntime._GetWindowInnerHeight()}_OnWindowResize(){if(this._isExportToVideo)return;if(!this._enableWindowResizeEvent)return;const e=this._GetWindowInnerWidth(),t=this._GetWindowInnerHeight();if(this._iRuntime.IsAndroidWebView())if(this._enableAndroidVKDetection){if(this._iRuntime.CanDoAndroidVirtualKeyboardDetection()&&this._lastWindowWidth===e&&t<this._lastWindowHeight)return this._virtualKeyboardHeight=this._lastWindowHeight-t,void this._OnAndroidVirtualKeyboardChange(this._lastWindowHeight,this._virtualKeyboardHeight);this._virtualKeyboardHeight>0&&(this._virtualKeyboardHeight=0,this._OnAndroidVirtualKeyboardChange(t,this._virtualKeyboardHeight)),this._lastWindowWidth=e,this._lastWindowHeight=t}else this._lastWindowWidth=e,this._lastWindowHeight=t;this.PostToRuntime("window-resize",{innerWidth:e,innerHeight:t,devicePixelRatio:window.devicePixelRatio,isFullscreen:P.IsDocumentFullscreen(),cssDisplayMode:this._iRuntime.GetCssDisplayMode()}),this._iRuntime.IsiOSWebView()&&(-1!==this._simulatedResizeTimerId&&clearTimeout(this._simulatedResizeTimerId),this._OnSimulatedResize(e,t,0))}_ScheduleSimulatedResize(e,t,i){-1!==this._simulatedResizeTimerId&&clearTimeout(this._simulatedResizeTimerId),this._simulatedResizeTimerId=setTimeout(()=>this._OnSimulatedResize(e,t,i),48)}_OnSimulatedResize(e,t,i){const s=this._GetWindowInnerWidth(),n=this._GetWindowInnerHeight();this._simulatedResizeTimerId=-1,s!=e||n!=t?this.PostToRuntime("window-resize",{innerWidth:s,innerHeight:n,devicePixelRatio:window.devicePixelRatio,isFullscreen:P.IsDocumentFullscreen(),cssDisplayMode:this._iRuntime.GetCssDisplayMode()}):i<10&&this._ScheduleSimulatedResize(s,n,i+1)}_OnSetTargetOrientation(e){this._targetOrientation=e.targetOrientation}_TrySetTargetOrientation(){const e=this._targetOrientation;if(screen.orientation&&screen.orientation.lock)screen.orientation.lock(e).catch(e=>console.warn("[Construct] Failed to lock orientation: ",e));else try{let t=!1;screen.lockOrientation?t=screen.lockOrientation(e):screen.webkitLockOrientation?t=screen.webkitLockOrientation(e):screen.mozLockOrientation?t=screen.mozLockOrientation(e):screen.msLockOrientation&&(t=screen.msLockOrientation(e)),t||console.warn("[Construct] Failed to lock orientation")}catch(e){console.warn("[Construct] Failed to lock orientation: ",e)}}_OnFullscreenChange(){if(this._isExportToVideo)return;const e=P.IsDocumentFullscreen();e&&"any"!==this._targetOrientation&&this._TrySetTargetOrientation(),this.PostToRuntime("fullscreenchange",{isFullscreen:e,innerWidth:this._GetWindowInnerWidth(),innerHeight:this._GetWindowInnerHeight()})}_OnFullscreenError(e){console.warn("[Construct] Fullscreen request failed: ",e),this.PostToRuntime("fullscreenerror",{isFullscreen:P.IsDocumentFullscreen(),innerWidth:this._GetWindowInnerWidth(),innerHeight:this._GetWindowInnerHeight()})}_OnVisibilityChange(e){if(this._pageVisibilityIsHidden!==e&&(this._pageVisibilityIsHidden=e,e?this._iRuntime._CancelAnimationFrame():this._iRuntime._RequestAnimationFrame(),this.PostToRuntime("visibilitychange",{hidden:e}),!e&&this._iRuntime.IsiOSWebView())){const e=()=>{document.scrollingElement.scrollTop=0,document.scrollingElement.scrollLeft=0};setTimeout(e,50),setTimeout(e,100),setTimeout(e,250),setTimeout(e,500)}}_OnKeyEvent(e,t){if(void 0===t.key)return;if("Backspace"===t.key&&k(t),"nwjs"===this._iRuntime.GetExportType()&&"u"===t.key&&(t.ctrlKey||t.metaKey)&&t.preventDefault(),this._isExportToVideo)return;const i=C.get(t.code)||t.code;this._PostToRuntimeMaybeSync(e,{code:i,key:t.key,which:t.which,repeat:t.repeat,altKey:t.altKey,ctrlKey:t.ctrlKey,metaKey:t.metaKey,shiftKey:t.shiftKey,timeStamp:t.timeStamp},I)}_OnMouseWheelEvent(e,t,i){this._isExportToVideo||this.PostToRuntime(e,{clientX:t.clientX,clientY:t.clientY+this._vkTranslateYOffset,pageX:t.pageX,pageY:t.pageY+this._vkTranslateYOffset,deltaX:t.deltaX,deltaY:t.deltaY,deltaZ:t.deltaZ,deltaMode:t.deltaMode,timeStamp:t.timeStamp},i)}_OnMouseEvent(e,t,i){this._isExportToVideo||b(t)||this._PostToRuntimeMaybeSync(e,{button:t.button,buttons:t.buttons,clientX:t.clientX,clientY:t.clientY+this._vkTranslateYOffset,pageX:t.pageX,pageY:t.pageY+this._vkTranslateYOffset,movementX:t.movementX||0,movementY:t.movementY||0,timeStamp:t.timeStamp},i)}_OnPointerEvent(e,t){if(this._isExportToVideo)return;let i=0;"mouse"===t.pointerType&&(i=this._mousePointerLastButtons),this._PostToRuntimeMaybeSync(e,{pointerId:t.pointerId,pointerType:t.pointerType,button:t.button,buttons:t.buttons,lastButtons:i,clientX:t.clientX,clientY:t.clientY+this._vkTranslateYOffset,pageX:t.pageX,pageY:t.pageY+this._vkTranslateYOffset,movementX:t.movementX||0,movementY:t.movementY||0,width:t.width||0,height:t.height||0,pressure:t.pressure||0,tangentialPressure:t.tangentialPressure||0,tiltX:t.tiltX||0,tiltY:t.tiltY||0,twist:t.twist||0,timeStamp:t.timeStamp},I),"mouse"===t.pointerType&&(this._mousePointerLastButtons=t.buttons)}_OnPointerRawUpdate(e){this._OnPointerEvent("pointermove",e)}_OnTouchEvent(e,t){if(!this._isExportToVideo)for(let i=0,s=t.changedTouches.length;i<s;++i){const s=t.changedTouches[i];this._PostToRuntimeMaybeSync(e,{pointerId:s.identifier,pointerType:"touch",button:0,buttons:0,lastButtons:0,clientX:s.clientX,clientY:s.clientY+this._vkTranslateYOffset,pageX:s.pageX,pageY:s.pageY+this._vkTranslateYOffset,movementX:t.movementX||0,movementY:t.movementY||0,width:2*(s.radiusX||s.webkitRadiusX||0),height:2*(s.radiusY||s.webkitRadiusY||0),pressure:s.force||s.webkitForce||0,tangentialPressure:0,tiltX:0,tiltY:0,twist:s.rotationAngle||0,timeStamp:t.timeStamp},I)}}_HandlePointerDownFocus(e){window!==window.top&&window.focus(),this._IsElementCanvasOrDocument(e.target)&&document.activeElement&&!this._IsElementCanvasOrDocument(document.activeElement)&&document.activeElement.blur()}_IsElementCanvasOrDocument(e){return!e||e===document||e===window||e===document.body||"canvas"===e.tagName.toLowerCase()}_AttachDeviceOrientationEvent(){this._attachedDeviceOrientationEvent||(this._attachedDeviceOrientationEvent=!0,window.addEventListener("deviceorientation",e=>this._OnDeviceOrientation(e)),window.addEventListener("deviceorientationabsolute",e=>this._OnDeviceOrientationAbsolute(e)))}_AttachDeviceMotionEvent(){this._attachedDeviceMotionEvent||(this._attachedDeviceMotionEvent=!0,window.addEventListener("devicemotion",e=>this._OnDeviceMotion(e)))}_OnDeviceOrientation(e){this._isExportToVideo||this.PostToRuntime("deviceorientation",{absolute:!!e.absolute,alpha:e.alpha||0,beta:e.beta||0,gamma:e.gamma||0,timeStamp:e.timeStamp,webkitCompassHeading:e.webkitCompassHeading,webkitCompassAccuracy:e.webkitCompassAccuracy},I)}_OnDeviceOrientationAbsolute(e){this._isExportToVideo||this.PostToRuntime("deviceorientationabsolute",{absolute:!!e.absolute,alpha:e.alpha||0,beta:e.beta||0,gamma:e.gamma||0,timeStamp:e.timeStamp},I)}_OnDeviceMotion(e){if(this._isExportToVideo)return;let t=null;const i=e.acceleration;i&&(t={x:i.x||0,y:i.y||0,z:i.z||0});let s=null;const n=e.accelerationIncludingGravity;n&&(s={x:n.x||0,y:n.y||0,z:n.z||0});let o=null;const a=e.rotationRate;a&&(o={alpha:a.alpha||0,beta:a.beta||0,gamma:a.gamma||0}),this.PostToRuntime("devicemotion",{acceleration:t,accelerationIncludingGravity:s,rotationRate:o,interval:e.interval,timeStamp:e.timeStamp},I)}_OnInvokeDownload(e){const t=e.url,i=e.filename,s=document.createElement("a"),n=document.body;s.textContent=i,s.href=t,s.download=i,n.appendChild(s),s.click(),n.removeChild(s)}async _OnLoadWebFonts(e){const t=e.webfonts;await Promise.all(t.map(async e=>{const t=new FontFace(e.name,`url('${e.url}')`);document.fonts.add(t),await t.load()}))}async _OnRasterSvgImage(e){const t=e.blob,i=e.imageWidth,s=e.imageHeight,n=e.surfaceWidth,o=e.surfaceHeight,a=e.imageBitmapOpts,r=await self.C3_RasterSvgImageBlob(t,i,s,n,o);let d;return d=a?await createImageBitmap(r,a):await createImageBitmap(r),{imageBitmap:d,transferables:[d]}}async _OnGetSvgImageSize(e){return await self.C3_GetSvgImageSize(e.blob)}async _OnAddStylesheet(e){var t;await(t=e.url,new Promise((e,i)=>{const s=document.createElement("link");s.onload=()=>e(s),s.onerror=e=>i(e),s.rel="stylesheet",s.href=t,document.head.appendChild(s)}))}_PlayPendingMedia(){const e=[...this._mediaPendingPlay];if(this._mediaPendingPlay.clear(),!this._isSilent)for(const t of e){const e=t.play();e&&e.catch(e=>{this._mediaRemovedPendingPlay.has(t)||this._mediaPendingPlay.add(t)})}}TryPlayMedia(e){if("function"!=typeof e.play)throw new Error("missing play function");let t;this._mediaRemovedPendingPlay.delete(e);try{t=e.play()}catch(t){return void this._mediaPendingPlay.add(e)}t&&t.catch(t=>{this._mediaRemovedPendingPlay.has(e)||this._mediaPendingPlay.add(e)})}RemovePendingPlay(e){this._mediaPendingPlay.delete(e),this._mediaRemovedPendingPlay.add(e)}SetSilent(e){this._isSilent=!!e}_OnHideCordovaSplash(){navigator.splashscreen&&navigator.splashscreen.hide&&navigator.splashscreen.hide()}_OnDebugHighlight(e){if(!e.show)return void(this._debugHighlightElem&&(this._debugHighlightElem.style.display="none"));this._debugHighlightElem||(this._debugHighlightElem=document.createElement("div"),this._debugHighlightElem.id="inspectOutline",document.body.appendChild(this._debugHighlightElem));const t=this._debugHighlightElem;t.style.display="",t.style.left=e.left-1+"px",t.style.top=e.top-1+"px",t.style.width=e.width+2+"px",t.style.height=e.height+2+"px",t.textContent=e.name}_OnRegisterSW(){window.C3_RegisterSW&&window.C3_RegisterSW()}_OnPostToDebugger(e){window.c3_postToMessagePort&&(e.from="runtime",window.c3_postToMessagePort(e))}_InvokeFunctionFromJS(e,t){return this.PostToRuntimeAsync("js-invoke-function",{name:e,params:t})}_OnScriptCreateWorker(e){const t=e.url,i=e.opts,s=e.port2;new Worker(t,i).postMessage({type:"construct-worker-init",port2:s},[s])}_OnAlert(e){alert(e.message)}_OnScreenReaderTextEvent(e){const t=e.type;if("create"===t){const t=document.createElement("p");t.id="c3-sr-"+e.id,t.textContent=e.text,this._screenReaderTextWrap.appendChild(t)}else if("update"===t){const t=document.getElementById("c3-sr-"+e.id);t?t.textContent=e.text:console.warn(`[Construct] Missing screen reader text with id ${e.id}`)}else if("release"===t){const t=document.getElementById("c3-sr-"+e.id);t?t.remove():console.warn(`[Construct] Missing screen reader text with id ${e.id}`)}else console.warn(`[Construct] Unknown screen reader text update '${t}'`)}_SetExportingToVideo(e){this._isExportToVideo=!0;const t=document.createElement("h1");t.id="exportToVideoMessage",t.textContent=e.message,document.body.prepend(t),document.body.classList.add("exportingToVideo"),this.GetRuntimeInterface().GetMainCanvas().style.display="",this._iRuntime.SetIsExportingToVideo(e.duration)}_OnExportVideoProgress(e){this._exportVideoProgressMessage=e.message,-1===this._exportVideoUpdateTimerId&&(this._exportVideoUpdateTimerId=setTimeout(()=>this._DoUpdateExportVideoProgressMessage(),250))}_DoUpdateExportVideoProgressMessage(){this._exportVideoUpdateTimerId=-1;const e=document.getElementById("exportToVideoMessage");e&&(e.textContent=this._exportVideoProgressMessage)}_OnExportedToVideo(e){window.c3_postToMessagePort({type:"exported-video",arrayBuffer:e.arrayBuffer,contentType:e.contentType,time:e.time})}_OnExportedToImageSequence(e){window.c3_postToMessagePort({type:"exported-image-sequence",blobArr:e.blobArr,time:e.time,gif:e.gif})}};P.AddDOMHandlerClass(x)}{const F="dispatchworker.js",U="jobworker.js";self.JobSchedulerDOM=class{constructor(e){this._runtimeInterface=e,this._maxNumWorkers=Math.min(navigator.hardwareConcurrency||2,16),this._dispatchWorker=null,this._jobWorkers=[],this._inputPort=null,this._outputPort=null}async Init(){if(this._hasInitialised)throw new Error("already initialised");this._hasInitialised=!0;const e=this._runtimeInterface.GetScriptFolder()+F;this._dispatchWorker=await this._runtimeInterface.CreateWorker(e,{name:"DispatchWorker"});const t=new MessageChannel;this._inputPort=t.port1,this._dispatchWorker.postMessage({type:"_init","in-port":t.port2},[t.port2]),this._outputPort=await this._CreateJobWorker()}async _CreateJobWorker(){const e=this._jobWorkers.length,t=this._runtimeInterface.GetScriptFolder()+U,i=await this._runtimeInterface.CreateWorker(t,{name:"JobWorker"+e}),s=new MessageChannel,n=new MessageChannel;return this._dispatchWorker.postMessage({type:"_addJobWorker",port:s.port1},[s.port1]),i.postMessage({type:"init",number:e,"dispatch-port":s.port2,"output-port":n.port2},[s.port2,n.port2]),this._jobWorkers.push(i),n.port1}GetPortData(){return{inputPort:this._inputPort,outputPort:this._outputPort,maxNumWorkers:this._maxNumWorkers}}GetPortTransferables(){return[this._inputPort,this._outputPort]}}}{const B="list";function W(e){e.stopPropagation()}const V=class extends self.DOMElementHandler{constructor(e){super(e,B),this.AddDOMElementMessageHandler("set-selected-index",(e,t)=>this._OnSetSelectedIndex(e,t.selectedIndex)),this.AddDOMElementMessageHandler("add-item",(e,t)=>this._OnAddItem(e,t)),this.AddDOMElementMessageHandler("remove-item",(e,t)=>this._OnRemoveItem(e,t)),this.AddDOMElementMessageHandler("set-item",(e,t)=>this._OnSetItem(e,t)),this.AddDOMElementMessageHandler("clear",e=>this._OnClear(e)),this.AddDOMElementMessageHandler("load-state",(e,t)=>this._OnLoadState(e,t))}CreateElement(e,t){const i=t.isDropdown,s=t.isMultiSelect,n=t.items,o=document.createElement("select");o.style.position="absolute",o.style.userSelect="none",o.style.webkitUserSelect="none",o.multiple=s,i||(o.size=2);for(const e of n)o.add(this._CreateOption(e));return o.addEventListener("pointerdown",W),o.addEventListener("pointerrawupdate",W),o.addEventListener("pointerup",W),o.addEventListener("mousedown",W),o.addEventListener("mouseup",W),o.addEventListener("click",t=>{t.stopPropagation(),this._PostToRuntimeElementMaybeSync("click",e,this._GetSelectionState(o))}),o.addEventListener("dblclick",t=>{t.stopPropagation(),this._PostToRuntimeElementMaybeSync("dblclick",e,this._GetSelectionState(o))}),o.addEventListener("change",()=>this.PostToRuntimeElement("change",e,this._GetSelectionState(o))),t.id&&(o.id=t.id),t.className&&(o.className=t.className),this.UpdateState(o,t),o}_CreateOption(e){const t=document.createElement("option");return t.text=e,t}_GetSelectionState(e){const t=e.selectedIndex,i=[];for(let t=0,s=e.length;t<s;++t)e.options[t].selected&&i.push(t);return{selectedIndex:t,selectedIndices:i}}UpdateState(e,t){e.title=t.title,e.disabled=!t.isEnabled,e.multiple=!!t.isMultiSelect}_OnSetSelectedIndex(e,t){e.selectedIndex=t}_OnAddItem(e,t){const i=t.text,s=t.index,n=this._CreateOption(i);s<0?e.add(n):e.add(n,s)}_OnRemoveItem(e,t){e.remove(t.index)}_OnSetItem(e,t){e.options[t.index].text=t.text}_OnClear(e){e.innerHTML=""}_OnLoadState(e,t){e.innerHTML="";for(const i of t.items)e.add(this._CreateOption(i));e.selectedIndex=t.selectedIndex;for(const i of t.selectedIndices){const t=e.options[i];t&&(t.selected=!0)}}};self.RuntimeInterface.AddDOMHandlerClass(V)}{const j="keyboard",z=class extends self.DOMHandler{constructor(e){super(e,j),this._isKeyboardLockSupported=!(!navigator.keyboard||!navigator.keyboard.lock),this.AddRuntimeMessageHandlers([["init",()=>this._OnInit()],["lock-keyboard",e=>this._OnLockKeyboard(e)],["unlock-keyboard",()=>this._OnUnlockKeyboard()]])}_OnInit(){return{isKeyboardLockSupported:this._isKeyboardLockSupported}}async _OnLockKeyboard(e){const t=e.keysArr;try{return 0===t.length?await navigator.keyboard.lock():await navigator.keyboard.lock(t),{isOk:!0}}catch(e){return console.error("Error locking keyboard:",e),{isOk:!1}}}_OnUnlockKeyboard(){try{navigator.keyboard.unlock()}catch(e){console.error("Error unlocking keyboard:",e)}}};self.RuntimeInterface.AddDOMHandlerClass(z)}{const q="touch",K=class extends self.DOMHandler{constructor(e){super(e,q),this.AddRuntimeMessageHandler("request-permission",e=>this._OnRequestPermission(e))}async _OnRequestPermission(e){const t=e.type;let i=!0;0===t?i=await this._RequestOrientationPermission():1===t&&(i=await this._RequestMotionPermission()),this.PostToRuntime("permission-result",{type:t,result:i})}async _RequestOrientationPermission(){if(!self.DeviceOrientationEvent||!self.DeviceOrientationEvent.requestPermission)return!0;try{return"granted"===await self.DeviceOrientationEvent.requestPermission()}catch(e){return console.warn("[Touch] Failed to request orientation permission: ",e),!1}}async _RequestMotionPermission(){if(!self.DeviceMotionEvent||!self.DeviceMotionEvent.requestPermission)return!0;try{return"granted"===await self.DeviceMotionEvent.requestPermission()}catch(e){return console.warn("[Touch] Failed to request motion permission: ",e),!1}}};self.RuntimeInterface.AddDOMHandlerClass(K)}{const Y="mouse",X=class extends self.DOMHandler{constructor(e){super(e,Y),this.AddRuntimeMessageHandlers([["cursor",e=>this._OnChangeCursorStyle(e)],["request-pointer-lock",e=>this._OnRequestPointerLock(e)],["release-pointer-lock",()=>this._OnReleasePointerLock()]]),document.addEventListener("pointerlockchange",e=>this._OnPointerLockChange()),document.addEventListener("pointerlockerror",e=>this._OnPointerLockError())}_OnChangeCursorStyle(e){document.documentElement.style.cursor=e}_OnRequestPointerLock(e){this._iRuntime.GetMainCanvas().requestPointerLock(e)}_OnReleasePointerLock(){document.exitPointerLock()}_OnPointerLockChange(){this.PostToRuntime("pointer-lock-change",{"has-pointer-lock":!!document.pointerLockElement})}_OnPointerLockError(){this.PostToRuntime("pointer-lock-error",{"has-pointer-lock":!!document.pointerLockElement})}};self.RuntimeInterface.AddDOMHandlerClass(X)}{const J=180/Math.PI,$="audio";self.AudioDOMHandler=class extends self.DOMHandler{constructor(e){super(e,$),this._audioContext=null,this._destinationNode=null,this._hasAttachedUnblockEvents=!1,this._unblockFunc=()=>this._UnblockAudioContext(),this._audioBuffers=[],this._audioInstances=[],this._lastAudioInstance=null,this._lastPlayedTags=[],this._loadedAudioUrls=new Set,this._lastTickCount=-1,this._pendingTags=new Map,this._masterVolume=1,this._isSilent=!1,this._timeScaleMode=0,this._timeScale=1,this._gameTime=0,this._panningModel="HRTF",this._distanceModel="inverse",this._refDistance=600,this._maxDistance=1e4,this._rolloffFactor=1,this._lastListenerPos=[0,0,0],this._lastListenerOrientation=[0,0,-1,0,1,0],this._playMusicAsSound=!1,this._lastMusicBuffer=null,this._effects=new Map,this._analysers=new Set,this._isPendingPostFxState=!1,this._hasStartedOfflineRender=!1,this._microphoneTag="",this._microphoneSource=null,self.C3Audio_OnMicrophoneStream=(e,t)=>this._OnMicrophoneStream(e,t),this._destMediaStreamNode=null,self.C3Audio_GetOutputStream=()=>this._OnGetOutputStream(),self.C3Audio_DOMInterface=this,this.AddRuntimeMessageHandlers([["create-audio-context",e=>this._CreateAudioContext(e)],["play",e=>this._Play(e)],["stop",e=>this._Stop(e)],["stop-all",()=>this._StopAll()],["set-paused",e=>this._SetPaused(e)],["set-volume",e=>this._SetVolume(e)],["fade-volume",e=>this._FadeVolume(e)],["set-master-volume",e=>this._SetMasterVolume(e)],["set-muted",e=>this._SetMuted(e)],["set-silent",e=>this._SetSilent(e)],["set-looping",e=>this._SetLooping(e)],["set-playback-rate",e=>this._SetPlaybackRate(e)],["set-stereo-pan",e=>this._SetStereoPan(e)],["seek",e=>this._Seek(e)],["preload",e=>this._Preload(e)],["unload",e=>this._Unload(e)],["unload-all",()=>this._UnloadAll()],["set-suspended",e=>this._SetSuspended(e)],["add-effect",e=>this._AddEffect(e)],["set-effect-param",e=>this._SetEffectParam(e)],["remove-effects",e=>this._RemoveEffects(e)],["tick",e=>this._OnTick(e)],["load-state",e=>this._OnLoadState(e)],["offline-render-audio",e=>this._OnOfflineRenderAudio(e)],["offline-render-finish",()=>this._OnOfflineRenderFinish()]])}async _CreateAudioContext(e){if(e.usePlayMusicAsSoundWorkaround&&(this._playMusicAsSound=!0),this._timeScaleMode=e.timeScaleMode,this._panningModel=["equalpower","HRTF","soundfield"][e.panningModel],this._distanceModel=["linear","inverse","exponential"][e.distanceModel],this._refDistance=e.refDistance,this._maxDistance=e.maxDistance,this._rolloffFactor=e.rolloffFactor,this._iRuntime.IsExportingToVideo()){this._playMusicAsSound=!0;const e=48e3;this._audioContext=new OfflineAudioContext({numberOfChannels:2,sampleRate:e,length:Math.ceil(this._iRuntime.GetExportToVideoDuration()*e)})}else this._audioContext=new AudioContext({latencyHint:e.latencyHint}),"running"!==this._audioContext.state&&this._AttachUnblockEvents(),this._audioContext.onstatechange=()=>{"running"===this._audioContext.state?this._DetachUnblockEvents():this._AttachUnblockEvents(),this.PostToRuntime("audiocontext-state",{audioContextState:this._audioContext.state})};this._destinationNode=this._audioContext.createGain(),this._destinationNode.connect(this._audioContext.destination);const t=e.listenerPos;this._lastListenerPos[0]=t[0],this._lastListenerPos[1]=t[1],this._lastListenerPos[2]=t[2],this._audioContext.listener.setPosition(t[0],t[1],t[2]),this._audioContext.listener.setOrientation(...this._lastListenerOrientation),self.C3_GetAudioContextCurrentTime=()=>this.GetAudioCurrentTime();try{await Promise.all(e.preloadList.map(e=>this._GetAudioBuffer(e.originalUrl,e.url,e.type,!1)))}catch(e){console.error("[Construct] Preloading sounds failed: ",e)}return{sampleRate:this._audioContext.sampleRate,audioContextState:this._audioContext.state,outputLatency:this._audioContext.outputLatency||0}}_AttachUnblockEvents(){this._hasAttachedUnblockEvents||(window.addEventListener("pointerup",this._unblockFunc,!0),window.addEventListener("touchend",this._unblockFunc,!0),window.addEventListener("click",this._unblockFunc,!0),window.addEventListener("keydown",this._unblockFunc,!0),this._iRuntime.IsiOSWebView()||document.addEventListener("visibilitychange",this._unblockFunc),this._hasAttachedUnblockEvents=!0)}_DetachUnblockEvents(){this._hasAttachedUnblockEvents&&(window.removeEventListener("pointerup",this._unblockFunc,!0),window.removeEventListener("touchend",this._unblockFunc,!0),window.removeEventListener("click",this._unblockFunc,!0),window.removeEventListener("keydown",this._unblockFunc,!0),this._iRuntime.IsiOSWebView()||document.removeEventListener("visibilitychange",this._unblockFunc),this._hasAttachedUnblockEvents=!1)}_UnblockAudioContext(){"running"!==this._audioContext.state&&this._audioContext.resume()}_MatchTagLists(e,t){for(const i of t){let t=!1;for(const s of e)if(self.AudioDOMHandler.EqualsNoCase(s,i)){t=!0;break}if(!t)return!1}return!0}GetAudioContext(){return this._audioContext}GetAudioCurrentTime(){return this._audioContext.currentTime}GetDestinationNode(){return this._destinationNode}GetAudioContextExtern(){return this.GetAudioContext()}GetDestinationNodeExtern(){return this.GetDestinationNode()}GetDestinationForTag(e){const t=this._effects.get(e.toLowerCase());return t?t[0].GetInputNode():this.GetDestinationNode()}AddEffectForTag(e,t){e=e.toLowerCase();let i=this._effects.get(e);i||(i=[],this._effects.set(e,i)),t._SetIndex(i.length),t._SetTag(e),i.push(t),this._ReconnectEffects(e)}_ReconnectEffects(e){e=e.toLowerCase();let t=this.GetDestinationNode();const i=this._effects.get(e);if(i&&i.length){t=i[0].GetInputNode();for(let e=0,t=i.length;e<t;++e){const s=i[e];e+1===t?s.ConnectTo(this.GetDestinationNode()):s.ConnectTo(i[e+1].GetInputNode())}}for(const i of this.audioInstancesByEffectTag(e))i.Reconnect(t);this._microphoneSource&&this._microphoneTag===e&&(this._microphoneSource.disconnect(),this._microphoneSource.connect(t))}GetMasterVolume(){return this._masterVolume}IsSilent(){return this._isSilent}GetTimeScaleMode(){return this._timeScaleMode}GetTimeScale(){return this._timeScale}GetGameTime(){return this._gameTime}IsPlayMusicAsSound(){return this._playMusicAsSound}GetPanningModel(){return this._panningModel}GetDistanceModel(){return this._distanceModel}GetReferenceDistance(){return this._refDistance}GetMaxDistance(){return this._maxDistance}GetRolloffFactor(){return this._rolloffFactor}TryPlayMedia(e){this._iRuntime.TryPlayMedia(e)}RemovePendingPlay(e){this._iRuntime.RemovePendingPlay(e)}ReleaseInstancesForBuffer(e){let t=0;for(let i=0,s=this._audioInstances.length;i<s;++i){const s=this._audioInstances[i];this._audioInstances[t]=s,s.GetBuffer()===e?s.Release():++t}this._audioInstances.length=t}ReleaseAllMusicBuffersExceptLast(){let e=0;for(let t=0,i=this._audioBuffers.length;t<i;++t){const i=this._audioBuffers[t];this._audioBuffers[e]=i,i.IsMusic()&&i!==this._lastMusicBuffer?i.Release():++e}this._audioBuffers.length=e}*audioInstancesMatchingTags(e){if(e.length>0)for(const t of this._audioInstances)this._MatchTagLists(t.GetTags(),e)&&(yield t);else this._lastAudioInstance&&!this._lastAudioInstance.HasEnded()&&(yield this._lastAudioInstance)}*audioInstancesByEffectTag(e){if(e)for(const t of this._audioInstances)self.AudioDOMHandler.EqualsNoCase(t.GetEffectTag(),e)&&(yield t);else this._lastAudioInstance&&!this._lastAudioInstance.HasEnded()&&(yield this._lastAudioInstance)}async _GetAudioBuffer(e,t,i,s,n){for(const e of this._audioBuffers)if(e.GetUrl()===t)return s&&this._playMusicAsSound&&(this._lastMusicBuffer=e),await e.Load(),e;if(n)return null;s&&this._playMusicAsSound&&this.ReleaseAllMusicBuffersExceptLast();const o=self.C3AudioBuffer.Create(this,e,t,i,s);return this._audioBuffers.push(o),s&&this._playMusicAsSound&&(this._lastMusicBuffer=o),await o.Load(),this._loadedAudioUrls.has(e)||(this.PostToRuntime("buffer-metadata",{originalUrl:e,duration:o.GetDuration()}),this._loadedAudioUrls.add(e)),o}async _GetAudioInstance(e,t,i,s,n){for(const e of this._audioInstances)if(e.GetUrl()===t&&(e.CanBeRecycled()||n))return n&&this._playMusicAsSound&&(this._lastMusicBuffer=e.GetBuffer()),e.SetTags(s),e;const o=await this._GetAudioBuffer(e,t,i,n);if(o.WasReleased())throw new Error(`buffer '${e}' unloaded while loading`);const a=o.CreateInstance(s);return this._audioInstances.push(a),a}_AddPendingTags(e){const t=e.join(" ");let i=this._pendingTags.get(t);if(!i){let e=null;i={pendingCount:0,promise:new Promise(t=>e=t),resolve:e},this._pendingTags.set(t,i)}i.pendingCount++}_RemovePendingTags(e){const t=e.join(" "),i=this._pendingTags.get(t);if(!i)throw new Error("expected pending tag");i.pendingCount--,0===i.pendingCount&&(i.resolve(),this._pendingTags.delete(t))}TagsReady(e){const t=(0===e.length?this._lastPlayedTags:e).join(" "),i=this._pendingTags.get(t);return i?i.promise:Promise.resolve()}_MaybeStartTicking(){if(this._analysers.size>0)this._StartTicking();else for(const e of this._audioInstances)if(e.IsActive())return void this._StartTicking()}Tick(){for(const e of this._analysers)e.Tick();const e=this.GetAudioCurrentTime();for(const t of this._audioInstances)t.Tick(e);const t=this._audioInstances.filter(e=>e.IsActive()).map(e=>e.GetState());this.PostToRuntime("state",{tickCount:this._lastTickCount,outputLatency:this._audioContext.outputLatency||0,audioInstances:t,analysers:[...this._analysers].map(e=>e.GetData())}),0===t.length&&0===this._analysers.size&&this._StopTicking()}PostTrigger(e,t,i){this.PostToRuntime("trigger",{type:e,tags:t,aiid:i})}async _Play(e){const t=e.originalUrl,i=e.url,s=e.type,n=e.isMusic,o=e.tags,a=e.isLooping,r=e.vol,d=e.pos,l=e.panning,h=e.stereoPan;let c=e.off;c>0&&!e.trueClock&&(c+=this.GetAudioCurrentTime()),this._lastPlayedTags=o.slice(0),this._AddPendingTags(o);try{this._lastAudioInstance=await this._GetAudioInstance(t,i,s,o,n),l?(this._lastAudioInstance.SetPannerEnabled(!0),this._lastAudioInstance.SetPan(l.x,l.y,l.z,l.angle,l.innerAngle,l.outerAngle,l.outerGain),l.hasOwnProperty("uid")&&this._lastAudioInstance.SetUID(l.uid)):"number"==typeof h&&0!==h?(this._lastAudioInstance.SetStereoPannerEnabled(!0),this._lastAudioInstance.SetStereoPan(h)):(this._lastAudioInstance.SetPannerEnabled(!1),this._lastAudioInstance.SetStereoPannerEnabled(!1)),this._lastAudioInstance.Play(a,r,d,c)}catch(e){return void console.error("[Construct] Audio: error starting playback: ",e)}finally{this._RemovePendingTags(o)}this._StartTicking()}_Stop(e){const t=e.tags;for(const e of this.audioInstancesMatchingTags(t))e.Stop()}_StopAll(){for(const e of this._audioInstances)e.Stop()}_SetPaused(e){const t=e.tags,i=e.paused;for(const e of this.audioInstancesMatchingTags(t))i?e.Pause():e.Resume();this._MaybeStartTicking()}_SetVolume(e){const t=e.tags,i=e.vol;for(const e of this.audioInstancesMatchingTags(t))e.SetVolume(i)}_SetStereoPan(e){const t=e.tags,i=e.p;for(const e of this.audioInstancesMatchingTags(t))e.SetStereoPannerEnabled(!0),e.SetStereoPan(i)}async _FadeVolume(e){const t=e.tags,i=e.vol,s=e.duration,n=e.stopOnEnd;await this.TagsReady(t);for(const e of this.audioInstancesMatchingTags(t))e.FadeVolume(i,s,n);this._MaybeStartTicking()}_SetMasterVolume(e){this._masterVolume=e.vol,this._destinationNode.gain.value=this._masterVolume}_SetMuted(e){const t=e.tags,i=e.isMuted;for(const e of this.audioInstancesMatchingTags(t))e.SetMuted(i)}_SetSilent(e){this._isSilent=e.isSilent,this._iRuntime.SetSilent(this._isSilent);for(const e of this._audioInstances)e._UpdateMuted()}_SetLooping(e){const t=e.tags,i=e.isLooping;for(const e of this.audioInstancesMatchingTags(t))e.SetLooping(i)}async _SetPlaybackRate(e){const t=e.tags,i=e.rate;await this.TagsReady(t);for(const e of this.audioInstancesMatchingTags(t))e.SetPlaybackRate(i)}async _Seek(e){const t=e.tags,i=e.pos;await this.TagsReady(t);for(const e of this.audioInstancesMatchingTags(t))e.Seek(i)}async _Preload(e){const t=e.originalUrl,i=e.url,s=e.type,n=e.isMusic;try{await this._GetAudioInstance(t,i,s,"",n)}catch(e){console.error("[Construct] Audio: error preloading: ",e)}}async _Unload(e){const t=e.url,i=e.type,s=e.isMusic,n=await this._GetAudioBuffer("",t,i,s,!0);if(!n)return;n.Release(),this._lastMusicBuffer===n&&(this._lastMusicBuffer=null);const o=this._audioBuffers.indexOf(n);-1!==o&&this._audioBuffers.splice(o,1)}_UnloadAll(){for(const e of this._audioBuffers)e.Release(),this._lastMusicBuffer===e&&(this._lastMusicBuffer=null);this._audioBuffers.length=0}_SetSuspended(e){const t=e.isSuspended;!t&&this._audioContext.resume&&this._audioContext.resume();for(const e of this._audioInstances)e.SetSuspended(t);t&&this._audioContext.suspend&&this._audioContext.suspend()}_OnTick(e){if(this._timeScale=e.timeScale,this._gameTime=e.gameTime,this._lastTickCount=e.tickCount,0!==this._timeScaleMode)for(const e of this._audioInstances)e._UpdatePlaybackRate();const t=e.listenerPos;!t||this._lastListenerPos[0]===t[0]&&this._lastListenerPos[1]===t[1]&&this._lastListenerPos[2]===t[2]||(this._lastListenerPos[0]=t[0],this._lastListenerPos[1]=t[1],this._lastListenerPos[2]=t[2],this._audioContext.listener.setPosition(t[0],t[1],t[2]));const i=e.listenerOrientation;if(i&&(this._lastListenerOrientation[0]!==i[0]||this._lastListenerOrientation[1]!==i[1]||this._lastListenerOrientation[2]!==i[2]||this._lastListenerOrientation[3]!==i[3]||this._lastListenerOrientation[4]!==i[4]||this._lastListenerOrientation[5]!==i[5])){for(let e=0;e<6;++e)this._lastListenerOrientation[e]=i[e];this._audioContext.listener.setOrientation(...this._lastListenerOrientation)}for(const t of e.instPans){const e=t.uid;for(const i of this._audioInstances)i.GetUID()===e&&i.SetPanXYZA(t.x,t.y,t.z,t.angle)}}async _AddEffect(e){const t=e.type,i=e.hasOwnProperty("tags")?e.tags:[e.tag],s=e.params;let n,o;if("convolution"===t)try{o=await this._GetAudioBuffer(e.bufferOriginalUrl,e.bufferUrl,e.bufferType,!1)}catch(e){return void console.log("[Construct] Audio: error loading convolution: ",e)}for(const a of i){if("filter"===t)n=new self.C3AudioFilterFX(this,...s);else if("delay"===t)n=new self.C3AudioDelayFX(this,...s);else if("convolution"===t)n=new self.C3AudioConvolveFX(this,o.GetAudioBuffer(),...s),n._SetBufferInfo(e.bufferOriginalUrl,e.bufferUrl,e.bufferType);else if("flanger"===t)n=new self.C3AudioFlangerFX(this,...s);else if("phaser"===t)n=new self.C3AudioPhaserFX(this,...s);else if("gain"===t)n=new self.C3AudioGainFX(this,...s);else if("stereopan"===t)n=new self.C3AudioStereoPanFX(this,...s);else if("tremolo"===t)n=new self.C3AudioTremoloFX(this,...s);else if("ringmod"===t)n=new self.C3AudioRingModFX(this,...s);else if("distortion"===t)n=new self.C3AudioDistortionFX(this,...s);else if("compressor"===t)n=new self.C3AudioCompressorFX(this,...s);else{if("analyser"!==t)throw new Error("invalid effect type");n=new self.C3AudioAnalyserFX(this,...s)}this.AddEffectForTag(a,n)}this._PostUpdatedFxState()}_SetEffectParam(e){const t=e.tags,i=e.index,s=e.param,n=e.value,o=e.ramp,a=e.time;for(const e of t){const t=this._effects.get(e.toLowerCase());!t||i<0||i>=t.length||t[i].SetParam(s,n,o,a)}this._PostUpdatedFxState()}_RemoveEffects(e){const t=e.tags;for(const e of t){const t=e.toLowerCase(),i=this._effects.get(t);if(!i||!i.length)return;for(const e of i)e.Release();this._effects.delete(t),this._ReconnectEffects(t)}}_AddAnalyser(e){this._analysers.add(e),this._MaybeStartTicking()}_RemoveAnalyser(e){this._analysers.delete(e)}_PostUpdatedFxState(){this._isPendingPostFxState||(this._isPendingPostFxState=!0,Promise.resolve().then(()=>this._DoPostUpdatedFxState()))}_DoPostUpdatedFxState(){const e={};for(const[t,i]of this._effects)e[t]=i.map(e=>e.GetState());this.PostToRuntime("fxstate",{fxstate:e}),this._isPendingPostFxState=!1}async _OnLoadState(e){const t=e.saveLoadMode;if(3!==t){const e=[];for(const i of this._audioInstances)i.IsMusic()&&1===t||!i.IsMusic()&&2===t?e.push(i):i.Release();this._audioInstances=e}for(const e of this._effects.values())for(const t of e)t.Release();this._effects.clear(),this._timeScale=e.timeScale,this._gameTime=e.gameTime;const i=e.listenerPos;this._lastListenerPos[0]=i[0],this._lastListenerPos[1]=i[1],this._lastListenerPos[2]=i[2],this._audioContext.listener.setPosition(i[0],i[1],i[2]);const s=e.listenerOrientation;if(Array.isArray(s)){for(let e=0;e<6;++e)this._lastListenerOrientation[e]=s[e];this._audioContext.listener.setOrientation(...this._lastListenerOrientation)}this._isSilent=e.isSilent,this._iRuntime.SetSilent(this._isSilent),this._masterVolume=e.masterVolume,this._destinationNode.gain.value=this._masterVolume;const n=[];for(const t of Object.values(e.effects))n.push(Promise.all(t.map(e=>this._AddEffect(e))));await Promise.all(n),await Promise.all(e.playing.map(e=>this._LoadAudioInstance(e,t))),this._MaybeStartTicking()}async _LoadAudioInstance(e,t){if(3===t)return;const i=e.bufferOriginalUrl,s=e.bufferUrl,n=e.bufferType,o=e.isMusic,a=e.tags,r=e.isLooping,d=e.volume,l=e.playbackTime;if(o&&1===t)return;if(!o&&2===t)return;let h=null;try{h=await this._GetAudioInstance(i,s,n,a,o)}catch(e){return void console.error("[Construct] Audio: error loading audio state: ",e)}h.LoadPanState(e.pan),h.LoadStereoPanState(e.stereoPan),h.Play(r,d,l,0),e.isPlaying||h.Pause(),h._LoadAdditionalState(e)}_OnMicrophoneStream(e,t){this._microphoneSource&&this._microphoneSource.disconnect(),this._microphoneTag=t.toLowerCase(),this._microphoneSource=this._audioContext.createMediaStreamSource(e),this._microphoneSource.connect(this.GetDestinationForTag(this._microphoneTag))}_OnGetOutputStream(){return this._destMediaStreamNode||(this._destMediaStreamNode=this._audioContext.createMediaStreamDestination(),this._destinationNode.connect(this._destMediaStreamNode)),this._destMediaStreamNode.stream}async _OnOfflineRenderAudio(e){try{const t=e.time,i=this._audioContext.suspend(t);this._hasStartedOfflineRender?this._audioContext.resume():(this._audioContext.startRendering().then(e=>this._OnOfflineRenderCompleted(e)).catch(e=>this._OnOfflineRenderError(e)),this._hasStartedOfflineRender=!0),await i}catch(e){this._OnOfflineRenderError(e)}}_OnOfflineRenderFinish(){this._audioContext.resume()}_OnOfflineRenderCompleted(e){const t=[];for(let i=0,s=e.numberOfChannels;i<s;++i){const s=e.getChannelData(i);t.push(s.buffer)}this._iRuntime.PostToRuntimeComponent("runtime","offline-audio-render-completed",{duration:e.duration,length:e.length,numberOfChannels:e.numberOfChannels,sampleRate:e.sampleRate,channelData:t},null,t)}_OnOfflineRenderError(e){console.error("[Audio] Offline rendering error: ",e)}static EqualsNoCase(e,t){return e===t||e.normalize().toLowerCase()===t.normalize().toLowerCase()}static ToDegrees(e){return e*J}static DbToLinearNoCap(e){return Math.pow(10,e/20)}static DbToLinear(e){return Math.max(Math.min(self.AudioDOMHandler.DbToLinearNoCap(e),1),0)}static LinearToDbNoCap(e){return Math.log(e)/Math.log(10)*20}static LinearToDb(e){return self.AudioDOMHandler.LinearToDbNoCap(Math.max(Math.min(e,1),0))}static e4(e,t){return 1-Math.exp(-t*e)}},self.RuntimeInterface.AddDOMHandlerClass(self.AudioDOMHandler)}self.C3AudioBuffer=class{constructor(e,t,i,s,n){this._audioDomHandler=e,this._originalUrl=t,this._url=i,this._type=s,this._isMusic=n,this._api="",this._loadState="not-loaded",this._loadPromise=null}Release(){this._loadState="not-loaded",this._audioDomHandler=null,this._loadPromise=null}WasReleased(){return!this._audioDomHandler}static Create(e,t,i,s,n){return!n||e.IsPlayMusicAsSound()?new self.C3WebAudioBuffer(e,t,i,s,n):new self.C3Html5AudioBuffer(e,t,i,s,n)}CreateInstance(e){return"html5"===this._api?new self.C3Html5AudioInstance(this._audioDomHandler,this,e):new self.C3WebAudioInstance(this._audioDomHandler,this,e)}_Load(){}Load(){return this._loadPromise||(this._loadPromise=this._Load()),this._loadPromise}IsLoaded(){}IsLoadedAndDecoded(){}HasFailedToLoad(){return"failed"===this._loadState}GetAudioContext(){return this._audioDomHandler.GetAudioContext()}GetApi(){return this._api}GetOriginalUrl(){return this._originalUrl}GetUrl(){return this._url}GetContentType(){return this._type}IsMusic(){return this._isMusic}GetDuration(){}},self.C3Html5AudioBuffer=class extends self.C3AudioBuffer{constructor(e,t,i,s,n){super(e,t,i,s,n),this._api="html5",this._audioElem=new Audio,this._audioElem.crossOrigin="anonymous",this._audioElem.autoplay=!1,this._audioElem.preload="auto",this._loadResolve=null,this._loadReject=null,this._reachedCanPlayThrough=!1,this._audioElem.addEventListener("canplaythrough",()=>this._reachedCanPlayThrough=!0),this._outNode=this.GetAudioContext().createGain(),this._mediaSourceNode=null,this._audioElem.addEventListener("canplay",()=>{this._loadResolve&&(this._loadState="loaded",this._loadResolve(),this._loadResolve=null,this._loadReject=null),!this._mediaSourceNode&&this._audioElem&&(this._mediaSourceNode=this.GetAudioContext().createMediaElementSource(this._audioElem),this._mediaSourceNode.connect(this._outNode))}),this.onended=null,this._audioElem.addEventListener("ended",()=>{this.onended&&this.onended()}),this._audioElem.addEventListener("error",e=>this._OnError(e))}Release(){this._audioDomHandler.ReleaseInstancesForBuffer(this),this._outNode.disconnect(),this._outNode=null,this._mediaSourceNode.disconnect(),this._mediaSourceNode=null,this._audioElem&&!this._audioElem.paused&&this._audioElem.pause(),this.onended=null,this._audioElem=null,super.Release()}_Load(){return this._loadState="loading",new Promise((e,t)=>{this._loadResolve=e,this._loadReject=t,this._audioElem.src=this._url})}_OnError(e){console.error(`[Construct] Audio '${this._url}' error: `,e),this._loadReject&&(this._loadState="failed",this._loadReject(e),this._loadResolve=null,this._loadReject=null)}IsLoaded(){const e=this._audioElem.readyState>=4;return e&&(this._reachedCanPlayThrough=!0),e||this._reachedCanPlayThrough}IsLoadedAndDecoded(){return this.IsLoaded()}GetAudioElement(){return this._audioElem}GetOutputNode(){return this._outNode}GetDuration(){return this._audioElem.duration}},self.C3WebAudioBuffer=class extends self.C3AudioBuffer{constructor(e,t,i,s,n){super(e,t,i,s,n),this._api="webaudio",this._audioData=null,this._audioBuffer=null}Release(){this._audioDomHandler.ReleaseInstancesForBuffer(this),this._audioData=null,this._audioBuffer=null,super.Release()}async _Fetch(){if(this._audioData)return this._audioData;const e=this._audioDomHandler.GetRuntimeInterface();if("cordova"===e.GetExportType()&&e.IsRelativeURL(this._url)&&e.IsFileProtocol())this._audioData=await e.CordovaFetchLocalFileAsArrayBuffer(this._url);else if("playable-ad-single-file"===e.GetExportType()&&e.IsRelativeURL(this._url)){const t=e._PlayableAdFetchBlob(this._url);this._audioData=await t.arrayBuffer()}else{const e=await fetch(this._url);if(!e.ok)throw new Error(`error fetching audio data: ${e.status} ${e.statusText}`);this._audioData=await e.arrayBuffer()}}async _Decode(){if(this._audioBuffer)return this._audioBuffer;const e=this._audioDomHandler.GetAudioContext();this._audioBuffer=await e.decodeAudioData(this._audioData),this._audioData=null}async _Load(){try{if(this._loadState="loading",await this._Fetch(),this.WasReleased())return;await this._Decode(),this._loadState="loaded"}catch(e){this._loadState="failed",console.error(`[Construct] Failed to load audio '${this._url}': `,e)}}IsLoaded(){return!(!this._audioData&&!this._audioBuffer)}IsLoadedAndDecoded(){return!!this._audioBuffer}GetAudioBuffer(){return this._audioBuffer}GetDuration(){return this._audioBuffer?this._audioBuffer.duration:0}};{let Z=0;self.C3AudioInstance=class{constructor(e,t,i){this._audioDomHandler=e,this._buffer=t,this._tags=i,this._lastEffectTag=this.GetEffectTag(),this._aiId=Z++,this._gainNode=this.GetAudioContext().createGain(),this._gainNode.connect(this.GetDestinationNode()),this._pannerNode=null,this._isPannerEnabled=!1,this._pannerPosition=[0,0,0],this._pannerOrientation=[0,0,0],this._pannerConeParams=[0,0,0],this._stereoPannerNode=null,this._isStereoPannerEnabled=!1,this._stereoPan=0,this._isStopped=!0,this._isPaused=!1,this._resumeMe=!1,this._isLooping=!1,this._volume=1,this._isMuted=!1,this._playbackRate=1;const s=this._audioDomHandler.GetTimeScaleMode();this._isTimescaled=1===s&&!this.IsMusic()||2===s,this._instUid=-1,this._fadeEndTime=-1,this._stopOnFadeEnd=!1}Release(){this._audioDomHandler=null,this._buffer=null,this._pannerNode&&(this._pannerNode.disconnect(),this._pannerNode=null),this._stereoPannerNode&&(this._stereoPannerNode.disconnect(),this._stereoPannerNode=null),this._gainNode.disconnect(),this._gainNode=null}GetAudioContext(){return this._audioDomHandler.GetAudioContext()}SetTags(e){this._tags=e;const t=this.GetEffectTag();this._lastEffectTag!==t&&(this._lastEffectTag=t,this.Reconnect(this.GetDestinationNode()))}GetTags(){return this._tags}GetEffectTag(){return this._tags.length>0?this._tags[0]:""}GetDestinationNode(){return this._audioDomHandler.GetDestinationForTag(this.GetEffectTag())}GetCurrentTime(){return this._isTimescaled?this._audioDomHandler.GetGameTime():performance.now()/1e3}GetOriginalUrl(){return this._buffer.GetOriginalUrl()}GetUrl(){return this._buffer.GetUrl()}GetContentType(){return this._buffer.GetContentType()}GetBuffer(){return this._buffer}IsMusic(){return this._buffer.IsMusic()}GetAiId(){return this._aiId}HasEnded(){}CanBeRecycled(){}IsPlaying(){return!this._isStopped&&!this._isPaused&&!this.HasEnded()}IsActive(){return!this._isStopped&&!this.HasEnded()}GetPlaybackTime(){}GetDuration(e){let t=this._buffer.GetDuration();return e&&(t/=this._playbackRate||.001),t}Play(e,t,i,s){}Stop(){}Pause(){}IsPaused(){return this._isPaused}Resume(){}SetVolume(e){this._volume=e,this._gainNode.gain.cancelScheduledValues(0),this._fadeEndTime=-1,this._gainNode.gain.value=this.GetOutputVolume()}FadeVolume(e,t,i){if(this.IsMuted())return;const s=this._gainNode.gain;s.cancelScheduledValues(0);const n=this._audioDomHandler.GetAudioCurrentTime(),o=n+t;s.setValueAtTime(s.value,n),s.linearRampToValueAtTime(e,o),this._volume=e,this._fadeEndTime=o,this._stopOnFadeEnd=i}_UpdateVolume(){this.SetVolume(this._volume)}Tick(e){-1!==this._fadeEndTime&&e>=this._fadeEndTime&&(this._fadeEndTime=-1,this._stopOnFadeEnd&&this.Stop(),this._audioDomHandler.PostTrigger("fade-ended",this._tags,this._aiId))}GetOutputVolume(){const e=this._volume;return isFinite(e)?e:0}SetMuted(e){e=!!e,this._isMuted!==e&&(this._isMuted=e,this._UpdateMuted())}IsMuted(){return this._isMuted}IsSilent(){return this._audioDomHandler.IsSilent()}_UpdateMuted(){}SetLooping(e){}IsLooping(){return this._isLooping}SetPlaybackRate(e){this._playbackRate!==e&&(this._playbackRate=e,this._UpdatePlaybackRate())}_UpdatePlaybackRate(){}GetPlaybackRate(){return this._playbackRate}Seek(e){}SetSuspended(e){}SetPannerEnabled(e){e=!!e,this._isPannerEnabled!==e&&(this._isPannerEnabled=e,this._isPannerEnabled?(this.SetStereoPannerEnabled(!1),this._pannerNode||(this._pannerNode=this.GetAudioContext().createPanner(),this._pannerNode.panningModel=this._audioDomHandler.GetPanningModel(),this._pannerNode.distanceModel=this._audioDomHandler.GetDistanceModel(),this._pannerNode.refDistance=this._audioDomHandler.GetReferenceDistance(),this._pannerNode.maxDistance=this._audioDomHandler.GetMaxDistance(),this._pannerNode.rolloffFactor=this._audioDomHandler.GetRolloffFactor()),this._gainNode.disconnect(),this._gainNode.connect(this._pannerNode),this._pannerNode.connect(this.GetDestinationNode())):(this._pannerNode.disconnect(),this._gainNode.disconnect(),this._gainNode.connect(this.GetDestinationNode())))}SetPan(e,t,i,s,n,o,a){if(!this._isPannerEnabled)return;this.SetPanXYZA(e,t,i,s);const r=self.AudioDOMHandler.ToDegrees;this._pannerConeParams[0]!==r(n)&&(this._pannerConeParams[0]=r(n),this._pannerNode.coneInnerAngle=r(n)),this._pannerConeParams[1]!==r(o)&&(this._pannerConeParams[1]=r(o),this._pannerNode.coneOuterAngle=r(o)),this._pannerConeParams[2]!==a&&(this._pannerConeParams[2]=a,this._pannerNode.coneOuterGain=a)}SetPanXYZA(e,t,i,s){if(!this._isPannerEnabled)return;const n=this._pannerPosition,o=this._pannerOrientation,a=Math.cos(s),r=Math.sin(s);n[0]===e&&n[1]===t&&n[2]===i||(n[0]=e,n[1]=t,n[2]=i,this._pannerNode.setPosition(...n)),o[0]===a&&o[1]===r&&0===o[2]||(o[0]=a,o[1]=r,o[2]=0,this._pannerNode.setOrientation(...o))}SetStereoPannerEnabled(e){e=!!e,this._isStereoPannerEnabled!==e&&(this._isStereoPannerEnabled=e,this._isStereoPannerEnabled?(this.SetPannerEnabled(!1),this._stereoPannerNode=this.GetAudioContext().createStereoPanner(),this._gainNode.disconnect(),this._gainNode.connect(this._stereoPannerNode),this._stereoPannerNode.connect(this.GetDestinationNode())):(this._stereoPannerNode.disconnect(),this._stereoPannerNode=null,this._gainNode.disconnect(),this._gainNode.connect(this.GetDestinationNode())))}SetStereoPan(e){this._isStereoPannerEnabled&&this._stereoPan!==e&&(this._stereoPannerNode.pan.value=e,this._stereoPan=e)}SetUID(e){this._instUid=e}GetUID(){return this._instUid}GetResumePosition(){}Reconnect(e){const t=this._stereoPannerNode||this._pannerNode||this._gainNode;t.disconnect(),t.connect(e)}GetState(){return{aiid:this.GetAiId(),tags:this._tags,duration:this.GetDuration(),volume:-1===this._fadeEndTime?this._volume:this._gainNode.gain.value,isPlaying:this.IsPlaying(),playbackTime:this.GetPlaybackTime(),playbackRate:this.GetPlaybackRate(),uid:this._instUid,bufferOriginalUrl:this.GetOriginalUrl(),bufferUrl:"",bufferType:this.GetContentType(),isMusic:this.IsMusic(),isLooping:this.IsLooping(),isMuted:this.IsMuted(),resumePosition:this.GetResumePosition(),pan:this.GetPanState(),stereoPan:this.GetStereoPanState()}}_LoadAdditionalState(e){this.SetPlaybackRate(e.playbackRate),this.SetMuted(e.isMuted)}GetPanState(){if(!this._pannerNode)return null;const e=this._pannerNode;return{pos:this._pannerPosition,orient:this._pannerOrientation,cia:e.coneInnerAngle,coa:e.coneOuterAngle,cog:e.coneOuterGain,uid:this._instUid}}LoadPanState(e){if(!e)return void this.SetPannerEnabled(!1);this.SetPannerEnabled(!0);const t=this._pannerNode,i=e.pos;this._pannerPosition[0]=i[0],this._pannerPosition[1]=i[1],this._pannerPosition[2]=i[2];const s=e.orient;this._pannerOrientation[0]=s[0],this._pannerOrientation[1]=s[1],this._pannerOrientation[2]=s[2],t.setPosition(...this._pannerPosition),t.setOrientation(...this._pannerOrientation),this._pannerConeParams[0]=e.cia,this._pannerConeParams[1]=e.coa,this._pannerConeParams[2]=e.cog,t.coneInnerAngle=e.cia,t.coneOuterAngle=e.coa,t.coneOuterGain=e.cog,this._instUid=e.uid}GetStereoPanState(){return this._stereoPannerNode?this._stereoPan:null}LoadStereoPanState(e){"number"==typeof e?(this.SetStereoPannerEnabled(!0),this.SetStereoPan(e)):this.SetStereoPannerEnabled(!1)}}}self.C3Html5AudioInstance=class extends self.C3AudioInstance{constructor(e,t,i){super(e,t,i),this._buffer.GetOutputNode().connect(this._gainNode),this._buffer.onended=()=>this._OnEnded()}Release(){this.Stop(),this._buffer.GetOutputNode().disconnect(),super.Release()}GetAudioElement(){return this._buffer.GetAudioElement()}_OnEnded(){this._isStopped=!0,this._instUid=-1,this._audioDomHandler.PostTrigger("ended",this._tags,this._aiId)}HasEnded(){return this.GetAudioElement().ended}CanBeRecycled(){return!!this._isStopped||this.HasEnded()}GetPlaybackTime(){let e=this.GetAudioElement().currentTime;return this._isLooping||(e=Math.min(e,this.GetDuration())),e}Play(e,t,i,s){const n=this.GetAudioElement();if(1!==n.playbackRate&&(n.playbackRate=1),n.loop!==e&&(n.loop=e),this.SetVolume(t),this._isMuted=!1,n.muted&&(n.muted=!1),n.currentTime!==i)try{n.currentTime=i}catch(e){console.warn(`[Construct] Exception seeking audio '${this._buffer.GetUrl()}' to position '${i}': `,e)}this._audioDomHandler.TryPlayMedia(n),this._isStopped=!1,this._isPaused=!1,this._isLooping=e,this._playbackRate=1}Stop(){const e=this.GetAudioElement();e.paused||e.pause(),this._audioDomHandler.RemovePendingPlay(e),this._isStopped=!0,this._isPaused=!1,this._instUid=-1}Pause(){if(this._isPaused||this._isStopped||this.HasEnded())return;const e=this.GetAudioElement();e.paused||e.pause(),this._audioDomHandler.RemovePendingPlay(e),this._isPaused=!0}Resume(){!this._isPaused||this._isStopped||this.HasEnded()||(this._audioDomHandler.TryPlayMedia(this.GetAudioElement()),this._isPaused=!1)}_UpdateMuted(){this.GetAudioElement().muted=this._isMuted||this.IsSilent()}SetLooping(e){e=!!e,this._isLooping!==e&&(this._isLooping=e,this.GetAudioElement().loop=e)}_UpdatePlaybackRate(){let e=this._playbackRate;this._isTimescaled&&(e*=this._audioDomHandler.GetTimeScale());try{this.GetAudioElement().playbackRate=e}catch(t){console.warn(`[Construct] Unable to set playback rate '${e}':`,t)}}Seek(e){if(!this._isStopped&&!this.HasEnded())try{this.GetAudioElement().currentTime=e}catch(t){console.warn(`[Construct] Error seeking audio to '${e}': `,t)}}GetResumePosition(){return this.GetPlaybackTime()}SetSuspended(e){e?this.IsPlaying()?(this.GetAudioElement().pause(),this._resumeMe=!0):this._resumeMe=!1:this._resumeMe&&(this._audioDomHandler.TryPlayMedia(this.GetAudioElement()),this._resumeMe=!1)}},self.C3WebAudioInstance=class extends self.C3AudioInstance{constructor(e,t,i){super(e,t,i),this._bufferSource=null,this._onended_handler=e=>this._OnEnded(e),this._hasPlaybackEnded=!0,this._activeSource=null,this._playStartTime=0,this._playFromSeekPos=0,this._resumePosition=0,this._muteVol=1}Release(){this.Stop(),this._ReleaseBufferSource(),this._onended_handler=null,super.Release()}_ReleaseBufferSource(){this._bufferSource&&(this._bufferSource.onended=null,this._bufferSource.disconnect(),this._bufferSource.buffer=null),this._bufferSource=null,this._activeSource=null}_OnEnded(e){this._isPaused||this._resumeMe||e.target===this._activeSource&&(this._hasPlaybackEnded=!0,this._isStopped=!0,this._instUid=-1,this._ReleaseBufferSource(),this._audioDomHandler.PostTrigger("ended",this._tags,this._aiId))}HasEnded(){return!(!this._isStopped&&this._bufferSource&&this._bufferSource.loop)&&!this._isPaused&&this._hasPlaybackEnded}CanBeRecycled(){return!(this._bufferSource&&!this._isStopped)||this.HasEnded()}GetPlaybackTime(){let e=0;return e=this._isPaused?this._resumePosition:this._playFromSeekPos+(this.GetCurrentTime()-this._playStartTime)*this._playbackRate,this._isLooping||(e=Math.min(e,this.GetDuration())),e}Play(e,t,i,s){this._isMuted=!1,this._muteVol=1,this.SetVolume(t),this._ReleaseBufferSource(),this._bufferSource=this.GetAudioContext().createBufferSource(),this._bufferSource.buffer=this._buffer.GetAudioBuffer(),this._bufferSource.connect(this._gainNode),this._activeSource=this._bufferSource,this._bufferSource.onended=this._onended_handler,this._bufferSource.loop=e,this._bufferSource.start(s,i),this._hasPlaybackEnded=!1,this._isStopped=!1,this._isPaused=!1,this._isLooping=e,this._playbackRate=1,this._playStartTime=this.GetCurrentTime(),this._playFromSeekPos=i}Stop(){if(this._bufferSource)try{this._bufferSource.stop(0)}catch(e){}this._isStopped=!0,this._isPaused=!1,this._instUid=-1}Pause(){this._isPaused||this._isStopped||this.HasEnded()||(this._resumePosition=this.GetPlaybackTime(),this._isLooping&&(this._resumePosition%=this.GetDuration()),this._isPaused=!0,this._bufferSource.stop(0))}Resume(){!this._isPaused||this._isStopped||this.HasEnded()||(this._ReleaseBufferSource(),this._bufferSource=this.GetAudioContext().createBufferSource(),this._bufferSource.buffer=this._buffer.GetAudioBuffer(),this._bufferSource.connect(this._gainNode),this._activeSource=this._bufferSource,this._bufferSource.onended=this._onended_handler,this._bufferSource.loop=this._isLooping,this._UpdateVolume(),this._UpdatePlaybackRate(),this._bufferSource.start(0,this._resumePosition),this._playStartTime=this.GetCurrentTime(),this._playFromSeekPos=this._resumePosition,this._isPaused=!1)}GetOutputVolume(){return super.GetOutputVolume()*this._muteVol}_UpdateMuted(){this._muteVol=this._isMuted||this.IsSilent()?0:1,this._UpdateVolume()}SetLooping(e){e=!!e,this._isLooping!==e&&(this._isLooping=e,this._bufferSource&&(this._bufferSource.loop=e))}_UpdatePlaybackRate(){let e=this._playbackRate;this._isTimescaled&&(e*=this._audioDomHandler.GetTimeScale()),this._bufferSource&&(this._bufferSource.playbackRate.value=e)}Seek(e){this._isStopped||this.HasEnded()||(this._isPaused?this._resumePosition=e:(this.Pause(),this._resumePosition=e,this.Resume()))}GetResumePosition(){return this._resumePosition}SetSuspended(e){e?this.IsPlaying()?(this._resumeMe=!0,this._resumePosition=this.GetPlaybackTime(),this._isLooping&&(this._resumePosition%=this.GetDuration()),this._bufferSource.stop(0)):this._resumeMe=!1:this._resumeMe&&(this._ReleaseBufferSource(),this._bufferSource=this.GetAudioContext().createBufferSource(),this._bufferSource.buffer=this._buffer.GetAudioBuffer(),this._bufferSource.connect(this._gainNode),this._activeSource=this._bufferSource,this._bufferSource.onended=this._onended_handler,this._bufferSource.loop=this._isLooping,this._UpdateVolume(),this._UpdatePlaybackRate(),this._bufferSource.start(0,this._resumePosition),this._playStartTime=this.GetCurrentTime(),this._playFromSeekPos=this._resumePosition,this._resumeMe=!1)}_LoadAdditionalState(e){super._LoadAdditionalState(e),this._resumePosition=e.resumePosition}};{class Q{constructor(e){this._audioDomHandler=e,this._audioContext=e.GetAudioContext(),this._index=-1,this._tag="",this._type="",this._params=null}Release(){this._audioContext=null}_SetIndex(e){this._index=e}GetIndex(){return this._index}_SetTag(e){this._tag=e}GetTag(){return this._tag}CreateGain(){return this._audioContext.createGain()}GetInputNode(){}ConnectTo(e){}SetAudioParam(e,t,i,s){if(e.cancelScheduledValues(0),0===s)return void(e.value=t);const n=this._audioContext.currentTime;switch(s+=n,i){case 0:e.setValueAtTime(t,s);break;case 1:e.setValueAtTime(e.value,n),e.linearRampToValueAtTime(t,s);break;case 2:e.setValueAtTime(e.value,n),e.exponentialRampToValueAtTime(t,s)}}GetState(){return{type:this._type,tag:this._tag,params:this._params}}}self.C3AudioFilterFX=class extends Q{constructor(e,t,i,s,n,o,a){super(e),this._type="filter",this._params=[t,i,s,n,o,a],this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode.gain.value=a,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-a,this._filterNode=this._audioContext.createBiquadFilter(),this._filterNode.type=t,this._filterNode.frequency.value=i,this._filterNode.detune.value=s,this._filterNode.Q.value=n,this._filterNode.gain.vlaue=o,this._inputNode.connect(this._filterNode),this._inputNode.connect(this._dryNode),this._filterNode.connect(this._wetNode)}Release(){this._inputNode.disconnect(),this._filterNode.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),super.Release()}ConnectTo(e){this._wetNode.disconnect(),this._wetNode.connect(e),this._dryNode.disconnect(),this._dryNode.connect(e)}GetInputNode(){return this._inputNode}SetParam(e,t,i,s){switch(e){case 0:t=Math.max(Math.min(t/100,1),0),this._params[5]=t,this.SetAudioParam(this._wetNode.gain,t,i,s),this.SetAudioParam(this._dryNode.gain,1-t,i,s);break;case 1:this._params[1]=t,this.SetAudioParam(this._filterNode.frequency,t,i,s);break;case 2:this._params[2]=t,this.SetAudioParam(this._filterNode.detune,t,i,s);break;case 3:this._params[3]=t,this.SetAudioParam(this._filterNode.Q,t,i,s);break;case 4:this._params[4]=t,this.SetAudioParam(this._filterNode.gain,t,i,s)}}},self.C3AudioDelayFX=class extends Q{constructor(e,t,i,s){super(e),this._type="delay",this._params=[t,i,s],this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode.gain.value=s,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-s,this._mainNode=this.CreateGain(),this._delayNode=this._audioContext.createDelay(t),this._delayNode.delayTime.value=t,this._delayGainNode=this.CreateGain(),this._delayGainNode.gain.value=i,this._inputNode.connect(this._mainNode),this._inputNode.connect(this._dryNode),this._mainNode.connect(this._wetNode),this._mainNode.connect(this._delayNode),this._delayNode.connect(this._delayGainNode),this._delayGainNode.connect(this._mainNode)}Release(){this._inputNode.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),this._mainNode.disconnect(),this._delayNode.disconnect(),this._delayGainNode.disconnect(),super.Release()}ConnectTo(e){this._wetNode.disconnect(),this._wetNode.connect(e),this._dryNode.disconnect(),this._dryNode.connect(e)}GetInputNode(){return this._inputNode}SetParam(e,t,i,s){const n=self.AudioDOMHandler.DbToLinear;switch(e){case 0:t=Math.max(Math.min(t/100,1),0),this._params[2]=t,this.SetAudioParam(this._wetNode.gain,t,i,s),this.SetAudioParam(this._dryNode.gain,1-t,i,s);break;case 4:this._params[1]=n(t),this.SetAudioParam(this._delayGainNode.gain,n(t),i,s);break;case 5:this._params[0]=t,this.SetAudioParam(this._delayNode.delayTime,t,i,s)}}},self.C3AudioConvolveFX=class extends Q{constructor(e,t,i,s){super(e),this._type="convolution",this._params=[i,s],this._bufferOriginalUrl="",this._bufferUrl="",this._bufferType="",this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode.gain.value=s,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-s,this._convolveNode=this._audioContext.createConvolver(),this._convolveNode.normalize=i,this._convolveNode.buffer=t,this._inputNode.connect(this._convolveNode),this._inputNode.connect(this._dryNode),this._convolveNode.connect(this._wetNode)}Release(){this._inputNode.disconnect(),this._convolveNode.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),super.Release()}ConnectTo(e){this._wetNode.disconnect(),this._wetNode.connect(e),this._dryNode.disconnect(),this._dryNode.connect(e)}GetInputNode(){return this._inputNode}SetParam(e,t,i,s){0===e&&(t=Math.max(Math.min(t/100,1),0),this._params[1]=t,this.SetAudioParam(this._wetNode.gain,t,i,s),this.SetAudioParam(this._dryNode.gain,1-t,i,s))}_SetBufferInfo(e,t,i){this._bufferOriginalUrl=e,this._bufferUrl=t,this._bufferType=i}GetState(){const e=super.GetState();return e.bufferOriginalUrl=this._bufferOriginalUrl,e.bufferUrl="",e.bufferType=this._bufferType,e}},self.C3AudioFlangerFX=class extends Q{constructor(e,t,i,s,n,o){super(e),this._type="flanger",this._params=[t,i,s,n,o],this._inputNode=this.CreateGain(),this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-o/2,this._wetNode=this.CreateGain(),this._wetNode.gain.value=o/2,this._feedbackNode=this.CreateGain(),this._feedbackNode.gain.value=n,this._delayNode=this._audioContext.createDelay(t+i),this._delayNode.delayTime.value=t,this._oscNode=this._audioContext.createOscillator(),this._oscNode.frequency.value=s,this._oscGainNode=this.CreateGain(),this._oscGainNode.gain.value=i,this._inputNode.connect(this._delayNode),this._inputNode.connect(this._dryNode),this._delayNode.connect(this._wetNode),this._delayNode.connect(this._feedbackNode),this._feedbackNode.connect(this._delayNode),this._oscNode.connect(this._oscGainNode),this._oscGainNode.connect(this._delayNode.delayTime),this._oscNode.start(0)}Release(){this._oscNode.stop(0),this._inputNode.disconnect(),this._delayNode.disconnect(),this._oscNode.disconnect(),this._oscGainNode.disconnect(),this._dryNode.disconnect(),this._wetNode.disconnect(),this._feedbackNode.disconnect(),super.Release()}ConnectTo(e){this._wetNode.disconnect(),this._wetNode.connect(e),this._dryNode.disconnect(),this._dryNode.connect(e)}GetInputNode(){return this._inputNode}SetParam(e,t,i,s){switch(e){case 0:t=Math.max(Math.min(t/100,1),0),this._params[4]=t,this.SetAudioParam(this._wetNode.gain,t/2,i,s),this.SetAudioParam(this._dryNode.gain,1-t/2,i,s);break;case 6:this._params[1]=t/1e3,this.SetAudioParam(this._oscGainNode.gain,t/1e3,i,s);break;case 7:this._params[2]=t,this.SetAudioParam(this._oscNode.frequency,t,i,s);break;case 8:this._params[3]=t/100,this.SetAudioParam(this._feedbackNode.gain,t/100,i,s)}}},self.C3AudioPhaserFX=class extends Q{constructor(e,t,i,s,n,o,a){super(e),this._type="phaser",this._params=[t,i,s,n,o,a],this._inputNode=this.CreateGain(),this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-a/2,this._wetNode=this.CreateGain(),this._wetNode.gain.value=a/2,this._filterNode=this._audioContext.createBiquadFilter(),this._filterNode.type="allpass",this._filterNode.frequency.value=t,this._filterNode.detune.value=i,this._filterNode.Q.value=s,this._oscNode=this._audioContext.createOscillator(),this._oscNode.frequency.value=o,this._oscGainNode=this.CreateGain(),this._oscGainNode.gain.value=n,this._inputNode.connect(this._filterNode),this._inputNode.connect(this._dryNode),this._filterNode.connect(this._wetNode),this._oscNode.connect(this._oscGainNode),this._oscGainNode.connect(this._filterNode.frequency),this._oscNode.start(0)}Release(){this._oscNode.stop(0),this._inputNode.disconnect(),this._filterNode.disconnect(),this._oscNode.disconnect(),this._oscGainNode.disconnect(),this._dryNode.disconnect(),this._wetNode.disconnect(),super.Release()}ConnectTo(e){this._wetNode.disconnect(),this._wetNode.connect(e),this._dryNode.disconnect(),this._dryNode.connect(e)}GetInputNode(){return this._inputNode}SetParam(e,t,i,s){switch(e){case 0:t=Math.max(Math.min(t/100,1),0),this._params[5]=t,this.SetAudioParam(this._wetNode.gain,t/2,i,s),this.SetAudioParam(this._dryNode.gain,1-t/2,i,s);break;case 1:this._params[0]=t,this.SetAudioParam(this._filterNode.frequency,t,i,s);break;case 2:this._params[1]=t,this.SetAudioParam(this._filterNode.detune,t,i,s);break;case 3:this._params[2]=t,this.SetAudioParam(this._filterNode.Q,t,i,s);break;case 6:this._params[3]=t,this.SetAudioParam(this._oscGainNode.gain,t,i,s);break;case 7:this._params[4]=t,this.SetAudioParam(this._oscNode.frequency,t,i,s)}}},self.C3AudioGainFX=class extends Q{constructor(e,t){super(e),this._type="gain",this._params=[t],this._node=this.CreateGain(),this._node.gain.value=t}Release(){this._node.disconnect(),super.Release()}ConnectTo(e){this._node.disconnect(),this._node.connect(e)}GetInputNode(){return this._node}SetParam(e,t,i,s){const n=self.AudioDOMHandler.DbToLinear;4===e&&(this._params[0]=n(t),this.SetAudioParam(this._node.gain,n(t),i,s))}},self.C3AudioStereoPanFX=class extends Q{constructor(e,t){super(e),this._type="stereopan",this._params=[t],this._node=this._audioContext.createStereoPanner(),this._node.pan.value=t}Release(){this._node.disconnect(),super.Release()}ConnectTo(e){this._node.disconnect(),this._node.connect(e)}GetInputNode(){return this._node}SetParam(e,t,i,s){t=Math.min(Math.max(t/100,-1),1),9===e&&(this._params[0]=t,this.SetAudioParam(this._node.pan,t,i,s))}},self.C3AudioTremoloFX=class extends Q{constructor(e,t,i){super(e),this._type="tremolo",this._params=[t,i],this._node=this.CreateGain(),this._node.gain.value=1-i/2,this._oscNode=this._audioContext.createOscillator(),this._oscNode.frequency.value=t,this._oscGainNode=this.CreateGain(),this._oscGainNode.gain.value=i/2,this._oscNode.connect(this._oscGainNode),this._oscGainNode.connect(this._node.gain),this._oscNode.start(0)}Release(){this._oscNode.stop(0),this._oscNode.disconnect(),this._oscGainNode.disconnect(),this._node.disconnect(),super.Release()}ConnectTo(e){this._node.disconnect(),this._node.connect(e)}GetInputNode(){return this._node}SetParam(e,t,i,s){switch(e){case 0:t=Math.max(Math.min(t/100,1),0),this._params[1]=t,this.SetAudioParam(this._node.gain,1-t/2,i,s),this.SetAudioParam(this._oscGainNode.gain,t/2,i,s);break;case 7:this._params[0]=t,this.SetAudioParam(this._oscNode.frequency,t,i,s)}}},self.C3AudioRingModFX=class extends Q{constructor(e,t,i){super(e),this._type="ringmod",this._params=[t,i],this._inputNode=this.CreateGain(),this._wetNode=this.CreateGain(),this._wetNode.gain.value=i,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-i,this._ringNode=this.CreateGain(),this._ringNode.gain.value=0,this._oscNode=this._audioContext.createOscillator(),this._oscNode.frequency.value=t,this._oscNode.connect(this._ringNode.gain),this._oscNode.start(0),this._inputNode.connect(this._ringNode),this._inputNode.connect(this._dryNode),this._ringNode.connect(this._wetNode)}Release(){this._oscNode.stop(0),this._oscNode.disconnect(),this._ringNode.disconnect(),this._inputNode.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),super.Release()}ConnectTo(e){this._wetNode.disconnect(),this._wetNode.connect(e),this._dryNode.disconnect(),this._dryNode.connect(e)}GetInputNode(){return this._inputNode}SetParam(e,t,i,s){switch(e){case 0:t=Math.max(Math.min(t/100,1),0),this._params[1]=t,this.SetAudioParam(this._wetNode.gain,t,i,s),this.SetAudioParam(this._dryNode.gain,1-t,i,s);break;case 7:this._params[0]=t,this.SetAudioParam(this._oscNode.frequency,t,i,s)}}},self.C3AudioDistortionFX=class extends Q{constructor(e,t,i,s,n,o){super(e),this._type="distortion",this._params=[t,i,s,n,o],this._inputNode=this.CreateGain(),this._preGain=this.CreateGain(),this._postGain=this.CreateGain(),this._SetDrive(s,n),this._wetNode=this.CreateGain(),this._wetNode.gain.value=o,this._dryNode=this.CreateGain(),this._dryNode.gain.value=1-o,this._waveShaper=this._audioContext.createWaveShaper(),this._curve=new Float32Array(65536),this._GenerateColortouchCurve(t,i),this._waveShaper.curve=this._curve,this._inputNode.connect(this._preGain),this._inputNode.connect(this._dryNode),this._preGain.connect(this._waveShaper),this._waveShaper.connect(this._postGain),this._postGain.connect(this._wetNode)}Release(){this._inputNode.disconnect(),this._preGain.disconnect(),this._waveShaper.disconnect(),this._postGain.disconnect(),this._wetNode.disconnect(),this._dryNode.disconnect(),super.Release()}_SetDrive(e,t){e<.01&&(e=.01),this._preGain.gain.value=e,this._postGain.gain.value=Math.pow(1/e,.6)*t}_GenerateColortouchCurve(e,t){const i=32768;for(let s=0;s<i;++s){let n=s/i;n=this._Shape(n,e,t),this._curve[i+s]=n,this._curve[i-s-1]=-n}}_Shape(e,t,i){const s=1.05*i*t-t,n=e<0?-1:1,o=e<0?-e:e;let a=o<t?o:t+s*self.AudioDOMHandler.e4(o-t,1/s);return a*=n,a}ConnectTo(e){this._wetNode.disconnect(),this._wetNode.connect(e),this._dryNode.disconnect(),this._dryNode.connect(e)}GetInputNode(){return this._inputNode}SetParam(e,t,i,s){0===e&&(t=Math.max(Math.min(t/100,1),0),this._params[4]=t,this.SetAudioParam(this._wetNode.gain,t,i,s),this.SetAudioParam(this._dryNode.gain,1-t,i,s))}},self.C3AudioCompressorFX=class extends Q{constructor(e,t,i,s,n,o){super(e),this._type="compressor",this._params=[t,i,s,n,o],this._node=this._audioContext.createDynamicsCompressor(),this._node.threshold.value=t,this._node.knee.value=i,this._node.ratio.value=s,this._node.attack.value=n,this._node.release.value=o}Release(){this._node.disconnect(),super.Release()}ConnectTo(e){this._node.disconnect(),this._node.connect(e)}GetInputNode(){return this._node}SetParam(e,t,i,s){}},self.C3AudioAnalyserFX=class extends Q{constructor(e,t,i){super(e),this._type="analyser",this._params=[t,i],this._node=this._audioContext.createAnalyser(),this._node.fftSize=t,this._node.smoothingTimeConstant=i,this._freqBins=new Float32Array(this._node.frequencyBinCount),this._signal=new Uint8Array(t),this._peak=0,this._rms=0,this._audioDomHandler._AddAnalyser(this)}Release(){this._audioDomHandler._RemoveAnalyser(this),this._node.disconnect(),super.Release()}Tick(){this._node.getFloatFrequencyData(this._freqBins),this._node.getByteTimeDomainData(this._signal);const e=this._node.fftSize;this._peak=0;let t=0;for(let i=0;i<e;++i){let e=(this._signal[i]-128)/128;e<0&&(e=-e),this._peak<e&&(this._peak=e),t+=e*e}const i=self.AudioDOMHandler.LinearToDb;this._peak=i(this._peak),this._rms=i(Math.sqrt(t/e))}ConnectTo(e){this._node.disconnect(),this._node.connect(e)}GetInputNode(){return this._node}SetParam(e,t,i,s){}GetData(){return{tag:this.GetTag(),index:this.GetIndex(),peak:this._peak,rms:this._rms,binCount:this._node.frequencyBinCount,freqBins:this._freqBins}}}}{let ee=null,te=null;function ie(e,t){if(e){if(t)return Array.from(document.querySelectorAll(e));{const t=document.querySelector(e);return t?[t]:[]}}return[document.documentElement]}function se(){}window.addEventListener("beforeinstallprompt",e=>(e.preventDefault(),ee=e,te&&te._OnBeforeInstallPrompt(),!1));const ne="browser",oe=class extends self.DOMHandler{constructor(e){super(e,ne),this._exportType="",this.AddRuntimeMessageHandlers([["get-initial-state",e=>this._OnGetInitialState(e)],["ready-for-sw-messages",()=>this._OnReadyForSWMessages()],["alert",e=>this._OnAlert(e)],["close",()=>this._OnClose()],["set-focus",e=>this._OnSetFocus(e)],["vibrate",e=>this._OnVibrate(e)],["lock-orientation",e=>this._OnLockOrientation(e)],["unlock-orientation",()=>this._OnUnlockOrientation()],["navigate",e=>this._OnNavigate(e)],["request-fullscreen",e=>this._OnRequestFullscreen(e)],["exit-fullscreen",()=>this._OnExitFullscreen()],["set-hash",e=>this._OnSetHash(e)],["set-document-css-style",e=>this._OnSetDocumentCSSStyle(e)],["get-document-css-style",e=>this._OnGetDocumentCSSStyle(e)],["set-window-size",e=>this._OnSetWindowSize(e)],["set-window-position",e=>this._OnSetWindowPosition(e)],["request-install",()=>this._OnRequestInstall()],["set-warn-on-close",e=>this._OnSetWarnOnClose(e)]]),window.addEventListener("online",()=>this._OnOnlineStateChanged(!0)),window.addEventListener("offline",()=>this._OnOnlineStateChanged(!1)),window.addEventListener("hashchange",()=>this._OnHashChange()),this._beforeunload_handler=e=>e.preventDefault(),document.addEventListener("backbutton",()=>this._OnCordovaBackButton())}Attach(){ee?this._OnBeforeInstallPrompt():te=this,window.addEventListener("appinstalled",()=>this._OnAppInstalled())}_OnGetInitialState(e){return this._exportType=e.exportType,{location:location.toString(),isOnline:!!navigator.onLine,referrer:document.referrer,title:document.title,isCookieEnabled:!!navigator.cookieEnabled,screenWidth:screen.width,screenHeight:screen.height,windowOuterWidth:window.outerWidth,windowOuterHeight:window.outerHeight,isConstructArcade:void 0!==window.is_scirra_arcade,windowHasFocus:document.hasFocus()}}_OnReadyForSWMessages(){window.C3_RegisterSW&&window.OfflineClientInfo&&window.OfflineClientInfo.SetMessageCallback(e=>this.PostToRuntime("sw-message",e.data))}_OnBeforeInstallPrompt(){this.PostToRuntime("install-available")}async _OnRequestInstall(){if(!ee)return{result:"unavailable"};try{return ee.prompt(),{result:(await ee.userChoice).outcome}}catch(e){return console.error("[Construct] Requesting install failed: ",e),{result:"failed"}}}_OnAppInstalled(){this.PostToRuntime("app-installed")}_OnOnlineStateChanged(e){this.PostToRuntime("online-state",{isOnline:e})}_OnCordovaBackButton(){this.PostToRuntime("backbutton")}GetNWjsWindow(){return"nwjs"===this._exportType?nw.Window.get():null}_OnAlert(e){alert(e.message)}_OnClose(){navigator.app&&navigator.app.exitApp?navigator.app.exitApp():navigator.device&&navigator.device.exitApp?navigator.device.exitApp():self.nw?self.nw.App.quit():window.close()}_OnSetFocus(e){const t=e.isFocus;if("nwjs"===this._exportType){const e=this.GetNWjsWindow();t?e.focus():e.blur()}else t?window.focus():window.blur()}_OnVibrate(e){navigator.vibrate&&navigator.vibrate(e.pattern)}_OnLockOrientation(e){const t=e.orientation;if(screen.orientation&&screen.orientation.lock)screen.orientation.lock(t).catch(e=>console.warn("[Construct] Failed to lock orientation: ",e));else try{let e=!1;screen.lockOrientation?e=screen.lockOrientation(t):screen.webkitLockOrientation?e=screen.webkitLockOrientation(t):screen.mozLockOrientation?e=screen.mozLockOrientation(t):screen.msLockOrientation&&(e=screen.msLockOrientation(t)),e||console.warn("[Construct] Failed to lock orientation")}catch(e){console.warn("[Construct] Failed to lock orientation: ",e)}}_OnUnlockOrientation(){try{screen.orientation&&screen.orientation.unlock?screen.orientation.unlock():screen.unlockOrientation?screen.unlockOrientation():screen.webkitUnlockOrientation?screen.webkitUnlockOrientation():screen.mozUnlockOrientation?screen.mozUnlockOrientation():screen.msUnlockOrientation&&screen.msUnlockOrientation()}catch(e){}}_OnNavigate(e){const t=e.type;if("back"===t)navigator.app&&navigator.app.backHistory?navigator.app.backHistory():window.history.back();else if("forward"===t)window.history.forward();else if("reload"===t)location.reload();else if("url"===t){const t=e.url,i=e.target,s=e.exportType;self.cordova&&self.cordova.InAppBrowser?self.cordova.InAppBrowser.open(t,"_system"):"preview"===s||"macos-wkwebiew"===s||"linux-cef"===s||this._iRuntime.IsAnyWebView2Wrapper()?window.open(t,"_blank"):this._isConstructArcade||(2===i?window.top.location=t:1===i?window.parent.location=t:window.location=t)}else if("new-window"===t){const t=e.url,i=e.tag;self.cordova&&self.cordova.InAppBrowser?self.cordova.InAppBrowser.open(t,"_system"):window.open(t,i)}}_OnRequestFullscreen(e){if(this._iRuntime.IsAnyWebView2Wrapper()||"macos-wkwebview"===this._exportType||"linux-cef"===this._exportType)self.RuntimeInterface._SetWrapperIsFullscreenFlag(!0),this._iRuntime._SendWrapperMessage({type:"set-fullscreen",fullscreen:!0});else{const t={navigationUI:"auto"},i=e.navUI;1===i?t.navigationUI="hide":2===i&&(t.navigationUI="show");const s=document.documentElement;let n;s.requestFullscreen?n=s.requestFullscreen(t):s.mozRequestFullScreen?n=s.mozRequestFullScreen(t):s.msRequestFullscreen?n=s.msRequestFullscreen(t):s.webkitRequestFullScreen&&(n=void 0!==Element.ALLOW_KEYBOARD_INPUT?s.webkitRequestFullScreen(Element.ALLOW_KEYBOARD_INPUT):s.webkitRequestFullScreen()),n instanceof Promise&&n.catch(se)}}_OnExitFullscreen(){if(this._iRuntime.IsAnyWebView2Wrapper()||"macos-wkwebview"===this._exportType||"linux-cef"===this._exportType)self.RuntimeInterface._SetWrapperIsFullscreenFlag(!1),this._iRuntime._SendWrapperMessage({type:"set-fullscreen",fullscreen:!1});else{let e;document.exitFullscreen?e=document.exitFullscreen():document.mozCancelFullScreen?e=document.mozCancelFullScreen():document.msExitFullscreen?e=document.msExitFullscreen():document.webkitCancelFullScreen&&(e=document.webkitCancelFullScreen()),e instanceof Promise&&e.catch(se)}}_OnSetHash(e){location.hash=e.hash}_OnHashChange(){this.PostToRuntime("hashchange",{location:location.toString()})}_OnSetDocumentCSSStyle(e){const t=e.prop,i=e.value,s=e.selector,n=e["is-all"];try{const e=ie(s,n);for(const s of e)t.startsWith("--")?s.style.setProperty(t,i):s.style[t]=i}catch(e){console.warn("[Browser] Failed to set style: ",e)}}_OnGetDocumentCSSStyle(e){const t=e.prop,i=e.selector;try{const e=document.querySelector(i);return e?{isOk:!0,result:window.getComputedStyle(e).getPropertyValue(t)}:{isOk:!1}}catch(e){return console.warn("[Browser] Failed to get style: ",e),{isOk:!1}}}_OnSetWindowSize(e){window.resizeTo(e.windowWidth,e.windowHeight)}_OnSetWindowPosition(e){window.moveTo(e.windowX,e.windowY)}_OnSetWarnOnClose(e){e.enabled?window.addEventListener("beforeunload",this._beforeunload_handler):window.removeEventListener("beforeunload",this._beforeunload_handler)}};self.RuntimeInterface.AddDOMHandlerClass(oe)}{const ae="platform-info";function re(e){return new Promise((t,i)=>{e.getInsetTop(t,i)})}function de(e){return new Promise((t,i)=>{e.getInsetRight(t,i)})}function le(e){return new Promise((t,i)=>{e.getInsetBottom(t,i)})}function he(e){return new Promise((t,i)=>{e.getInsetLeft(t,i)})}const ce=class extends self.DOMHandler{constructor(e){super(e,ae),this.AddRuntimeMessageHandlers([["get-initial-state",()=>this._OnGetInitialState()],["request-wake-lock",()=>this._OnRequestWakeLock()],["release-wake-lock",()=>this._OnReleaseWakeLock()]]),window.addEventListener("resize",()=>this._OnResize()),this._screenWakeLock=null}async _OnGetInitialState(){const e=await this._GetSafeAreaInset();return{screenWidth:screen.width,screenHeight:screen.height,windowOuterWidth:window.outerWidth,windowOuterHeight:window.outerHeight,safeAreaInset:e,supportsWakeLock:!!navigator.wakeLock}}async _GetSafeAreaInset(){const e=self.AndroidNotch;if(!e){const e=document.body,t=e.style;t.setProperty("--temp-sai-top","env(safe-area-inset-top)"),t.setProperty("--temp-sai-right","env(safe-area-inset-right)"),t.setProperty("--temp-sai-bottom","env(safe-area-inset-bottom)"),t.setProperty("--temp-sai-left","env(safe-area-inset-left)");const i=getComputedStyle(e),s=[i.getPropertyValue("--temp-sai-top"),i.getPropertyValue("--temp-sai-right"),i.getPropertyValue("--temp-sai-bottom"),i.getPropertyValue("--temp-sai-left")].map(e=>{const t=parseInt(e,10);return isFinite(t)?t:0});return t.removeProperty("--temp-sai-top"),t.removeProperty("--temp-sai-right"),t.removeProperty("--temp-sai-bottom"),t.removeProperty("--temp-sai-left"),s}try{return await Promise.all([re(e),de(e),le(e),he(e)])}catch(e){return console.error("[Construct] Failed to get Android safe area inset: ",e),[0,0,0,0]}}async _OnResize(){const e=await this._GetSafeAreaInset();this.PostToRuntime("window-resize",{windowOuterWidth:window.outerWidth,windowOuterHeight:window.outerHeight,safeAreaInset:e})}async _OnRequestWakeLock(){if(!this._screenWakeLock)try{this._screenWakeLock=await navigator.wakeLock.request("screen"),this._screenWakeLock.addEventListener("release",()=>this._OnWakeLockReleased()),console.log("[Construct] Screen wake lock acquired"),this.PostToRuntime("wake-lock-acquired")}catch(e){console.warn("[Construct] Failed to acquire screen wake lock: ",e),this.PostToRuntime("wake-lock-error")}}_OnReleaseWakeLock(){this._screenWakeLock&&(this._screenWakeLock.release(),this._screenWakeLock=null)}_OnWakeLockReleased(){console.log("[Construct] Screen wake lock released"),this._screenWakeLock=null,this.PostToRuntime("wake-lock-released")}};self.RuntimeInterface.AddDOMHandlerClass(ce)}{const ue=[],_e=2*Math.PI;function me(e){return(e%=_e)<0&&(e+=_e),e}function pe(e,t,i){return e<t?t:e>i?i:e}function ge(e,t,i){return e+i*(t-e)}function fe(e,t,i){return e===t?0:(i-e)/(t-e)}function ye(e,t){if(e===t)return 0;const i=Math.sin(e),s=Math.cos(e),n=i*Math.sin(t)+s*Math.cos(t);return n>=1?0:n<=-1?Math.PI:Math.acos(n)}function we(e,t){const i=Math.sin(e);return Math.cos(e)*Math.sin(t)-i*Math.cos(t)<=0}function Se(e,t,i){const s=ye(e,t);return we(t,e)?me(e+s*i):me(e-s*i)}class ve{constructor(e,t,i,s,n,o){this._index=e,this._interp=t,this._precision=i,this._tag=s,this._userData=n,this._clientValueTag=o}GetRuntimeData(){return{tag:this._tag,interp:this._interp,userData:this._userData,cvt:this._clientValueTag}}GetIndex(){return this._index}GetInterp(){return this._interp}GetPrecision(){return this._precision}GetTag(){return this._tag}HasUserData(){return void 0!==this._userData}GetUserData(){return this._userData}GetClientValueTag(){return this._clientValueTag}Clamp(e){switch(this._precision){case 0:default:return e;case 1:return Math.fround(e);case 2:return 2===this._interp&&(e=me(e),e/=Math.PI,e-=1,e*=32767),pe(0|e,-32768,32767);case 3:return 2===this._interp&&(e=me(e),e/=_e,e*=255),pe(0|e,0,255)}}Write(e,t,i){switch(this._precision){case 0:e.setFloat64(t,i),t+=8;break;case 1:default:e.setFloat32(t,i),t+=4;break;case 2:e.setInt16(t,i),t+=2;break;case 3:e.setUint8(t,i),t+=1}return t}MaybeUnpack(e){return 2!==this._interp?e:2===this._precision?(e/=32767,e+=1,e*=Math.PI):3===this._precision?(e/=255,e*=_e):e}static InterpNetValue(e,t,i,s,n){switch(e){case 0:default:return n?i:t;case 1:return ge(t,i,s);case 2:return Se(t,i,s)}}}class Pe{constructor(e,t){this.timestamp=e,this.data=t}}class be{constructor(e,t,i){this._ro=e,this._domHandler=e.GetDOMHandler(),this._id=t,this._nid=i,this._data=[],this._data.length=this._ro.GetNetValues().length,this._lastChanged=0,this._lastTransmitted=0,this._transmitMe=!1,this._isAlive=!1,this._updates=[],this._priorUpdate2=null,this._priorUpdate=null,this._nextUpdate=null}GetRuntimeData(){const e=[];for(let t=0,i=this._ro.GetNetValues().length;t<i;++t)e.push(this.GetInterp(this._ro.GetSimTime(),t));const t={id:this._id,nid:this._nid,isTimedOut:this.IsTimedOut(),interpValues:e,latestUpdate:null},i=this.GetLatestUpdate();return i&&(t.latestUpdate={timestamp:i.timestamp,data:i.data}),t}GetId(){return this._id}GetNid(){return this._nid}SetAlive(e){this._isAlive=!!e}IsAlive(){return this._isAlive}ShouldTransmit(){return this._transmitMe}UpdateData(e,t){const i=e.netValues,s=this._ro.GetNetValues(),n=s.length;this._transmitMe=!1;for(let e=0;e<n;++e){const n=s[e].Clamp(i[e]);this._data[e]!==n&&(this._data[e]=n,this._lastChanged=t,this._ro.SetLastChanged(t))}const o=t-this._lastChanged,a=t-this._lastTransmitted,r=this._ro.GetBandwidth();this._transmitMe=o<100&&0===r||(o<1e3&&r<=1?a>=95:a>=495),this._transmitMe&&this._ro.IncNumberToTransmit()}WriteData(e,t,i){const s=this._ro.GetNetValues();this._lastTransmitted=i,e.setUint16(t,this._nid),t+=2;for(let i=0,n=this._data.length;i<n;++i)t=s[i].Write(e,t,this._data[i]);return t}AddUpdate(e,t){for(let i=0,s=this._updates.length;i<s;++i){const s=this._updates[i];if(s.timestamp===e)return;if(s.timestamp>e)return void this._updates.splice(i,0,new Pe(e,t))}this._updates.push(new Pe(e,t))}IsTimedOut(){return 0!==this._updates.length&&this._updates[this._updates.length-1].timestamp<this._ro.GetSimTime()-3e3}Tick(){for(;this._updates.length>2&&this._updates[0]!==this._priorUpdate2&&this._updates[0]!==this._priorUpdate&&this._updates[0]!==this._nextUpdate;)this._updates.shift();const e=this._ro.GetSimTime();if(!(this._nextUpdate&&this._nextUpdate.timestamp>e&&this._priorUpdate&&this._priorUpdate.timestamp<e)){this._nextUpdate=null;for(let t=0,i=this._updates.length;t<i;++t){const i=this._updates[t];if(!(i.timestamp<=e)){this._nextUpdate=i;break}(!this._priorUpdate||i.timestamp>this._priorUpdate.timestamp)&&(this._priorUpdate2=this._priorUpdate,this._priorUpdate=i)}}}GetLatestUpdate(){return 0===this._updates.length?null:this._updates[this._updates.length-1]}GetInterp(e,t,i){if(!this._nextUpdate&&!this._priorUpdate)return 0;if(this._nextUpdate&&!this._priorUpdate)return this._nextUpdate.data[t];const s=this._ro.GetNetValues();let n,o,a,r,d;if(!this._nextUpdate&&this._priorUpdate){if(this._priorUpdate2&&!i){n=this._priorUpdate2.timestamp,o=this._priorUpdate2.data[t],a=this._priorUpdate.timestamp,r=this._priorUpdate.data[t];let i=e;return i>this._priorUpdate.timestamp+this._ro.GetExtrapolateLimit()&&(i=this._priorUpdate.timestamp+this._ro.GetExtrapolateLimit()),d=fe(n,a,i),ve.InterpNetValue(s[t].GetInterp(),o,r,d,!0)}return this._priorUpdate.data[t]}return n=this._priorUpdate.timestamp,o=this._priorUpdate.data[t],a=this._nextUpdate.timestamp,r=this._nextUpdate.data[t],d=fe(n,a,e),ve.InterpNetValue(s[t].GetInterp(),o,r,d,!1)}}class Ce{constructor(e,t,i,s){switch(this._domHandler=e,this._roId=t,this._sid=i,this._nid=this._domHandler.GetNextObjectNid(),this._bandwidth=s,this._userData={},this._instanceByteSize=0,this._extrapolateLimit=250,this._bandwidth){case 1:this._extrapolateLimit=500;break;case 2:this._extrapolateLimit=2500}this._netValues=[],this._netInstances=[],this._idToNetInst=new Map,this._usedNids=new Set,this._nextNid=0,this._lastChanged=0,this._lastTransmitted=0,this._numberToTransmit=0,this._hasOverriddenNids=!1,this._deadNids=[],this._overrideNids=new Map,this._nidToNetInst=new Map,this._simTime=0,this._domHandler.AddRegisteredObject(this)}GetDOMHandler(){return this._domHandler}GetNetValues(){return this._netValues}GetRoId(){return this._roId}_SetNid(e){this._nid=e}GetNid(){return this._nid}SetLastChanged(e){this._lastChanged=e}GetBandwidth(){return this._bandwidth}IncNumberToTransmit(){this._numberToTransmit++}GetNumberToTransmit(){return this._numberToTransmit}GetSimTime(){return this._simTime}_SetHasOverriddenNids(e){this._hasOverriddenNids=!!e}HasOverriddenNids(){return this._hasOverriddenNids}GetExtrapolateLimit(){return this._extrapolateLimit}GetSid(){return this._sid}GetDeadNids(){return this._deadNids}AddValue(e,t,i,s,n){const o=new ve(this._netValues.length,e,t,i,s,n);switch(t){case 0:this._instanceByteSize+=8;break;case 1:this._instanceByteSize+=4;break;case 2:this._instanceByteSize+=2;break;case 3:this._instanceByteSize+=1}this._netValues.push(o)}AddUpdate(e,t,i){this.GetNetInstForNid(t).AddUpdate(e,i)}Tick(){this._simTime=this._domHandler.GetSimulationTime();for(const e of this._netInstances)e.Tick()}GetCount(){return this._netInstances.length}GetNetInstAt(e){return(e=Math.floor(e))<0||e>=this._netInstances.length?null:this._netInstances[e]}GetNetInstByNid(e){for(const t of this._netInstances)if(t.GetNid()===e)return t;return null}GetNetValuesJson(){const e=[];for(const t of this._netValues){const i={tag:t.GetTag(),precision:t.GetPrecision(),interp:t.GetInterp(),clientvaluetag:t.GetClientValueTag()};t.HasUserData()&&(i.userdata=t.GetUserData()),e.push(i)}return e}SetNetValuesFrom(e){this._netValues.length=0,this._instanceByteSize=0;for(const t of e)this.AddValue(t.interp,t.precision,t.tag,t.userdata,t.clientvaluetag)}GetNetInstForNid(e){let t=this._nidToNetInst.get(e);return t||(t=new be(this,-1,e),this._nidToNetInst.set(e,t),this._netInstances.push(t),t)}GetNetInstForId(e){let t=this._idToNetInst.get(e);return t||(t=new be(this,e,this.AllocateInstanceNid()),this._idToNetInst.set(e,t),this._netInstances.push(t),t)}AllocateInstanceNid(){do{this._nextNid++,this._nextNid>65535&&(this._nextNid=0)}while(this._usedNids.has(this._nextNid));const e=this._nextNid;return this._usedNids.add(e),e}RemoveNetInstance(e){const t=e.GetId(),i=e.GetNid();this._domHandler.IsHost()&&!this._hasOverriddenNids&&this._deadNids.push(i),this._idToNetInst.delete(t),this._nidToNetInst.delete(i),this._usedNids.delete(i);const s=this._netInstances.indexOf(e);s>-1&&this._netInstances.splice(s,1)}ClearAllNetInstances(){this._deadNids.length=0,this._idToNetInst.clear(),this._nidToNetInst.clear(),this._usedNids.clear(),this._netInstances.length=0}UpdateData(e,t){this._numberToTransmit=0;for(const e of this._netInstances)e.SetAlive(!1);for(let i=0,s=e.length;i<s;++i){const s=e[i],n=s.uid,o=this.GetNetInstForId(n);o.SetAlive(!0),o.UpdateData(s,t)}for(const e of this._netInstances)e.IsAlive()||ue.push(e);for(const e of ue)this.RemoveNetInstance(e);ue.length=0}WriteData(e,t,i){e.setUint16(t,this._nid),t+=2;let s=0;this._hasOverriddenNids&&(s=1),e.setUint8(t,s),t+=1,e.setUint16(t,this._numberToTransmit),t+=2,e.setUint16(t,this._instanceByteSize),t+=2;for(const s of this._netInstances)s.ShouldTransmit()&&(t=s.WriteData(e,t,i));return t}OverrideNid(e,t){if(this._idToNetInst.has(e))return void console.warn("OverrideNid passed id "+e+" which is already in use and cannot be overridden");if(this._usedNids.has(t))return void console.warn("OverrideNid passed nid "+t+" which is already in use and cannot be overridden");const i=new be(this,e,t);return this._idToNetInst.set(e,i),this._usedNids.add(t),this._netInstances.push(i),this._hasOverriddenNids=!0,i}RemoveObjectId(e){const t=this._idToNetInst.get(e);t&&this.RemoveNetInstance(t)}RemoveObjectNid(e){const t=this._nidToNetInst.get(e);t&&this.RemoveNetInstance(t)}GetRuntimeData(){return{hasOverriddenNids:this.HasOverriddenNids(),netValues:this._netValues.map(e=>e.GetRuntimeData()),netInstances:this._netInstances.map(e=>e.GetRuntimeData())}}GetRuntimeInfoRequest(){return{roId:this._roId,sid:this._sid,netValues:this._netValues.map(e=>e.GetRuntimeData())}}}self.C3NetValue=ve,self.C3NetUpdate=Pe,self.C3RegisteredObject=Ce}{const Ie=self.C3NetUpdate,Re=self.C3NetValue,Oe=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection||window.msRTCPeerConnection,Te=262144,Ae=524288,Ge=65536,Me=16777216;function ke(e){if(e)try{e.close()}catch(e){}}const He=[];function Ne(e,t,i){return e===t?0:(i-e)/(t-e)}function Ee(e){return new Promise(t=>setTimeout(t,e))}class De{constructor(e=1){this._maxParallel=e,this._queue=[],this._activeCount=0}Add(e){return new Promise((t,i)=>{this._queue.push({func:e,resolve:t,reject:i}),this._MaybeStartNext()})}async _MaybeStartNext(){if(!this._queue.length)return;if(this._activeCount>=this._maxParallel)return;this._activeCount++;const e=this._queue.shift();try{const t=await e.func();e.resolve(t)}catch(t){e.reject(t)}this._activeCount--,this._MaybeStartNext()}}class Le{constructor(e,t,i,s,n,o,a,r,d){this._peer=e,this._transferId=t,this._toPeerId=i,this._blob=s,this._size=s.size,this._curOffset=0,this._dataType=n,this._mimeType=o,this._fileName=a,this._tag=r,this._contentMode=d,this._wasCancelled=!1}GetContentMode(){return this._contentMode}GetToPeerId(){return this._toPeerId}GetToPeer(){return this._toPeerId&&this._peer.GetDOMHandler().GetPeerById(this._toPeerId)||this._peer}async SendFragment(){if(this._wasCancelled)return;const e=Ge-12,t=Math.min(e,this._size-this._curOffset),i=this._blob.slice(this._curOffset,this._curOffset+t);this._curOffset+=t;const s=this._curOffset===this._size,n=await i.arrayBuffer();if(this._wasCancelled)return;const o=new ArrayBuffer(n.byteLength+4);return new Uint8Array(o).set(new Uint8Array(n),4),new DataView(o).setUint32(0,this._transferId),await this._peer.Send("o",o,Ue.FLAG_BINARY_TRANSFER),this._wasCancelled?void 0:(s?this._peer.GetDOMHandler()._OnPeerBinaryTransferComplete(this.GetToPeer(),"send",this._transferId,this._dataType,this._mimeType,this._fileName,this._contentMode,this._tag,null):this._peer.GetDOMHandler()._OnPeerBinaryTransferProgress(this.GetToPeer(),"send",this._contentMode,this._tag,this._curOffset/this._size),s)}FireCancelled(){this._wasCancelled=!0,this._peer.GetDOMHandler()._OnPeerBinaryTransferCancelled(this.GetToPeer(),"send",this._transferId,this._contentMode,this._tag)}}class xe{constructor(e,t,i,s,n,o,a,r,d){this._peer=e,this._transferId=t,this._totalSize=i,this._receivedSize=0,this._bigChunks=[],this._smallChunks=[],this._totalSmallChunkSize=0,this._dataType=s,this._mimeType=n,this._fileName=o,this._tag=a,this._contentMode=r,this._fromPeerId=d,this._wasCancelled=!1}GetFromPeerId(){return this._fromPeerId}GetFromPeer(){return this._fromPeerId&&this._peer.GetDOMHandler().GetPeerById(this._fromPeerId)||this._peer}ReceiveFragment(e){if(this._wasCancelled)return;this._smallChunks.push(e),this._totalSmallChunkSize+=e.byteLength,this._receivedSize+=e.byteLength,this._totalSmallChunkSize>=Me&&(this._bigChunks.push(new Blob(this._smallChunks)),this._smallChunks=[],this._totalSmallChunkSize=0);const t=this._receivedSize>=this._totalSize;if(t){const e=[...this._bigChunks,...this._smallChunks];let t;t="arraybuffer"!==this._dataType&&this._fileName?new File(e,this._fileName,{type:this._mimeType}):new Blob(e,{type:this._mimeType}),this._peer.GetDOMHandler()._OnPeerBinaryTransferComplete(this.GetFromPeer(),"receive",this._transferId,this._dataType,this._mimeType,this._fileName,this._contentMode,this._tag,t)}else this._peer.GetDOMHandler()._OnPeerBinaryTransferProgress(this.GetFromPeer(),"receive",this._contentMode,this._tag,this._receivedSize/this._totalSize);return t}FireCancelled(){this._wasCancelled=!0,this._peer.GetDOMHandler()._OnPeerBinaryTransferCancelled(this.GetFromPeer(),"receive",this._transferId,this._contentMode,this._tag)}}class Fe{constructor(e,t,i,s){this._toPeer=e,this._transferId=t,this._totalSize=i,this._relayedSize=0,this._contentMode=s,this._sendQueue=[]}GetContentMode(){return this._contentMode}QueueRelayFragment(e){return!!this._toPeer.WasRemoved()||(this._sendQueue.push(e),this._toPeer._SendSomeBinaryFragments(),!1)}HasData(){return this._sendQueue.length>0}async SendRelayFragment(){if(!this.HasData())return!1;if(this._toPeer.WasRemoved())return!0;const e=this._sendQueue.shift();this._relayedSize+=e.byteLength;const t=this._relayedSize>=this._totalSize,i=new ArrayBuffer(e.byteLength+4);return new Uint8Array(i).set(new Uint8Array(e),4),new DataView(i).setUint32(0,this._transferId),await this._toPeer.Send("o",i,Ue.FLAG_BINARY_TRANSFER),t}}class Ue{constructor(e,t,i){this._domHandler=e,this._id=t,this._nid=0,this._alias=i,this._pc=null,this._dco=null,this._isOOpen=!1,this._dcr=null,this._isROpen=!1,this._dcu=null,this._isUOpen=!1,this._sendThrottle=new De(1),this._receiveThrottle=new De(1),this._firedOpen=!1,this._firedClose=!1,this._wasRemoved=!1,this._hasConfirmed=!1,this._lastHeardFrom=0,this._connectTime=0,this._errorCount=0,this._availableCompressionFormats=[],this._localClientState=[],this._lastStateChange=0,this._lastStateTransmit=0,this._clientStateUpdates=[],this._priorUpdate2=null,this._priorUpdate=null,this._nextUpdate=null,this._lastPingSent=0,this._awaitingPong=!1,this._lastSentPingId=1,this._lastPingTimes=[],this._latency=0,this._pdv=0,this._isSendingBinaryFragments=!1,this._sendingBinaries=new Map,this._receivingBinaries=new Map,this._relayBinaries=new Map,this._domHandler._AddPeer(this)}GetId(){return this._id}GetNid(){return this._nid}_SetNid(e){this._nid=e}GetAlias(){return this._alias}IsHost(){return this===this._domHandler.GetHostPeer()}IsSelf(){return this===this._domHandler.GetSelfPeer()}GetLocalClientState(){return this._localClientState}_SetLastStateChange(e){this._lastStateChange=e}GetLastStateChange(){return this._lastStateChange}_SetLastStateTransmit(e){this._lastStateTransmit=e}GetLastStateTransmit(){return this._lastStateTransmit}GetLatency(){return this._latency}GetPdv(){return this._pdv}GetDOMHandler(){return this._domHandler}_AttachDataChannelHandlers(e,t){e.binaryType="arraybuffer",e.onopen=()=>{"o"===t?this._isOOpen=!0:"r"===t?this._isROpen=!0:"u"===t&&(this._isUOpen=!0),this._MaybeFireOpen()},e.onmessage=e=>{this._OnNetworkMessage(t,e)},e.onerror=e=>{console.error("Peer '"+this._id+"' datachannel '"+t+"' error: ",e),this._domHandler._OnPeerError(this,e),this._domHandler.IsHost()&&!this.IsHost()&&this.Remove("network error")},e.onclose=()=>{this.Remove("disconnect")},"o"===t&&(e.bufferedAmountLowThreshold=Te,e.onbufferedamountlow=()=>this._OnBufferedAmountLow())}Connect(){if(this.IsSelf())return;const e=this._domHandler.IsHost();this._isOOpen=!1,this._isROpen=!1,this._isUOpen=!1,this._firedOpen=!1,this._firedClose=!1,this._connectTime=performance.now(),this._pc=new Oe({iceServers:this._domHandler.GetICEServerList()}),this._pc.onicecandidate=e=>{e.candidate&&this._domHandler.SignallingSend({message:"icecandidate",toclientid:this._id,icecandidate:e.candidate})},this._pc.onsignalingstatechange=()=>{this._pc&&"closed"===this._pc.signalingState&&this.Remove("disconnect")},this._pc.oniceconnectionstatechange=()=>{this._pc&&("failed"!==this._pc.iceConnectionState&&"closed"!==this._pc.iceConnectionState||this.Remove("disconnect"))},this._pc.onconnectionstatechange=()=>{if(!this._pc)return;const e=this._pc.connectionState;"failed"!==e&&"closed"!==e||this.Remove("disconnect")};const t=`c3mp_${this._domHandler.GetCurrentGame()}_${this._domHandler.GetCurrentGameInstance()}_${this._domHandler.GetCurrentRoom()}`;e?(this._nid=this._domHandler.AllocatePeerNid(),this._dco=this._pc.createDataChannel("o",{ordered:!0,protocol:t}),this._AttachDataChannelHandlers(this._dco,"o"),this._dcr=this._pc.createDataChannel("r",{ordered:!1,protocol:t}),this._AttachDataChannelHandlers(this._dcr,"r"),this._dcu=this._pc.createDataChannel("u",{ordered:!1,maxRetransmits:0,protocol:t}),this._AttachDataChannelHandlers(this._dcu,"u"),this._pc.createOffer().then(e=>{this._pc.setLocalDescription(e),this._domHandler.SignallingSend({message:"offer",toclientid:this._id,offer:e})}).catch(e=>{console.error("Host error creating offer for peer '"+this._id+"': ",e),this._domHandler._OnPeerError(this,"could not create offer for peer")})):this._pc.ondatachannel=e=>{if(e.channel.protocol!==t)return console.error("Unexpected datachannel protocol '"+e.channel.protocol+"', should be '"+t+"'"),this._domHandler._OnPeerError(this,"unexpected datachannel protocol '"+e.channel.protocol+"', should be '"+t+"'"),void(this._wasRemoved||(this.Remove("datachannel protocol error"),this._domHandler.OnWasKicked()));const i=e.channel.label;"o"===i?this._dco=e.channel:"r"===i?this._dcr=e.channel:"u"===i?this._dcu=e.channel:(console.error("Unknown datachannel label: "+e.channel.label),this._domHandler._OnPeerError(this,"unknown datachannel label '"+e.channel.label+"'")),this._AttachDataChannelHandlers(e.channel,i)}}async _AddICECandidate(e){if(this._pc)try{await this._pc.addIceCandidate(e)}catch(e){console.warn("[Multiplayer] Error adding ICE candidate: ",e)}}HasPeerConnection(){return!!this._pc}GetPeerConnection(){return this._pc}_MaybeFireOpen(){this._firedOpen||this._isROpen&&this._isUOpen&&this._isOOpen&&(this._OnOpen(),this._firedOpen=!0,this._firedClose=!1)}_OnOpen(){if(this._lastHeardFrom=performance.now(),this._domHandler.IsHost()){this._domHandler.HostBroadcast("o",JSON.stringify({c:"j",i:this._id,n:this._nid,a:this._alias}),0,this),this.Send("o",JSON.stringify({c:"hi",hn:this._domHandler.GetHostPeer().GetNid(),n:this._nid,d:this._domHandler.GetClientDelay(),u:this._domHandler.GetPeerUpdateRateSec(),objs:this._domHandler.GetRegisteredObjectsMap(),cvs:this._domHandler.GetClientValuesJson(),comp:this._domHandler.GetLocalSupportedCompressionFormats()}));for(const e of this._domHandler.peers())!e.IsHost()&&e!==this&&e.IsOpen()&&this.Send("o",JSON.stringify({c:"j",i:e.GetId(),n:e.GetNid(),a:e.GetAlias()}))}else this._hasConfirmed=!0,this.IsHost()&&this.SendPing(performance.now(),!0),this.Send("o",JSON.stringify({c:"comp",comp:this._domHandler.GetLocalSupportedCompressionFormats()}));this._domHandler._OnPeerOpen(this)}_MaybeFireClose(e){!this._firedClose&&this._firedOpen&&(this._OnClose(e),this._firedClose=!0,this._firedOpen=!1)}_OnClose(e){this._domHandler.IsHost()&&!this.IsSelf()&&this._domHandler.HostBroadcast("o",JSON.stringify({c:"l",i:this._id,a:this._alias,r:e}),0,this),this.IsSelf()||this._domHandler._OnPeerClose(this,e)}IsOpen(){return this._firedOpen&&!this._firedClose}TransferBinary(e,t,i,s,n,o,a,r){this._sendingBinaries.set(e,new Le(this,e,t,i,s,n,o,a,r));const d={c:"start-binary-transfer",transferId:e,toPeerId:t,size:i.size,dataType:s,mimeType:n,fileName:o,tag:a,contentMode:r},l="s"===r?Ue.FLAG_SCRIPT_DATA:0;this.Send("o",JSON.stringify(d),l),this._SendSomeBinaryFragments()}_OnBufferedAmountLow(){this._SendSomeBinaryFragments()}async _SendSomeBinaryFragments(){if(this._dco&&this._isOOpen&&!this._isSendingBinaryFragments){this._isSendingBinaryFragments=!0;try{for(;this._dco&&this._isOOpen&&(this._sendingBinaries.size>0||[...this._relayBinaries.values()].some(e=>e.HasData()))&&this._dco.bufferedAmount<Ae;){for(const[e,t]of this._sendingBinaries)await t.SendFragment()&&this._sendingBinaries.delete(e);for(const[e,t]of this._relayBinaries)await t.SendRelayFragment()&&this._relayBinaries.delete(e)}}finally{this._isSendingBinaryFragments=!1}}}_OnReceiveStartBinaryTransferMessage(e){const t=e.transferId,i=e.toPeerId,s=e.contentMode,n=e.size;if(this._domHandler.IsHost()&&i){const o=this._domHandler.GetPeerById(i);if(!o)return void console.warn(`[Multiplayer] Error in host binary transfer relay: peer ID '${i}' not found`);o._relayBinaries.set(t,new Fe(o,t,n,s)),e.fromPeerId=this.GetId();const a="s"===s?Ue.FLAG_SCRIPT_DATA:0;return void o.Send("o",JSON.stringify(e),a)}const o=e.dataType,a=e.mimeType,r=e.fileName,d=e.tag,l=e.fromPeerId;if(this._receivingBinaries.has(t))return void console.error(`[Multiplayer] Error receiving binary: transfer ID ${t} already in use`);this._receivingBinaries.set(t,new xe(this,t,n,o,a,r,d,s,l));let h=this;l&&(h=this._domHandler.GetPeerById(l)??this),this._domHandler._OnPeerBinaryTransferStart(h,t,a,r,n,s,d)}_OnBinaryTransferFragment(e,t){const i=new DataView(e,t).getUint32(0),s=e.slice(t+4);if(this._domHandler.IsHost()){const e=this._domHandler._GetRelayPeerForTransferId(i);if(e)return void e._relayBinaries.get(i).QueueRelayFragment(s)}const n=this._receivingBinaries.get(i);n?n.ReceiveFragment(s)&&this._receivingBinaries.delete(i):console.error(`[Multiplayer] Error receiving binary: received fragment for invalid transfer ID ${i}`)}_HasRelayTransferId(e){return this._relayBinaries.has(e)}CancelBinaryTransfer(e,t){const i=this._sendingBinaries.get(e);if(!i)return;const s={c:"cancel-binary-transfer",transferId:e,toPeerId:t},n="s"===i.GetContentMode()?Ue.FLAG_SCRIPT_DATA:0;this.Send("o",JSON.stringify(s),n),i.FireCancelled(),this._sendingBinaries.delete(e)}_OnReceiveCancelBinaryTransferMessage(e){const t=e.transferId,i=e.toPeerId;if(this._domHandler.IsHost()&&i){const s=this._domHandler.GetPeerById(i);if(!s)return;const n=s._relayBinaries.get(t);if(!n)return;const o="s"===n.GetContentMode()?Ue.FLAG_SCRIPT_DATA:0;return void s.Send("o",JSON.stringify(e),o)}const s=this._receivingBinaries.get(t);s&&(s.FireCancelled(),this._receivingBinaries.delete(t))}_DetermineSupportedCompressionFormats(e){const t=this._domHandler.GetLocalSupportedCompressionFormats();for(const i of e)t.includes(i)&&this._availableCompressionFormats.push(i)}async _MaybeCompress(e){if(0===this._availableCompressionFormats.length)return{compressionType:0,data:e};const t=new Blob([e]);if(t.size<64)return{compressionType:0,data:e};const i=this._availableCompressionFormats[0],s=new CompressionStream(i),n=t.stream().pipeThrough(s),o=await new Response(n).arrayBuffer();if(o.byteLength>=t.size)return{compressionType:0,data:e};{const e=Ue.COMPRESSION_TYPES.indexOf(i);if(e<0)throw new Error("invalid compression type");return{compressionType:e,data:o}}}async Send(e,t,i=0){this._domHandler.StatAddOutboundDecompressedBandwidthCount(t);const s=this._PrepareSend(e,t,i);let n=s;"o"===e&&(n=this._sendThrottle.Add(()=>s));const o=await n;o&&this._NetworkSend(e,o)}async _PrepareSend(e,t,i=0){const s="string"==typeof t,{compressionType:n,data:o}=await this._MaybeCompress(t);let a=o;if(o instanceof ArrayBuffer){0!==n&&(i|=n<<4,s&&(i|=Ue.FLAG_STRING_DATA));const e=new ArrayBuffer(o.byteLength+8),t=new DataView(e);t.setUint32(0,Ue.MAGIC_NUMBER),t.setUint32(4,i),new Uint8Array(e,8).set(new Uint8Array(o)),a=e}this._domHandler.StatIncOutboundCount(),this._domHandler.StatAddOutboundBandwidthCount(a);const r=this._domHandler.GetSimulatedPacketLoss(),d=this._domHandler.GetSimulatedLatency(),l=this._domHandler.GetSimulatedPdv();if(r>0&&"u"===e&&Math.random()<r)return null;if(0!==d||0!==l){let t=1;"u"!==e&&Math.random()<r&&(t=3),await Ee((d+Math.random()*l)*t)}return a}_NetworkSend(e,t){try{"o"===e?this._isOOpen&&this._dco&&this._dco.send(t):"r"===e?this._isROpen&&this._dcr&&this._dcr.send(t):"u"===e&&this._isUOpen&&this._dcu&&this._dcu.send(t)}catch(i){if(this._wasRemoved)return;this._domHandler.IsHost()?"o"===e||"r"===e?("string"==typeof t?(console.error("Error sending "+t.length+"-char string on '"+e+"' to '"+this._alias+"', host kicking: ",i),console.log("String that failed to send from previous error was: "+t)):console.error("Error sending "+(t.length||t.byteLength)+"-byte binary on '"+e+"' to '"+this._alias+"', host kicking: ",i),this.Remove("network error")):(this._errorCount++,this._errorCount>=10&&("string"==typeof t?(console.error("Too many errors ("+this._errorCount+") sending data on '"+e+"' to '"+this._alias+"', kicking; last error was for sending "+t.length+"-char string: ",i),console.log("String that failed to send from previous error was: "+t)):console.error("Too many errors ("+this._errorCount+") sending data on '"+e+"' to '"+this._alias+"', kicking; last error was for sending "+(t.length||t.byteLength)+"-byte binary: ",i),this.Remove("network error"))):console.error("Error sending data on '"+e+"': ",i)}}SendPing(e,t){if(!this._wasRemoved){if(!t&&!this.IsOpen()&&this._pc&&e-this._connectTime>25e3)return console.warn("Timed out '"+this._alias+"', could not establish connection after 25sec"),void this.Remove("timeout");if(!t&&this.IsOpen()&&e-this._lastHeardFrom>2e4)return console.warn("Timed out '"+this._alias+"', not heard from for 20sec"),void this.Remove("timeout");this._lastPingSent=e,this._awaitingPong=!0,this._lastSentPingId++,this.Send("u","ping:"+this._lastSentPingId)}}SendPong(e){let t="pong:"+e.substr(5);this._domHandler.IsHost()&&(t+="/",t+=Math.round(performance.now()).toString()),this.Send("u",t)}_OnPong(e){if(!this._awaitingPong)return;const t=e.indexOf(":");if(!(t>-1))return void console.warn("Cannot parse off ping ID from pong");if(parseFloat(e.substr(t+1))!==this._lastSentPingId)return;const i=performance.now();this._awaitingPong=!1;const s=(i-this._lastPingSent)/2;this._lastPingTimes.push(s),this._lastPingTimes.length>10&&this._lastPingTimes.shift(),He.push(...this._lastPingTimes),He.sort((e,t)=>e-t),this._pdv=He[He.length-1]-He[0];let n=0,o=He.length;He.length>=4&&He.length<=6?(++n,--o):He.length>6&&(n+=2,o-=2);let a=0;for(let e=n;e<o;++e)a+=He[e];if(this._latency=a/(o-n),He.length=0,!this._domHandler.IsHost()){const t=e.indexOf("/");if(t>-1){const n=parseFloat(e.substr(t+1));isFinite(n)?this._domHandler.AddHostTime(n,i,s,this._latency):console.warn("Invalid host time from pong response")}else console.warn("Cannot parse off host time from pong response")}}async _OnNetworkMessage(e,t){const i=this._PrepareReceive(e,t.data);let s=i;"o"===e&&(s=this._receiveThrottle.Add(()=>i));const n=await s;n&&this._HandleReceivedMessage(e,n)}async _PrepareReceive(e,t){this._domHandler.StatIncInboundCount(),this._domHandler.StatAddInboundBandwidthCount(t);const i=this._domHandler.GetSimulatedPacketLoss(),s=this._domHandler.GetSimulatedLatency(),n=this._domHandler.GetSimulatedPdv();if(i>0&&"u"===e&&Math.random()<i)return null;if(0!==s||0!==n){let t=1;"u"!==e&&Math.random()<i&&(t=3),await Ee(s*t+Math.random()*n*t)}return t instanceof ArrayBuffer?await this._ReadBinaryHeaderAndMaybeDecompress(t):t}async _ReadBinaryHeaderAndMaybeDecompress(e){if(e.byteLength<8)return console.warn(`Rejected binary message as too small (only ${e.byteLength} bytes)`),null;const t=new DataView(e),i=t.getUint32(0),s=t.getUint32(4);if(i!==Ue.MAGIC_NUMBER)return console.warn(`Rejected binary message with invalid magic number (0x${i.toString(16)})`),null;const n=(s&Ue.FLAG_COMPRESSION_MASK)>>4;if(0===n)return{data:e,offset:8,flags:s};{if(n>=Ue.COMPRESSION_TYPES.length)throw new Error("invalid compression type");const t=Ue.COMPRESSION_TYPES[n],i=new Blob([new Uint8Array(e,8)]),o=new DecompressionStream(t),a=i.stream().pipeThrough(o),r=await new Response(a).arrayBuffer();return 0===(s&Ue.FLAG_STRING_DATA)?{data:r,offset:0,flags:s}:(new TextDecoder).decode(r)}}_HandleReceivedMessage(e,t){if(!this._wasRemoved){if(this._lastHeardFrom=performance.now(),"string"==typeof t){if(this._domHandler.StatAddInboundDecompressedBandwidthCount(t),""===t.trim()||t.length<4)return;const s=t.substr(0,4);if("ping"===s)return void this.SendPong(t);if("pong"===s)return void this._OnPong(t);var i;try{i=JSON.parse(t)}catch(e){return this._domHandler._OnPeerError(this,e),this._domHandler.IsHost()?(console.error("Error parsing message as JSON for peer '"+this._id+"', host kicking: ",e),this.Remove("data error")):console.error("Error parsing message as JSON for peer '"+this._id+"': ",e),void console.log("String that failed to parse from previous error: "+t)}if(!i)return;try{i.c&&"m"!==i.c?this._OnControlMessage(i):this._domHandler._OnPeerMessage(this,i,e)}catch(e){this._domHandler._OnPeerError(this,e),this._domHandler.IsHost()?(console.error("Error handling message for peer '"+this._id+"', host kicking: ",e),this.Remove("data error")):console.error("Error handling message for peer '"+this._id+"': ",e)}return}this._domHandler.StatAddInboundDecompressedBandwidthCount(t.data),!this._hasConfirmed&&this._domHandler.IsHost()&&"u"===e&&(this._hasConfirmed=!0,this._domHandler.SignallingConfirmPeer(this._id));try{const i=t.data,s=t.offset,n=t.flags;this._OnBinaryMessage(i,s,n,e)}catch(e){return this._domHandler._OnPeerError(this,e),void(this._domHandler.IsHost()?(console.error("Error handling binary update for peer '"+this._id+"', host kicking: ",e),this.Remove("data error")):console.error("Error handling binary update for peer '"+this._id+"': ",e))}}}_OnControlMessage(e){let t,i;switch(e.c){case"disconnect":e.k&&this._domHandler.OnWasKicked(),i=!this._domHandler.IsHost()&&!this.IsHost(),this.Remove(e.r),i&&this._domHandler.SignallingLeaveRoom();break;case"hi":this._domHandler.IsHost()||(this._domHandler.GetHostPeer()._SetNid(e.hn),this._domHandler.GetSelfPeer()._SetNid(e.n),this._domHandler.SetClientDelay(e.d),this._domHandler.SetPeerUpdateRateSec(e.u),this._domHandler.MapObjectNids(e.objs),this._domHandler.MapClientValues(e.cvs),e.hasOwnProperty("comp")&&this._DetermineSupportedCompressionFormats(e.comp));break;case"comp":this._DetermineSupportedCompressionFormats(e.comp);break;case"j":this._domHandler.IsHost()||(t=new Ue(this._domHandler,e.i,e.a),t._SetNid(e.n),this._domHandler._OnPeerOpen(t));break;case"l":this._domHandler.IsHost()||(t=this._domHandler.GetPeerById(e.i),t&&(t.IsSelf()||this._domHandler._OnPeerClose(t,e.r),t.Remove(e.r)));break;case"start-binary-transfer":this._OnReceiveStartBinaryTransferMessage(e);break;case"cancel-binary-transfer":this._OnReceiveCancelBinaryTransferMessage(e);break;default:console.error("Unknown control message from peer '"+this._id+"': "+e.c),this._domHandler._OnPeerError(this,"unknown control message '"+e.c+"'")}}_OnBinaryMessage(e,t,i,s){if(0!==(i&Ue.FLAG_BINARY_TRANSFER))this._OnBinaryTransferFragment(e,t);else if(0!==(i&(Ue.FLAG_SCRIPT_DATA|Ue.FLAG_EVENT_DATA))){const n=0!==(i&Ue.FLAG_EVENT_DATA)?"e":"s";this._domHandler._OnPeerBinaryMessage(this,0===t?e:e.slice(t),s,n)}else{const s=new DataView(e,t);this._domHandler.IsHost()?this._OnHostUpdate(s,i):this._OnPeerUpdate(s,i)}}_OnHostUpdate(e,t){let i=0,s=e.getFloat64(i);if(i+=8,s+=this._latency,Math.abs(s-performance.now())>=3e3)return;const n=e.getUint8(i);i+=1;const o=[],a=this._domHandler.GetClientValues();for(let t=0;t<n;++t){if(t>=a.length){o.push(0);continue}const s=a[t];let n=0;switch(s.GetPrecision()){case 0:n=e.getFloat64(i),i+=8;break;case 1:default:n=e.getFloat32(i),i+=4;break;case 2:n=s.MaybeUnpack(e.getInt16(i)),i+=2;break;case 3:n=s.MaybeUnpack(e.getUint8(i)),i+=1}o.push(n)}this._AddClientUpdate(s,o)}_AddClientUpdate(e,t){for(let i=0,s=this._clientStateUpdates.length;i<s;++i){const s=this._clientStateUpdates[i];if(s.timestamp===e)return;if(s.timestamp>e)return void this._clientStateUpdates.splice(i,0,new Ie(e,t))}this._clientStateUpdates.push(new Ie(e,t))}Tick(e){if(0!==this._clientStateUpdates.length){for(;this._clientStateUpdates.length>2&&this._clientStateUpdates[0]!==this._priorUpdate2&&this._clientStateUpdates[0]!==this._priorUpdate&&this._clientStateUpdates[0]!==this._nextUpdate;)this._clientStateUpdates.shift();if(!(this._nextUpdate&&this._nextUpdate.timestamp>e&&this._priorUpdate&&this._priorUpdate.timestamp<e)){this._nextUpdate=null;for(let t=0,i=this._clientStateUpdates.length;t<i;++t){const i=this._clientStateUpdates[t];if(!(i.timestamp<=e)){this._nextUpdate=i;break}(!this._priorUpdate||i.timestamp>this._priorUpdate.timestamp)&&(this._priorUpdate2=this._priorUpdate,this._priorUpdate=i)}}}}_OnPeerUpdate(e,t){0===(t&Ue.FLAG_HOST_UPDATE_TYPE)?this._HandlePeerUpdate(e):this._HandlePeerEvents(e)}_HandlePeerUpdate(e){let t=0;const i=e.getFloat64(t);t+=8;const s=e.getUint16(t);t+=2;for(let n=0;n<s;++n){const s=e.getUint16(t);t+=2;const n=e.getUint8(t);t+=1;let o=null,a=0;const r=this._domHandler.GetRegisteredObjectByNid(s);r?(o=r.GetNetValues(),a=o.length,1===n&&r._SetHasOverriddenNids(!0)):console.warn("Don't know which object corresponds to NID "+s);const d=e.getUint16(t);t+=2;const l=e.getUint16(t);t+=2;for(let s=0;s<d;++s){const s=e.getUint16(t);if(t+=2,r){const n=[];let d=t;for(let t=0;t<a;++t){const i=o[t];let s=0;switch(i.GetPrecision()){case 0:s=e.getFloat64(d),d+=8;break;case 1:default:s=e.getFloat32(d),d+=4;break;case 2:s=i.MaybeUnpack(e.getInt16(d)),d+=2;break;case 3:s=i.MaybeUnpack(e.getUint8(d)),d+=1}n.push(s)}r.AddUpdate(i,s,n)}t+=l}}}_HandlePeerEvents(e){let t=0;const i=e.getFloat64(t);t+=8;const s=e.getUint16(t);t+=2;for(let n=0;n<s;++n){const s=e.getUint16(t);t+=2;const n=this._domHandler.GetRegisteredObjectByNid(s);n||console.warn("Don't know which object corresponds to NID "+s);const o=e.getUint16(t);t+=2;for(let s=0;s<o;++s){const s=e.getUint16(t);t+=2,n&&(n.HasOverriddenNids()||(this._domHandler._OnInstanceDestroyed(n,s,i),n.RemoveObjectNid(s)))}}}Remove(e,t){if(!this._wasRemoved){this._wasRemoved=!0;for(const e of this._sendingBinaries.values())e.FireCancelled();this._sendingBinaries.clear();for(const e of this._receivingBinaries.values())e.FireCancelled();this._receivingBinaries.clear(),this._relayBinaries.clear(),this._MaybeFireClose(e),this.Send("o",JSON.stringify({c:"disconnect",r:e,k:!!t})).then(()=>{const e=this._dco,t=this._dcr,i=this._dcu,s=this._pc;setTimeout(()=>{ke(e),ke(t),ke(i),ke(s)},1),this._dco=null,this._dcr=null,this._dcu=null,this._pc=null,this._isOOpen=!1,this._isROpen=!1,this._isUOpen=!1}),this._domHandler._RemovePeer(this)}}_OnPeerRemoved(e){for(const[t,i]of this._sendingBinaries)i.GetToPeerId()===e.GetId()&&(i.FireCancelled(),this._sendingBinaries.delete(t));for(const[t,i]of this._receivingBinaries)i.GetFromPeerId()===e.GetId()&&(i.FireCancelled(),this._receivingBinaries.delete(t))}WasRemoved(){return this._wasRemoved}HasClientState(e){return this._domHandler.HasClientValueTag(e)}GetClientState(e){const t=this._domHandler.GetClientValueByTag(e);if(!t)return 0;const i=t.GetIndex();if(0===this._clientStateUpdates.length)return 0;const s=this._clientStateUpdates[this._clientStateUpdates.length-1].data;return i<0||i>=s.length?0:s[i]}GetInterpClientState(e){const t=e.GetIndex();if(!this._nextUpdate&&!this._priorUpdate)return 0;if(this._nextUpdate&&!this._priorUpdate){const e=this._nextUpdate.data;return t<0||t>=e.length?0:e[t]}const i=this._domHandler.GetSimulationTime();let s,n,o,a,r;if(!this._nextUpdate&&this._priorUpdate){if(this._priorUpdate2){s=this._priorUpdate2.timestamp,n=this._priorUpdate2.data[t],o=this._priorUpdate.timestamp,a=this._priorUpdate.data[t];let e=i;return e>this._priorUpdate.timestamp+250&&(e=this._priorUpdate.timestamp+250),r=Ne(s,o,e),Re.InterpNetValue(this._domHandler.GetClientValues()[t].GetInterp(),n,a,r,!0)}{const e=this._priorUpdate.data;return t<0||t>=e.length?0:e[t]}}return s=this._priorUpdate.timestamp,n=this._priorUpdate.data[t],o=this._nextUpdate.timestamp,a=this._nextUpdate.data[t],r=Ne(s,o,i),Re.InterpNetValue(this._domHandler.GetClientValues()[t].GetInterp(),n,a,r,!1)}}Ue.MAGIC_NUMBER=1664314736,Ue.FLAG_HOST_UPDATE_TYPE=1,Ue.FLAG_STRING_DATA=2,Ue.FLAG_SCRIPT_DATA=4,Ue.FLAG_BINARY_TRANSFER=8,Ue.FLAG_COMPRESSION_MASK=240,Ue.FLAG_EVENT_DATA=256,Ue.COMPRESSION_TYPES=["none","deflate","gzip"],self.C3Peer=Ue}{const Be=self.C3NetValue,We=self.C3Peer,Ve="multiplayer",je=window.RTCPeerConnection||window.webkitRTCPeerConnection||window.mozRTCPeerConnection||window.msRTCPeerConnection,ze=window.RTCSessionDescription||window.webkitRTCSessionDescription||window.mozRTCSessionDescription||window.msRTCSessionDescription,qe=window.RTCIceCandidate||window.webkitRTCIceCandidate||window.mozRTCIceCandidate||window.msRTCIceCandidate,Ke=window.RTCDataChannel||window.webkitRTCDataChannel||window.mozRTCDataChannel||window.msRTCDataChannel,Ye="c2multiplayer",Xe=1,Je=2,$e=[{urls:"stun:stun.l.google.com:19302"}];function Ze(e){if("undefined"==typeof CompressionStream||"function"!=typeof Blob.prototype.stream)return!1;try{return new CompressionStream(e),!0}catch(e){return!1}}function Qe(e){return"number"==typeof e.byteLength?e.byteLength:"number"==typeof e.length?e.length:(console.warn("[Construct] Multiplayer: don't know how to measure size of data: ",e),0)}const et=[];Ze("deflate")&&et.push("deflate"),Ze("gzip")&&et.push("gzip");const tt=1,it=2;let st=!1;const nt=[],ot=class extends self.DOMHandler{constructor(e){super(e,Ve),this._iceServers=[],this._sigWs=null,this._isSignallingConnected=!1,this._isSignallingLoggedIn=!1,this._sigservInfo={protocolrev:0,version:0,name:"",operator:"",motd:""},this._myId="",this._myAlias="",this._game="",this._gameInstance="",this._room="",this._allPeers=[],this._peersById=new Map,this._nextPeerNid=0,this._usedPeerNids=new Set,this._selfPeer=null,this._hostPeer=null,this._clientDelay=80,this._hostUpdateRateSec=30,this._peerUpdateRateSec=30,this._lastUpdateTime=0,this._stats={lastSecondTime:0,outboundPerSec:0,outboundCount:0,outboundBandwidthPerSec:0,outboundDecompressedBandwidthPerSec:0,outboundBandwidthCount:0,outboundDecompressedBandwidthCount:0,inboundPerSec:0,inboundCount:0,inboundBandwidthPerSec:0,inboundDecompressedBandwidthPerSec:0,inboundBandwidthCount:0,inboundDecompressedBandwidthCount:0},this._dataBuffer=new ArrayBuffer(262144),this._dataView=new DataView(this._dataBuffer),this._allRegisteredObjects=[],this._nextObjectNid=1,this._registeredObjectsByNid=new Map,this._registeredObjectsByRoId=new Map,this._simLatency=0,this._simPdv=0,this._simPacketLoss=0,this._lastTimeDiffs=[],this._targetHostTimeDiff=0,this._hostTimeDiff=0,this._targetSimDelay=this._clientDelay,this._simDelay=this._clientDelay,this._allClientValues=[],this._clientValuesByTag=new Map,this._receivedClientValues=!1,this._signallingPromises={connect:{resolve:null,reject:null},login:{resolve:null,reject:null},joinRoom:{resolve:null,reject:null},leaveRoom:{resolve:null,reject:null},listGameInstances:{resolve:null,reject:null},listRooms:{resolve:null,reject:null}},this._MergeICEServerList($e),setInterval(()=>this._DoPings(),2e3),window.addEventListener("unload",()=>this.RemoveAllPeers("quit")),this.AddRuntimeMessageHandler("get-supported",()=>this._OnGetSupported()),this.AddRuntimeMessageHandler("add-ice-servers",e=>this._MergeICEServerList(e.list)),this.AddRuntimeMessageHandler("simulate-latency",e=>this.SetLatencySimulation(e.latency,e.pdv,e.loss)),this.AddRuntimeMessageHandler("set-bandwidth-profile",e=>this.SetBandwidthSettings(e.updateRate,e.delay)),this.AddRuntimeMessageHandler("tick",e=>this.Tick(e)),this.AddRuntimeMessageHandler("alert",e=>this.Alert(e)),this.AddRuntimeMessageHandler("signalling-connect",e=>this.SignallingConnect(e.url)),this.AddRuntimeMessageHandler("signalling-disconnect",()=>this.SignallingDisconnect()),this.AddRuntimeMessageHandler("signalling-login",e=>this.SignallingLogin(e.alias)),this.AddRuntimeMessageHandler("signalling-join-room",e=>this.SignallingJoinGameRoom(e.game,e.instance,e.room,e.maxClients)),this.AddRuntimeMessageHandler("signalling-auto-join-room",e=>this.SignallingAutoJoinGameRoom(e.game,e.instance,e.room,e.maxClients,e.lock)),this.AddRuntimeMessageHandler("signalling-leave-room",()=>this.SignallingLeaveRoom()),this.AddRuntimeMessageHandler("signalling-list-game-instances",e=>this.SignallingRequestGameInstanceList(e.game)),this.AddRuntimeMessageHandler("signalling-list-rooms",e=>this.SignallingRequestRoomList(e.game,e.instance,e.which)),this.AddRuntimeMessageHandler("disconnect-room",()=>this.DisconnectRoom(!0)),this.AddRuntimeMessageHandler("peer-send-message",e=>this.OnPeerSendMessage(e)),this.AddRuntimeMessageHandler("host-broadcast",e=>this.OnHostBroadcast(e)),this.AddRuntimeMessageHandler("peer-transfer-binary",e=>this.OnPeerTransferBinary(e)),this.AddRuntimeMessageHandler("peer-cancel-binary-transfer",e=>this.OnCancelBinaryTransfer(e)),this.AddRuntimeMessageHandler("kick-peer",e=>this.OnKickPeer(e)),this.AddRuntimeMessageHandler("sync-object",e=>this.OnSyncObject(e)),this.AddRuntimeMessageHandler("sync-inst-var",e=>this.OnSyncInstVar(e)),this.AddRuntimeMessageHandler("associate-object",e=>this.OnAssociateObject(e)),this.AddRuntimeMessageHandler("remove-object-id",e=>this.RemoveObjectId(e.uid)),this.AddRuntimeMessageHandler("remove-net-insts",e=>this.OnRemoveNetInsts(e)),this.AddRuntimeMessageHandler("remove-object-nid",e=>this.OnRemoveObjectNid(e)),this.AddRuntimeMessageHandler("set-client-state",e=>this.SetClientState(e.tag,e.value)),this.AddRuntimeMessageHandler("add-client-input-value",e=>this.AddClientInputValue(e.tag,e.precision,e.interp))}_GetErrorMessage(e){return e?"string"==typeof e?e:"string"==typeof e.message?e.message:"string"==typeof e.details?e.details:"string"==typeof e.data?e.data:"string"==typeof e.type?e.type:"unknown error":"unknown error"}IsConnected(){return this._isSignallingConnected}IsLoggedIn(){return this.IsConnected()&&this._isSignallingLoggedIn}IsInRoom(){return!!this._room}IsHost(){return this.IsInRoom()&&this._selfPeer&&this._hostPeer===this._selfPeer}GetMyId(){return this._myId}GetMyAlias(){return this._myAlias}GetCurrentGame(){return this._game}GetCurrentGameInstance(){return this._gameInstance}GetCurrentRoom(){return this._room}GetHostId(){return this._hostPeer?this._hostPeer.GetId():""}GetHostAlias(){return this._hostPeer?this._hostPeer.GetAlias():""}GetHostPeer(){return this._hostPeer}GetSelfPeer(){return this._selfPeer}SetLatencySimulation(e,t,i){this._simLatency=Math.max(e,0),this._simPdv=Math.max(t,0),this._simPacketLoss=Math.max(i,0)}GetSimulatedPacketLoss(){return this._simPacketLoss}GetSimulatedLatency(){return this._simLatency}GetSimulatedPdv(){return this._simPdv}_OnGetSupported(){return{isSupported:!(!je||!Ke)}}_CreateSignallingPromise(e){return e.reject&&e.reject("overlapping signalling operation"),new Promise((t,i)=>{e.resolve=t,e.reject=i})}_ResolveSignallingPromise(e,t){e.resolve&&e.resolve(t),e.resolve=null,e.reject=null}_RejectSignallingPromises(e){for(const t of Object.values(this._signallingPromises))t.reject&&t.reject(e),t.resolve=null,t.reject=null}SignallingConnect(e){if(this._sigWs||this._isSignallingConnected)return Promise.resolve();const t=this._CreateSignallingPromise(this._signallingPromises.connect);try{this._sigWs=new WebSocket(e,Ye)}catch(e){return this._sigWs=null,this._OnSignallingError(e),t}return this._sigWs.onopen=()=>{if(-1===this._sigWs.protocol.indexOf(Ye))return this._OnSignallingError("server does not support '"+Ye+"' protocol"),this._sigWs.close(1002,"'"+Ye+"' protocol required"),this._sigWs=null,void(this._isSignallingConnected=!1);this._isSignallingConnected=!0},this._sigWs.onclose=e=>{this._OnSignallingClose(),this._isSignallingConnected=!1,this._isSignallingLoggedIn=!1,this._sigWs=null},this._sigWs.onerror=e=>{console.error("Signalling server error: ",e),this._OnSignallingError(e)},this._sigWs.onmessage=e=>{this._OnSignallingMessage(e)},t}SignallingDisconnect(){this._sigWs&&this._isSignallingConnected&&(this._sigWs.close(),this._sigWs=null,this._isSignallingConnected=!1)}_OnSignallingMessage(e){let t;try{t=JSON.parse(e.data)}catch(e){return void this._OnSignallingError(e)}switch(t.message){case"welcome":this._OnSignallingReceiveWelcome(t);break;case"login-ok":this._OnSignallingReceiveLoginOK(t);break;case"join-ok":this._OnSignallingReceiveJoinOK(t);break;case"leave-ok":this._OnSignallingReceiveLeaveOK(t);break;case"kicked":this._OnSignallingReceiveKicked(t);break;case"peer-joined":this._OnSignallingReceivePeerJoined(t);break;case"peer-quit":this._OnSignallingReceivePeerQuit(t);break;case"icecandidate":this._OnSignallingReceiveIceCandidate(t);break;case"offer":this._OnSignallingReceiveOffer(t);break;case"answer":this._OnSignallingReceiveAnswer(t);break;case"instance-list":this._OnSignallingReceiveInstanceList(t);break;case"room-list":this._OnSignallingReceiveRoomList(t);break;case"error":this._OnSignallingError(t.details);break;default:this._OnSignallingError("received unknown signalling message")}}HasICEServerUrl(e){for(const t of this._iceServers)if(t.urls===e.urls)return!0;return!1}_MergeICEServerList(e){if(e)for(let t of e)"string"==typeof t&&(t={urls:t}),this.HasICEServerUrl(t)||(t.hasOwnProperty("url")||(t.url=t.urls),this._iceServers.push(t))}GetICEServerList(){return this._iceServers}_OnSignallingError(e){this.PostToRuntime("signalling-error",{message:this._GetErrorMessage(e)}),this._RejectSignallingPromises(e)}_OnSignallingClose(){this.PostToRuntime("signalling-close")}_OnSignallingReceiveWelcome(e){if(e.protocolrev<1||e.protocolrev>Xe)return this._OnSignallingError("signalling server protocol revision not supported"),void this.SignallingDisconnect();this._myId=e.clientid,this._room="";const t=this._sigservInfo;t.protocolrev=e.protocolrev,t.version=e.version,t.name=e.name,t.operator=e.operator,t.motd=e.motd,this._MergeICEServerList(e.ice_servers),this.PostToRuntime("signalling-welcome",{myid:this._myId,sigservinfo:{protocolrev:t.protocolrev,version:t.version,name:t.name,operator:t.operator,motd:t.motd}}),this._ResolveSignallingPromise(this._signallingPromises.connect)}_OnSignallingReceiveLoginOK(e){this._myAlias=e.alias,this._isSignallingLoggedIn=!0,this.PostToRuntime("signalling-login-ok",{myalias:this._myAlias}),this._ResolveSignallingPromise(this._signallingPromises.login)}GetNextObjectNid(){return this._nextObjectNid++}AllocatePeerNid(){if(!this.IsHost())return;do{this._nextPeerNid++,this._nextPeerNid>65535&&(this._nextPeerNid=0)}while(this._usedPeerNids.has(this._nextPeerNid));const e=this._nextPeerNid;return this._usedPeerNids.add(e),e}FreePeerNid(e){this.IsHost()&&this._usedPeerNids.delete(e)}_OnSignallingReceiveJoinOK(e){this.RemoveAllPeers("disconnect"),this._game=e.game,this._gameInstance=e.instance,this._room=e.room,this._selfPeer=new We(this,this._myId,this._myAlias),e.host?(this._hostPeer=this._selfPeer,this._nextPeerNid=0,this._usedPeerNids.clear(),this._hostPeer._SetNid(this.AllocatePeerNid())):(this._lastTimeDiffs.length=0,this._targetHostTimeDiff=0,this._hostTimeDiff=0,this._clientDelay=80,this._hostUpdateRateSec=30,this._peerUpdateRateSec=30,this._targetSimDelay=this._clientDelay,this._simDelay=this._clientDelay,this._hostPeer=new We(this,e.hostid,e.hostalias),this._hostPeer.Connect()),this.PostToRuntime("signalling-join-ok",{isHost:!!e.host,hostId:this._hostPeer.GetId(),hostAlias:this._hostPeer.GetAlias(),game:this._game,gameInstance:this._gameInstance,room:this._room}),this._ResolveSignallingPromise(this._signallingPromises.joinRoom)}_OnSignallingReceiveLeaveOK(e){this._room="",this.PostToRuntime("signalling-leave-ok"),this._ResolveSignallingPromise(this._signallingPromises.leaveRoom)}_OnSignallingReceiveKicked(e){"host-left"===e.reason?this.SignallingDisconnect():(this.DisconnectRoom(),this._room="",this.PostToRuntime("signalling-kicked"))}_OnSignallingReceivePeerJoined(e){if(!this._isSignallingLoggedIn||!this._room||!this.IsHost())return;const t=this._peersById.get(e.peerid);t&&t.Remove("rejoin"),new We(this,e.peerid,e.peeralias).Connect()}_OnSignallingReceivePeerQuit(e){if(!this._isSignallingLoggedIn||!this._room||!this.IsHost())return;const t=this._peersById.get(e.id);t&&t.Remove(e.reason)}_OnSignallingReceiveIceCandidate(e){if(!this._isSignallingLoggedIn||!this._room)return;const t=this._peersById.get(e.from);t&&t._AddICECandidate(new qe(e.icecandidate))}_OnSignallingReceiveOffer(e){if(!this._isSignallingLoggedIn||!this._room||this.IsHost()||!this._selfPeer||!this._hostPeer||!this._hostPeer.HasPeerConnection())return;if(e.from!==this._hostPeer.GetId())return;const t=this._hostPeer.GetPeerConnection();t.setRemoteDescription(new ze(e.offer)).then(()=>{t.createAnswer().then(e=>{t.setLocalDescription(e),this.SignallingSend({message:"answer",toclientid:this._hostPeer.GetId(),answer:e})}).catch(e=>{console.error("Peer error creating answer: ",e),this._OnPeerError(this._selfPeer,"could not create answer to host offer")})}).catch(e=>{console.error("Peer error setting remote description: ",e),this._OnPeerError(this._selfPeer,"could not set remote description")})}_OnSignallingReceiveAnswer(e){if(!this._isSignallingLoggedIn||!this._room||!this.IsHost())return;const t=this._peersById.get(e.from);t&&t.GetPeerConnection().setRemoteDescription(new ze(e.answer)).catch(e=>{console.error("Host error setting remote description: ",e)})}_OnSignallingReceiveInstanceList(e){this.PostToRuntime("signalling-instance-list",{list:e.list}),this._ResolveSignallingPromise(this._signallingPromises.listGameInstances)}_OnSignallingReceiveRoomList(e){this.PostToRuntime("signalling-room-list",{list:e.list}),this._ResolveSignallingPromise(this._signallingPromises.listRooms)}SignallingSend(e){this._sigWs&&this._isSignallingConnected&&this._sigWs.send(JSON.stringify(e))}SignallingLogin(e){if(this._isSignallingLoggedIn)return;const t=this._CreateSignallingPromise(this._signallingPromises.login);return this.SignallingSend({message:"login",protocolrev:Xe,datachannelrev:Je,compressionformats:this.GetLocalSupportedCompressionFormats(),alias:e}),t}SignallingJoinGameRoom(e,t,i,s){if(!this._isSignallingLoggedIn||this._room)return;const n=this._CreateSignallingPromise(this._signallingPromises.joinRoom);return this.SignallingSend({message:"join",game:e,instance:t,room:i,max_clients:s}),n}SignallingAutoJoinGameRoom(e,t,i,s,n){if(!this._isSignallingLoggedIn||this._room)return;const o=this._CreateSignallingPromise(this._signallingPromises.joinRoom);return this.SignallingSend({message:"auto-join",game:e,instance:t,room:i,max_clients:s,lock_when_full:n}),o}SignallingLeaveRoom(){if(!this._isSignallingLoggedIn)return;const e=this._CreateSignallingPromise(this._signallingPromises.leaveRoom);return this.SignallingSend({message:"leave"}),e}SignallingConfirmPeer(e){this._isSignallingLoggedIn&&this.IsHost()&&this.SignallingSend({message:"confirm-peer",id:e})}SignallingRequestGameInstanceList(e){if(!this._sigWs||!this._isSignallingConnected)return;const t=this._CreateSignallingPromise(this._signallingPromises.listGameInstances);return this.SignallingSend({message:"list-instances",game:e}),t}SignallingRequestRoomList(e,t,i){if(!this._sigWs||!this._isSignallingConnected)return;const s=this._CreateSignallingPromise(this._signallingPromises.listRooms);return this.SignallingSend({message:"list-rooms",game:e,instance:t,which:i}),s}DisconnectRoom(e){this._lastTimeDiffs.length=0,this._targetHostTimeDiff=0,this._hostTimeDiff=0,this.RemoveAllPeers("disconnect");for(const e of this._allRegisteredObjects)e.ClearAllNetInstances();e&&this.SignallingLeaveRoom()}_AddPeer(e){this._allPeers.push(e),this._peersById.set(e.GetId(),e),this.PostToRuntime("add-peer",{id:e.GetId(),alias:e.GetAlias()})}_RemovePeer(e){this.PostToRuntime("remove-peer",{id:e.GetId()}),this.IsHost()&&this.FreePeerNid(e.GetNid());const t=this._allPeers.indexOf(e);t>-1&&this._allPeers.splice(t,1),this._peersById.delete(e.GetId());for(const t of this._allPeers)t._OnPeerRemoved(e);this._hostPeer===e&&(this._hostPeer=null,this.RemoveAllPeers("host quit")),this._selfPeer===e&&(this._selfPeer=null,this._room="",this.RemoveAllPeers("disconnect"))}RemoveAllPeers(e){if(!st){for(st=!0;this._allPeers.length;)this._allPeers[0].Remove(e);st=!1}}GetPeerById(e){return this._peersById.get(e)||null}GetAliasFromId(e){const t=this._peersById.get(e);return t?t.GetAlias():""}GetPeerByNid(e){for(const t of this._allPeers)if(t.GetNid()===e)return t;return null}OnHostBroadcast(e){const t=e.fromId,i=e.tag,s=e.message,n=e.transmissionMode,o=e.contentMode,a=this.GetPeerById(t);if("s"===o&&s instanceof ArrayBuffer)this.HostBroadcast(n,s,We.FLAG_SCRIPT_DATA,a);else{const e={c:"m",cm:o,f:t,m:s};"e"===o&&(e.t=i),this.HostBroadcast(n,JSON.stringify(e),0,a)}}HostBroadcast(e,t,i=0,s=null){if(!this.IsHost())return;const n=this._allPeers.slice(0);for(const o of n)o&&o!==this._selfPeer&&o!==s&&o.Send(e,t,i)}_DoPings(){const e=performance.now();if(this.IsHost()){nt.push(...this._allPeers);for(const t of nt)t&&t!==this._selfPeer&&t.SendPing(e,!1);nt.length=0}else this._hostPeer&&this._hostPeer.SendPing(e,!1)}AddRegisteredObject(e){this._allRegisteredObjects.push(e),this._registeredObjectsByRoId.set(e.GetRoId(),e),this._registeredObjectsByNid.set(e.GetNid(),e)}GetRegisteredObjectsMap(){const e={};for(const[t,i]of this._registeredObjectsByNid.entries())e[i.GetSid()]={nid:t,nvs:i.GetNetValuesJson()};return e}MapObjectNids(e){this._registeredObjectsByNid.clear();for(const t of this._allRegisteredObjects)if(e.hasOwnProperty(t.GetSid().toString())){const i=e[t.GetSid().toString()];t._SetNid(i.nid),this._registeredObjectsByNid.set(i.nid,t),t.SetNetValuesFrom(i.nvs)}else console.warn("Could not map object SID '"+t.GetSid()+"' - host did not send NID for it"),t._SetNid(-1)}GetRegisteredObjectByNid(e){return this._registeredObjectsByNid.get(e)||null}Tick(e){if(!this.IsInRoom())return null;const t=e.dt,i=performance.now(),s=this.IsHost()?this._hostUpdateRateSec:this._peerUpdateRateSec;i-this._lastUpdateTime>=1e3/s-5&&(this.SendUpdate(i),this._lastUpdateTime=i);const n=this._stats;i-n.lastSecondTime>=1e3&&(n.outboundPerSec=n.outboundCount,n.outboundBandwidthPerSec=n.outboundBandwidthCount,n.outboundDecompressedBandwidthPerSec=n.outboundDecompressedBandwidthCount,n.inboundPerSec=n.inboundCount,n.inboundBandwidthPerSec=n.inboundBandwidthCount,n.inboundDecompressedBandwidthPerSec=n.inboundDecompressedBandwidthCount,n.outboundCount=0,n.outboundBandwidthCount=0,n.outboundDecompressedBandwidthCount=0,n.inboundCount=0,n.inboundBandwidthCount=0,n.inboundDecompressedBandwidthCount=0,n.lastSecondTime+=1e3,i-n.lastSecondTime>500&&(n.lastSecondTime=i),this.PostToRuntime("stats",{stats:{outboundPerSec:n.outboundPerSec,outboundBandwidthPerSec:n.outboundBandwidthPerSec,outboundDecompressedBandwidthPerSec:n.outboundDecompressedBandwidthPerSec,inboundPerSec:n.inboundPerSec,inboundBandwidthPerSec:n.inboundBandwidthPerSec,inboundDecompressedBandwidthPerSec:n.inboundDecompressedBandwidthPerSec}})),this.IsHost()||(this._hostTimeDiff<this._targetHostTimeDiff?(this._hostTimeDiff+=10*t,this._hostTimeDiff>this._targetHostTimeDiff&&(this._hostTimeDiff=this._targetHostTimeDiff)):this._hostTimeDiff>this._targetHostTimeDiff&&(this._hostTimeDiff-=10*t,this._hostTimeDiff<this._targetHostTimeDiff&&(this._hostTimeDiff=this._targetHostTimeDiff)),this._simDelay<this._targetSimDelay?(this._simDelay+=30*t,this._simDelay>this._targetSimDelay&&(this._simDelay=this._targetSimDelay)):this._simDelay>this._targetSimDelay&&(this._simDelay-=30*t,this._simDelay<this._targetSimDelay&&(this._simDelay=this._targetSimDelay)));const o=this.GetSimulationTime();for(const e of this._allPeers)e.Tick(o);for(const e of this._allRegisteredObjects)e.Tick();return{simulationTime:this.GetSimulationTime(),hostInputArrivalTime:this.GetHostInputArrivalTime(),clientDelay:this._clientDelay,peerData:this._GetPeerRuntimeData(),roData:this._GetRegisteredObjectRuntimeData(),isReadyForInput:this.IsReadyForInput()}}_GetPeerRuntimeData(){const e={};for(const t of this._allPeers){const i={};for(const e of this._allClientValues)i[e.GetTag()]=t.GetInterpClientState(e);e[t.GetId()]={nid:t.GetNid(),latency:t.GetLatency(),pdv:t.GetPdv(),clientState:i}}return e}_GetRegisteredObjectRuntimeData(){const e={};for(const t of this._allRegisteredObjects)e[t.GetRoId()]=t.GetRuntimeData();return e}async SendUpdate(e){this.IsHost()?(await this._SendHostUpdate(e),this._SendHostEvents(e)):await this._SendClientUpdate(e)}async _OnBeforeClientUpdate(){const e=await this.PostToRuntimeAsync("before-client-update");for(const t of e.clientStateUpdates)this.SetClientState(t.tag,t.value)}async _SendClientUpdate(e){if(this.IsReadyForInput()&&await this._OnBeforeClientUpdate(),!this._selfPeer||!this._receivedClientValues)return;const t=this._dataView;let i=0;const s=this._allClientValues,n=this._selfPeer.GetLocalClientState(),o=e-this._selfPeer.GetLastStateChange(),a=e-this._selfPeer.GetLastStateTransmit();let r=!1;if(r=o<100||(o<1e3?a>=95:a>=495),r){t.setFloat64(i,e+this._hostTimeDiff),i+=8,t.setUint8(i,s.length),i+=1;for(let e=0,o=s.length;e<o;++e){const o=s[e];let a=0;e<n.length&&(a=o.Clamp(n[e])),i=o.Write(t,i,a)}this._selfPeer._SetLastStateTransmit(e),this._hostPeer.Send("u",this._dataBuffer.slice(0,i))}}async _SendHostUpdate(e){const t=this._dataView;let i=0,s=0;const n=await this.PostToRuntimeAsync("get-object-info",{ros:this._allRegisteredObjects.map(e=>e.GetRuntimeInfoRequest())});for(const t of this._allRegisteredObjects){const i=t.GetRoId();if(!n.hasOwnProperty(i))continue;const o=n[i];t.UpdateData(o,e),t.GetNumberToTransmit()>0&&s++}if(0!==s){t.setFloat64(i,e),i+=8,t.setUint16(i,s),i+=2;for(const s of this._allRegisteredObjects)s.GetNumberToTransmit()>0&&(i=s.WriteData(t,i,e));this.HostBroadcast("u",this._dataBuffer.slice(0,i),0)}}_SendHostEvents(e){const t=this._dataView;let i=0,s=0;for(const e of this._allRegisteredObjects)e.GetDeadNids().length&&s++;if(0!==s){t.setFloat64(i,e),i+=8,t.setUint16(i,s),i+=2;for(const e of this._allRegisteredObjects){const s=e.GetDeadNids();if(s.length){t.setUint16(i,e.GetNid()),i+=2,t.setUint16(i,s.length),i+=2;for(const e of s)t.setUint16(i,e),i+=2;s.length=0}}this.HostBroadcast("r",this._dataBuffer.slice(0,i),We.FLAG_HOST_UPDATE_TYPE)}}AddHostTime(e,t,i,s){if(this.IsHost())return;this._targetSimDelay=s+this._clientDelay;var n=e+i-t;0===this._lastTimeDiffs.length&&(this._hostTimeDiff=n,this._simDelay=this._targetSimDelay),this._lastTimeDiffs.push(n),this._lastTimeDiffs.length>30&&this._lastTimeDiffs.shift(),nt.push(...this._lastTimeDiffs),nt.sort((e,t)=>e-t);let o=0,a=nt.length;nt.length>=4&&nt.length<=6?(++o,--a):nt.length>6&&nt.length<=19?(o+=2,a-=2):nt.length>19&&(o+=5,a-=5);let r=0;for(let e=o;e<a;++e)r+=nt[e];this._targetHostTimeDiff=r/(a-o),nt.length=0}GetSimulationTime(){return this.IsHost()?performance.now()-this._clientDelay:performance.now()+this._hostTimeDiff-this._simDelay}GetHostTime(){return this.IsHost()?performance.now():performance.now()+this._hostTimeDiff}GetHostInputArrivalTime(){return this.IsHost()?performance.now():performance.now()+this._hostTimeDiff+this._simDelay}SetClientState(e,t){if(this.IsHost()||!this._selfPeer||!this._receivedClientValues)return;const i=this._clientValuesByTag.get(e);if(!i)return;const s=i.GetIndex(),n=this._selfPeer.GetLocalClientState();n.length<s+1&&(n.length=s+1),n[s]!==t&&(n[s]=t,this._selfPeer._SetLastStateChange(performance.now()))}AddClientInputValue(e,t,i){const s=new Be(this._allClientValues.length,i,t,e,null);this._clientValuesByTag.set(e,s),this._allClientValues.push(s)}GetClientValues(){return this._allClientValues}GetClientValuesJson(){const e=[];for(const t of this._allClientValues)e.push({tag:t.GetTag(),precision:t.GetPrecision(),interp:t.GetInterp()});return e}MapClientValues(e){this._clientValuesByTag.clear(),this._allClientValues.length=0;for(let t=0,i=e.length;t<i;++t){const i=e[t],s=new Be(t,i.interp,i.precision,i.tag,null);this._clientValuesByTag.set(s.GetTag(),s),this._allClientValues.push(s)}this._receivedClientValues=!0}RemoveObjectId(e){for(const t of this._allRegisteredObjects)t.RemoveObjectId(e)}peers(){return this._allPeers}GetPeerCount(){return this.IsInRoom()?this._allPeers.length:0}GetPeerAt(e){return e=Math.floor(e),!this.IsInRoom()||e<0||e>=this._allPeers.length?null:this._allPeers[e]}IsReadyForInput(){return!(!this.IsInRoom()||!this.IsHost()&&0===this._targetHostTimeDiff)}SetBandwidthSettings(e,t){this.IsInRoom()||(this._hostUpdateRateSec=e,this._peerUpdateRateSec=e,this._clientDelay=t)}_OnPeerOpen(e){this.PostToRuntime("peer-open",{id:e.GetId(),alias:e.GetAlias()})}OnPeerSendMessage(e){const t=e.id,i=e.tag,s=e.message,n=e.transmissionMode,o=e.contentMode,a=this.GetPeerById(t);if(a)if(s instanceof ArrayBuffer)a.Send(n,s,"e"===o?We.FLAG_EVENT_DATA:We.FLAG_SCRIPT_DATA);else{const e={c:"m",cm:o,m:s};"e"===o&&(e.t=i),a.Send(n,JSON.stringify(e))}}_GetTransferDetailsForPeerId(e){let t,i;return this.IsHost()?t=this.GetPeerById(e):(t=this.GetPeerById(e),t&&!t.IsHost()&&(t=this.GetHostPeer(),i=e)),{peer:t,toPeerId:i}}OnPeerTransferBinary(e){const t=e.id,i=e.transferId,s=e.blob,n=e.dataType,o=e.mimeType,a=e.fileName,r=e.tag,d=e.contentMode,{peer:l,toPeerId:h}=this._GetTransferDetailsForPeerId(t);l&&l.TransferBinary(i,h,s,n,o,a,r,d)}_OnPeerBinaryTransferStart(e,t,i,s,n,o,a){this.PostToRuntime("peer-binary-transfer-start",{id:e.GetId(),alias:e.GetAlias(),transferId:t,mimeType:i,fileName:s,totalSize:n,contentMode:o,tag:a})}_GetRelayPeerForTransferId(e){for(const t of this._allPeers)if(t._HasRelayTransferId(e))return t;return null}OnCancelBinaryTransfer(e){const t=e.id,i=e.transferId,{peer:s,toPeerId:n}=this._GetTransferDetailsForPeerId(t);s&&s.CancelBinaryTransfer(i,n)}_OnPeerBinaryTransferProgress(e,t,i,s,n){this.PostToRuntime("peer-binary-transfer-progress",{id:e.GetId(),alias:e.GetAlias(),direction:t,contentMode:i,tag:s,progress:n})}_OnPeerBinaryTransferCancelled(e,t,i,s,n){this.PostToRuntime("peer-binary-transfer-cancelled",{id:e.GetId(),alias:e.GetAlias(),direction:t,transferId:i,contentMode:s,tag:n})}_OnPeerBinaryTransferComplete(e,t,i,s,n,o,a,r,d){this.PostToRuntime("peer-binary-transfer-complete",{id:e.GetId(),alias:e.GetAlias(),direction:t,transferId:i,dataType:s,mimeType:n,fileName:o,contentMode:a,tag:r,blob:d})}_OnPeerClose(e,t){this.PostToRuntime("peer-close",{id:e.GetId(),alias:e.GetAlias(),reason:t||"unknown"})}_OnPeerError(e,t){console.error(`[Multiplayer] Peer '${e.GetAlias()}' (${e.GetId()}) error: `,t)}_OnPeerMessage(e,t,i){const s=t.f||e.GetId();this.PostToRuntime("peer-message",{tag:t.t,fromId:s,fromAlias:this.GetAliasFromId(s),transmissionMode:i,content:t.m,contentMode:t.cm||"e"})}_OnPeerBinaryMessage(e,t,i,s){const n=e.GetId();this.PostToRuntime("peer-message",{fromId:n,fromAlias:this.GetAliasFromId(n),transmissionMode:i,content:t,contentMode:s})}_OnInstanceDestroyed(e,t,i){this.PostToRuntime("instance-destroyed",{roId:e.GetRoId(),nid:t,timestamp:i})}OnKickPeer(e){if(!this.IsHost())return;const t=e.id,i=e.reason,s=this.GetPeerById(t);s&&s.Remove(i,!0)}OnWasKicked(){this.PostToRuntime("peer-kicked")}StatIncOutboundCount(){this._stats.outboundCount++}StatAddOutboundBandwidthCount(e){this._stats.outboundBandwidthCount+=Qe(e)}StatAddOutboundDecompressedBandwidthCount(e){this._stats.outboundDecompressedBandwidthCount+=Qe(e)}StatIncInboundCount(){this._stats.inboundCount++}StatAddInboundBandwidthCount(e){this._stats.inboundBandwidthCount+=Qe(e)}StatAddInboundDecompressedBandwidthCount(e){this._stats.inboundDecompressedBandwidthCount+=Qe(e)}SetClientDelay(e){this._clientDelay=e}GetClientDelay(){return this._clientDelay}SetPeerUpdateRateSec(e){this._peerUpdateRateSec=e}GetPeerUpdateRateSec(){return this._peerUpdateRateSec}OnSyncObject(e){const t=e.x,i=e.y,s=e.angle,n=e.precision,o=e.bandwidth;for(const a of e.objectClasses){const e=new self.C3RegisteredObject(this,a.roId,a.sid,o);t&&e.AddValue(tt,n,"x"),i&&e.AddValue(tt,n,"y"),s&&e.AddValue(it,n,"a")}}Alert(e){alert(e.message)}OnSyncInstVar(e){const t=e.precision,i=e.interp,s=e.cvt;for(const n of e.syncData)this._registeredObjectsByRoId.get(n.roId).AddValue(i,t,"iv",n.varIndex,s)}OnAssociateObject(e){const t=e.roId,i=e.peerId,s=e.instUid,n=this._registeredObjectsByRoId.get(t),o=this._peersById.get(i);n&&o&&this.IsHost()&&n.OverrideNid(s,o.GetNid())}OnRemoveNetInsts(e){for(const[t,i]of Object.entries(e)){const e=this._registeredObjectsByRoId.get(parseInt(t,10));if(e)for(const t of i)e.RemoveObjectNid(t)}}OnRemoveObjectNid(e){const t=e.roId,i=e.nid,s=this._registeredObjectsByRoId.get(t);s&&s.RemoveObjectNid(i)}GetLocalSupportedCompressionFormats(){return et}};self.RuntimeInterface.AddDOMHandlerClass(ot)}{const at="localstorage",rt=class extends self.DOMHandler{constructor(e){super(e,at),this.AddRuntimeMessageHandlers([["init",()=>this._Init()],["request-persistent",()=>this._OnRequestPersistent()]])}async _Init(){let e=!1;try{e=await navigator.storage.persisted()}catch(t){e=!1,console.warn("[Construct] Error checking storage persisted state: ",t)}return{isPersistent:e}}async _OnRequestPersistent(){try{return{isOk:!0,isPersistent:await navigator.storage.persist()}}catch(e){return console.error("[Construct] Error requesting persistent storage: ",e),{isOk:!1}}}};self.RuntimeInterface.AddDOMHandlerClass(rt)}if(window.C3_IsSupported){const dt=!1;window.c3_runtimeInterface=new self.RuntimeInterface({useWorker:dt,workerMainUrl:"workermain.js",runtimeScriptList:["scripts/c3main.js"],scriptFolder:"scripts/",exportType:"html5"})}